<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Svapo Manager Cloud</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☁️</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- React & Babel -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        body { overscroll-behavior-y: none; }
        
        /* Dark mode transitions */
        body, div, p, h1, h2, h3, button { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 selection:bg-indigo-100 dark:selection:bg-indigo-900/50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Check, X, ArrowLeft, Share2, DollarSign, Users, 
            ShoppingBag, Wallet, Link as LinkIcon, Wind, 
            LogOut, TrendingUp, History, User, ShoppingCart, ExternalLink, CheckSquare, Square, Lock, Beaker, ShoppingBasket, Send, List, FileSpreadsheet, Bell, BellRing, KeyRound, PiggyBank, ArrowUpRight, CloudLightning, MessageCircle, AlertCircle, RefreshCcw, MoreHorizontal, Moon, Sun, Monitor, AlertTriangle, Info
        } from 'lucide-react';
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs, writeBatch, arrayUnion } from 'firebase/firestore';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';

        // --- FIREBASE CONFIGURATION ---
        // Inserisci qui le tue chiavi se non usi l'ambiente pre-configurato
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDwpBj5NXy4iZkOKXMEMd_CY1_1cMMRx-s",
              authDomain: "svapomenager.firebaseapp.com",
              projectId: "svapomenager",
              storageBucket: "svapomenager.firebasestorage.app",
              messagingSenderId: "512019732894",
              appId: "1:512019732894:web:d4fb58561b3fbea1ff1e8f",
              measurementId: "G-VDCNTT6WHM"
        };

        let app, db, auth;
        const isConfigured = firebaseConfig.apiKey !== "TUO_API_KEY";
        
        if (isConfigured) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        }
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'svapo-manager-default';

        // --- HOOK PER IL TEMA (DARK MODE) ---
        const useTheme = () => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'auto');

            useEffect(() => {
                const root = window.document.documentElement;
                const isDark = theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                if (isDark) {
                    root.classList.add('dark');
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#020617');
                } else {
                    root.classList.remove('dark');
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff');
                }
                localStorage.setItem('theme', theme);
            }, [theme]);

            return [theme, setTheme];
        };

        // --- COMPONENTE MODALE DI CONFERMA (Sostituisce window.confirm) ---
        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Conferma", isDanger = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden border dark:border-slate-700 transform scale-100 transition-all animate-in zoom-in-95 duration-200">
                        <div className="p-6">
                            <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                                {isDanger && <AlertTriangle className="text-red-500" />} {title}
                            </h3>
                            <p className="text-slate-500 dark:text-slate-400 text-sm leading-relaxed">{message}</p>
                        </div>
                        <div className="bg-slate-50 dark:bg-slate-800 p-4 flex gap-3 justify-end border-t dark:border-slate-700">
                            <button onClick={onCancel} className="px-5 py-2.5 rounded-xl text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition">Annulla</button>
                            <button 
                                onClick={onConfirm} 
                                className={`px-5 py-2.5 rounded-xl text-white font-bold transition shadow-lg ${isDanger ? 'bg-red-500 hover:bg-red-600 shadow-red-500/30' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/30'}`}
                            >
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE CARD ORDINE ---
        const OrderCard = ({ order, currentUser, onClick, onDelete, onReset }) => {
            const myCount = (order.items || []).filter(i => i.person === currentUser).length;

            return (
                <div 
                    onClick={() => onClick(order.id)}
                    className="bg-white dark:bg-slate-900 border dark:border-slate-700 p-4 rounded-2xl shadow-sm mb-3 flex justify-between items-center cursor-pointer active:scale-[0.99] transition-transform"
                >
                     <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 rounded-2xl flex items-center justify-center flex-shrink-0">
                            <ShoppingBag size={22} />
                        </div>
                        <div className="min-w-0">
                            <h3 className="font-bold text-slate-900 dark:text-white leading-tight truncate">{order.title}</h3>
                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">I tuoi articoli: <span className="font-bold">{myCount}</span></p>
                        </div>
                    </div>
                    
                    <div className="flex items-center gap-2 flex-shrink-0 ml-2">
                        {/* Pulsante Reset (Rotella) */}
                        <button 
                            onClick={(e) => { e.stopPropagation(); onReset(order.id); }}
                            className="w-10 h-10 flex items-center justify-center bg-orange-50 dark:bg-orange-900/20 text-orange-500 rounded-xl hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-colors border border-orange-100 dark:border-orange-900/30"
                            title="Reset / Rifai Ordine"
                        >
                            <RefreshCcw size={18} />
                        </button>

                        {/* Pulsante Elimina (Cestino) */}
                        <button 
                            onClick={(e) => { e.stopPropagation(); onDelete(order.id); }}
                            className="w-10 h-10 flex items-center justify-center bg-red-50 dark:bg-red-900/20 text-red-500 rounded-xl hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors border border-red-100 dark:border-red-900/30"
                            title="Elimina Ordine"
                        >
                            <Trash2 size={18} />
                        </button>
                    </div>
                </div>
            );
        }

        const OrderManager = () => {
            // --- STATE ---
            const [users, setUsers] = useState(['Gestore']);
            const [orders, setOrders] = useState([]);
            const [paymentRequests, setPaymentRequests] = useState({});
            const [currentUser, setCurrentUser] = useState(null);
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [connectionError, setConnectionError] = useState(null); 
            
            // Login State
            const [isLoggingInAsManager, setIsLoggingInAsManager] = useState(false);
            const [managerPassword, setManagerPassword] = useState('');
            const [loginError, setLoginError] = useState('');
            
            const [view, setView] = useState('dashboard'); 
            const [activeOrderId, setActiveOrderId] = useState(null);
            const [newUserName, setNewUserName] = useState('');
            const [isAddingUser, setIsAddingUser] = useState(false);

            // Modal State
            const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', message: '', onConfirm: null, isDanger: false, confirmText: 'Conferma' });

            // Theme Hook
            const [theme, setTheme] = useTheme();

            // --- HELPER PER MODALE ---
            const showConfirm = (title, message, onConfirm, isDanger = false, confirmText = "Conferma") => {
                setModalConfig({ isOpen: true, title, message, onConfirm: () => { onConfirm(); setModalConfig(prev => ({...prev, isOpen: false})); }, onCancel: () => setModalConfig(prev => ({...prev, isOpen: false})), isDanger, confirmText });
            };

            const showInfo = (title, message) => {
                setModalConfig({ isOpen: true, title, message, onConfirm: () => setModalConfig(prev => ({...prev, isOpen: false})), onCancel: () => setModalConfig(prev => ({...prev, isOpen: false})), isDanger: false, confirmText: 'OK' });
            };

            // --- FIREBASE SYNC ---
            useEffect(() => {
                if (!isConfigured) return;

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth Error:", err);
                        setConnectionError(err.message);
                    }
                };
                
                const timer = setTimeout(() => {
                    if (!auth.currentUser) {
                        setConnectionError("Timeout: La connessione sta impiegando troppo tempo.");
                    }
                }, 10000);

                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        clearTimeout(timer);
                        setFirebaseUser(user);
                    }
                });
                return () => {
                    unsubscribe();
                    clearTimeout(timer);
                };
            }, []);

            useEffect(() => {
                if (!firebaseUser) return;
                const qOrders = collection(db, 'artifacts', APP_ID, 'public', 'data', 'orders');
                const unsubOrders = onSnapshot(qOrders, (snapshot) => {
                    const loadedOrders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    loadedOrders.sort((a, b) => b.id - a.id);
                    setOrders(loadedOrders);
                }, (err) => {
                    console.error("Orders Listener Error:", err);
                    setConnectionError("Errore lettura ordini: " + err.message);
                });

                const docSettings = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global');
                const unsubSettings = onSnapshot(docSettings, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        if (data.users) setUsers(data.users);
                        if (data.paymentRequests) setPaymentRequests(data.paymentRequests);
                    } else {
                        setDoc(docSettings, { users: ['Gestore'], paymentRequests: {} });
                    }
                }, (err) => {
                    console.error("Settings Listener Error:", err);
                });
                return () => { unsubOrders(); unsubSettings(); };
            }, [firebaseUser]);

            // --- CALCULATIONS ---
            const isManager = currentUser === 'Gestore';

            const userStats = useMemo(() => {
                if (!currentUser || isManager) return null;
                const myItems = orders.flatMap(o => (o.items || []).map(i => ({...i, date: o.date, orderTitle: o.title})))
                                    .filter(i => i.person === currentUser);
                const totalItems = myItems.length;
                const pendingItems = myItems.filter(i => !i.paid).length;
                return { totalItems, pendingItems, myItems };
            }, [orders, currentUser, isManager]);

            const managerStats = useMemo(() => {
                if (!isManager) return null;
                let totalCredits = 0;
                let totalCollected = 0;
                orders.forEach(order => {
                    (order.items || []).forEach(item => {
                        const price = parseFloat(item.price) || 0;
                        if (item.paid) totalCollected += price;
                        else totalCredits += price;
                    });
                });
                return { totalCredits, totalCollected };
            }, [orders, isManager]);

            const shoppingList = useMemo(() => {
                const allItems = orders.flatMap(order => 
                    (order.items || []).map(item => ({ ...item, orderId: order.id, orderTitle: order.title }))
                );
                const grouped = {};
                allItems.forEach(item => {
                    const key = item.link ? item.link.trim() : `nolink-${item.id}`;
                    if (!grouped[key]) grouped[key] = { link: item.link, count: 0, items: [], allBought: true };
                    grouped[key].count += 1;
                    grouped[key].items.push(item);
                    if (!item.bought) grouped[key].allBought = false;
                });
                return Object.values(grouped).sort((a, b) => {
                    if (a.allBought === b.allBought) return 0;
                    return a.allBought ? 1 : -1; 
                });
            }, [orders]);

            const logisticsData = useMemo(() => {
                const data = {};
                users.forEach(u => {
                    if (u === 'Gestore') return;
                    data[u] = { items: [], totalDebt: 0, totalPaid: 0 };
                });
                orders.forEach(order => {
                    (order.items || []).forEach(item => {
                        if (data[item.person]) {
                            data[item.person].items.push({ ...item, orderDate: order.date, orderTitle: order.title, orderId: order.id });
                            const price = parseFloat(item.price) || 0;
                            if (item.paid) data[item.person].totalPaid += price;
                            else data[item.person].totalDebt += price;
                        }
                    });
                });
                return data;
            }, [orders, users]);

            // --- ACTIONS ---
            const initiateLogin = (user) => {
                if (user === 'Gestore') {
                    setIsLoggingInAsManager(true); setManagerPassword(''); setLoginError('');
                } else {
                    setCurrentUser(user); setView('dashboard');
                }
            };

            const submitManagerLogin = (e) => {
                e.preventDefault();
                if (managerPassword === '1234') {
                    setCurrentUser('Gestore'); setView('dashboard'); setIsLoggingInAsManager(false);
                } else {
                    setLoginError('Password errata'); setManagerPassword('');
                }
            };

            const addUser = async (e) => {
                e.preventDefault();
                const name = newUserName.trim();
                if(name && !users.includes(name)) {
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { users: arrayUnion(name) });
                    setNewUserName(''); setIsAddingUser(false);
                }
            };

            // ELIMINAZIONE UTENTE CON MODALE
            const deleteUser = (userToDelete) => {
                if (userToDelete === 'Gestore') return showInfo("Impossibile", "Non puoi eliminare il Gestore.");
                
                showConfirm(
                    "Elimina Utente", 
                    `Sei sicuro di voler eliminare definitivamente l'utente "${userToDelete}"?`, 
                    async () => {
                        const newUsersList = users.filter(u => u !== userToDelete);
                        try {
                            await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { 
                                users: newUsersList 
                            });
                        } catch (error) {
                            showInfo("Errore", error.message);
                        }
                    },
                    true, // isDanger
                    "Elimina"
                );
            };

            const createOrder = async () => {
                const dateStr = new Date().toLocaleDateString('it-IT');
                const newId = Date.now().toString();
                setActiveOrderId(newId);
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', newId), {
                    id: newId, title: `Ordine del ${dateStr}`, date: dateStr, items: [], status: 'active' 
                });
            };

            const updateOrderItems = async (orderId, newItems) => {
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', orderId.toString()), { items: newItems });
            };

            const addItemToOrder = async (orderId, item) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, [...(order.items || []), { ...item, id: Date.now(), paid: false, bought: false }]);
            };

            const removeItemFromOrder = async (orderId, itemId) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.filter(i => i.id !== itemId));
            };

            const updateItemPrice = async (orderId, itemId, newPrice) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.map(item => item.id === itemId ? { ...item, price: parseFloat(newPrice) || 0 } : item));
            };

            const togglePaidStatus = async (orderId, itemId) => {
                if (!isManager) return; 
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.map(item => item.id === itemId ? { ...item, paid: !item.paid } : item));
            };

            const toggleBoughtStatus = async (orderId, itemId) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.map(item => item.id === itemId ? { ...item, bought: !item.bought } : item));
            };

            // ELIMINAZIONE ORDINE CON MODALE
            const deleteOrder = (orderId) => {
                showConfirm(
                    "Elimina Ordine", 
                    "Vuoi eliminare definitivamente questo ordine? L'azione è irreversibile.", 
                    async () => {
                        await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', orderId.toString()));
                        setActiveOrderId(null);
                    },
                    true,
                    "Elimina"
                );
            };

            // RESET ORDINE CON MODALE
            const resetOrder = (orderId) => {
                showConfirm(
                    "Reset Ordine",
                    "Vuoi svuotare tutti gli articoli di questo ordine per ricominciare da zero?",
                    async () => {
                        await updateOrderItems(orderId, []);
                    },
                    false,
                    "Svuota Ordine"
                );
            };

            // RESET TOTALE APP CON MODALE (SOLO MANAGER)
            const factoryReset = () => {
                if (!isManager) return;
                
                showConfirm(
                    "RESET TOTALE APPLICAZIONE",
                    "ATTENZIONE: Stai per cancellare TUTTI i dati, tutti gli ordini e tutti gli utenti. Questa azione è distruttiva e irreversibile.",
                    async () => {
                        try {
                            const ordersSnapshot = await getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'orders'));
                            const batch = writeBatch(db);
                            ordersSnapshot.forEach((doc) => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();

                            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { users: ['Gestore'], paymentRequests: {} });
                            
                            showInfo("Reset Completato", "L'applicazione è tornata allo stato iniziale.");
                            setTimeout(() => window.location.reload(), 2000);
                        } catch (e) {
                            showInfo("Errore", "Errore durante il reset: " + e.message);
                        }
                    },
                    true,
                    "DISTRUGGI TUTTO"
                );
            };

            const togglePaymentRequest = async (user) => {
                const newRequests = { ...paymentRequests, [user]: !paymentRequests[user] };
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { paymentRequests: newRequests });
            };

            const downloadExcel = () => {
                const data = [];
                orders.forEach(o => {
                    (o.items || []).forEach(i => {
                        data.push({
                            "ID Ordine": o.id,
                            "Data": o.date,
                            "Titolo Ordine": o.title,
                            "Utente": i.person,
                            "Articolo": i.link ? i.link : i.otherItems,
                            "Specifiche": `${i.liquidMl || '-'}ml | ${i.nicotineMl || '-'}nic | ${i.vapeType || '-'}`,
                            "Prezzo": i.price || 0,
                            "Pagato": i.paid ? "SI" : "NO",
                            "Acquistato": i.bought ? "SI" : "NO"
                        });
                    });
                });

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Riepilogo Svapo");
                XLSX.writeFile(wb, "svapo_manager_report.xlsx");
            };

            // --- UI ---
            if (!isConfigured) return <div className="p-10 text-center">Configurazione mancante</div>;
            if (connectionError) return <div className="p-10 text-center text-red-500">Errore: {connectionError}</div>;
            if (!firebaseUser) return <div className="min-h-screen flex items-center justify-center text-slate-400 bg-slate-50 dark:bg-slate-950 animate-pulse">Connessione Cloud...</div>;

            if (!currentUser) return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative">
                    <ConfirmDialog {...modalConfig} />
                    <div className="bg-white dark:bg-slate-800 w-full max-w-md rounded-3xl p-8 shadow-2xl animate-in">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 dark:bg-blue-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 dark:text-blue-400"><CloudLightning size={32} /></div>
                            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Svapo Manager</h1>
                            <p className="text-slate-500 dark:text-slate-400 text-sm">Cloud Edition</p>
                        </div>
                        {isLoggingInAsManager ? (
                            <div className="animate-in">
                                <button onClick={() => setIsLoggingInAsManager(false)} className="flex items-center gap-1 text-slate-400 mb-4 text-sm font-bold"><ArrowLeft size={16} /> Indietro</button>
                                <form onSubmit={submitManagerLogin} className="space-y-4">
                                    <input autoFocus type="password" placeholder="Password (1234)" className="w-full p-4 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-xl text-center text-xl tracking-widest outline-none focus:ring-2 focus:ring-blue-500" value={managerPassword} onChange={e => setManagerPassword(e.target.value)} />
                                    {loginError && <p className="text-red-500 text-sm text-center font-bold">{loginError}</p>}
                                    <button type="submit" className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">Accedi</button>
                                </form>
                            </div>
                        ) : (
                            <>
                                <div className="grid grid-cols-2 gap-3 mb-6">
                                    {users.map(u => (
                                        <div key={u} className="relative group">
                                            {/* Pulsante Principale - Accesso */}
                                            <button onClick={() => initiateLogin(u)} className="w-full relative p-4 rounded-xl border-2 border-slate-100 dark:border-slate-700 hover:border-blue-500 dark:hover:border-blue-500 transition-all font-medium text-slate-700 dark:text-slate-200 flex flex-col items-center gap-2">
                                                <div className="w-10 h-10 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center font-bold">{u.charAt(0)}</div>
                                                {u}
                                                {u === 'Gestore' && <Lock size={12} className="absolute top-2 right-2 text-slate-400" />}
                                            </button>
                                            
                                            {/* Pulsante Eliminazione - Sempre visibile e sopraelevato */}
                                            {u !== 'Gestore' && (
                                                <button 
                                                    onClick={(e) => { 
                                                        e.stopPropagation(); 
                                                        deleteUser(u); 
                                                    }}
                                                    className="absolute -top-2 -right-2 w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-full shadow-lg border-2 border-white dark:border-slate-800 z-50 hover:bg-red-600 transition-transform active:scale-90"
                                                    aria-label="Elimina utente"
                                                >
                                                    <X size={16} />
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                    <button onClick={() => setIsAddingUser(true)} className="p-4 rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 text-slate-400 flex flex-col items-center gap-2 justify-center"><Plus size={24} /> <span className="text-sm">Nuovo</span></button>
                                </div>
                                {isAddingUser && (
                                    <form onSubmit={addUser} className="flex gap-2 animate-in"><input autoFocus type="text" placeholder="Nome..." className="flex-1 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-xl px-4 py-3 outline-none" value={newUserName} onChange={e => setNewUserName(e.target.value)} /><button type="submit" className="bg-blue-600 text-white p-3 rounded-xl font-bold">Ok</button></form>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 font-sans pb-24 md:pb-0 relative">
                    <div className="max-w-4xl mx-auto min-h-screen bg-white dark:bg-slate-900 shadow-xl flex flex-col border-x border-slate-100 dark:border-slate-800 relative">
                        <header className="p-4 md:p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between sticky top-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur z-20">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg">{currentUser.charAt(0)}</div>
                                <div><p className="text-xs text-slate-400 uppercase font-bold">Benvenuto</p><h1 className="text-lg font-bold text-slate-900 dark:text-white leading-none">{currentUser}</h1></div>
                            </div>
                            <div className="flex items-center gap-2">
                                {!activeOrderId && (
                                    <div className="hidden md:flex items-center gap-1 bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                                        <NavButtonDesktop icon={User} label="Profilo" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                                        {!isManager && <NavButtonDesktop icon={ShoppingBag} label="Ordini" active={view === 'orders'} onClick={() => setView('orders')} />}
                                        {isManager && <NavButtonDesktop icon={ShoppingCart} label="Spesa" active={view === 'shopping'} onClick={() => setView('shopping')} />}
                                        {isManager && <NavButtonDesktop icon={FileSpreadsheet} label="Logistica" active={view === 'logistics'} onClick={() => setView('logistics')} />}
                                    </div>
                                )}
                                <button onClick={() => setCurrentUser(null)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:text-red-500"><LogOut size={18} /></button>
                            </div>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4">
                            {view === 'dashboard' && (
                                <div className="space-y-6 animate-in">
                                    {/* SEZIONE TEMA */}
                                    <div className="bg-white dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-2xl flex justify-between items-center shadow-sm">
                                        <div className="flex items-center gap-3">
                                            <div className="p-2 bg-slate-100 dark:bg-slate-700 rounded-full">{theme === 'dark' ? <Moon size={20}/> : (theme === 'light' ? <Sun size={20}/> : <Monitor size={20}/>)}</div>
                                            <div><h3 className="font-bold">Tema</h3><p className="text-xs text-slate-400">Attuale: {theme === 'auto' ? 'Automatico' : (theme === 'dark' ? 'Scuro' : 'Chiaro')}</p></div>
                                        </div>
                                        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                            {['light', 'auto', 'dark'].map(t => (
                                                <button key={t} onClick={() => setTheme(t)} className={`p-2 rounded-md ${theme === t ? 'bg-white dark:bg-slate-600 shadow-sm text-blue-600 dark:text-blue-400' : 'text-slate-400'}`}>
                                                    {t === 'light' && <Sun size={16} />}
                                                    {t === 'auto' && <Monitor size={16} />}
                                                    {t === 'dark' && <Moon size={16} />}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {isManager ? (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-5 rounded-2xl text-white shadow-lg">
                                                    <div className="flex justify-between mb-4"><ArrowUpRight className="opacity-80" /><span className="text-xs bg-white/20 px-2 py-1 rounded-lg">Crediti</span></div>
                                                    <p className="text-sm opacity-80">Devono darti</p><p className="text-3xl font-bold">€{managerStats.totalCredits.toFixed(2)}</p>
                                                </div>
                                                <div className="bg-white dark:bg-slate-800 border dark:border-slate-700 p-5 rounded-2xl">
                                                    <div className="flex justify-between mb-4 text-slate-400"><PiggyBank /><span className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-lg text-slate-500 dark:text-slate-300 font-bold">Totale</span></div>
                                                    <p className="text-sm text-slate-400">Incassati</p><p className="text-3xl font-bold text-slate-800 dark:text-white">€{managerStats.totalCollected.toFixed(2)}</p>
                                                </div>
                                            </div>
                                            <div className="bg-slate-100 dark:bg-slate-800 rounded-2xl p-6 text-center">
                                                <p className="text-slate-500 dark:text-slate-400 text-sm mb-4">Gestisci gli ordini e i pagamenti dalla sezione Logistica.</p>
                                                <button onClick={() => setView('logistics')} className="bg-slate-800 dark:bg-slate-700 text-white px-6 py-3 rounded-xl font-bold text-sm hover:bg-slate-700">Vai alla Logistica</button>
                                            </div>

                                            {/* RESET APP BUTTON */}
                                            <div className="border-t dark:border-slate-800 pt-6">
                                                <button onClick={factoryReset} className="w-full flex items-center justify-center gap-2 text-red-500 bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 p-4 rounded-xl font-bold hover:bg-red-100 transition-colors">
                                                    <AlertTriangle size={20} /> RESET APPLICAZIONE
                                                </button>
                                                <p className="text-center text-[10px] text-red-300 mt-2">Cancella tutti i dati e gli ordini.</p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-gradient-to-br from-indigo-500 to-blue-600 p-5 rounded-2xl text-white shadow-lg">
                                                    <div className="flex justify-between mb-4"><List className="opacity-80" /><span className="text-xs bg-white/20 px-2 py-1 rounded-lg">Totale</span></div>
                                                    <p className="text-sm opacity-80">Articoli</p><p className="text-3xl font-bold">{userStats.totalItems}</p>
                                                </div>
                                                <div className={`p-5 rounded-2xl border-2 ${userStats.pendingItems > 0 ? 'bg-orange-50 dark:bg-orange-900/10 border-orange-100 dark:border-orange-900/30 text-orange-700 dark:text-orange-400' : 'bg-emerald-50 dark:bg-emerald-900/10 border-emerald-100 dark:border-emerald-900/30 text-emerald-700 dark:text-emerald-400'}`}>
                                                    <div className="flex justify-between mb-4"><CheckSquare /><span className="text-xs font-bold uppercase px-2 py-1 rounded-lg bg-white/50 dark:bg-black/20">Stato</span></div>
                                                    <p className="text-sm opacity-80">Da Saldare</p><p className="text-3xl font-bold">{userStats.pendingItems}</p>
                                                </div>
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2"><History size={18} className="text-indigo-500"/> I tuoi acquisti</h3>
                                                <div className="space-y-3">
                                                    {userStats.myItems.length === 0 && <p className="text-slate-400 text-sm italic">Non hai ancora comprato nulla.</p>}
                                                    {userStats.myItems.slice().reverse().map((item, idx) => ( 
                                                        <div key={idx} className="bg-white dark:bg-slate-800 border dark:border-slate-700 p-3 rounded-xl flex justify-between items-center shadow-sm">
                                                            <div className="overflow-hidden mr-2">
                                                                <p className="font-bold text-slate-800 dark:text-white truncate">{item.link || 'Oggetto senza link'}</p>
                                                                <p className="text-xs text-slate-500 dark:text-slate-400">{item.date}</p>
                                                            </div>
                                                            <div className="text-right flex-shrink-0">
                                                                <p className={`text-[10px] font-bold uppercase tracking-wider ${item.paid ? 'text-emerald-500' : 'text-orange-400'}`}>{item.paid ? 'Saldato' : 'Da Saldare'}</p>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {view === 'orders' && !isManager && (
                                <div className="space-y-4 animate-in">
                                    {!activeOrderId ? (
                                        <>
                                            <div className="flex justify-between items-center mb-2">
                                                <h2 className="text-xl font-bold text-slate-800 dark:text-white">Ordini Gruppo</h2>
                                                <button onClick={createOrder} className="bg-slate-900 dark:bg-white dark:text-slate-900 text-white py-2 px-4 rounded-xl flex items-center gap-2 text-sm font-bold"><Plus size={18} /> NUOVO</button>
                                            </div>
                                            <div className="space-y-3">
                                                {orders.length === 0 && <p className="text-center text-slate-400 py-10">Nessun ordine attivo.</p>}
                                                {orders.map(order => (
                                                    <OrderCard 
                                                        key={order.id} 
                                                        order={order} 
                                                        currentUser={currentUser}
                                                        onClick={(id) => setActiveOrderId(id)}
                                                        onDelete={deleteOrder}
                                                        onReset={resetOrder}
                                                    />
                                                ))}
                                            </div>
                                        </>
                                    ) : (
                                        <OrderDetail order={orders.find(o => o.id == activeOrderId)} users={users} currentUser={currentUser} isManager={isManager} onBack={() => setActiveOrderId(null)} onAdd={addItemToOrder} onRemove={removeItemFromOrder} onDelete={deleteOrder} />
                                    )}
                                </div>
                            )}

                            {view === 'shopping' && isManager && (
                                <div className="animate-in space-y-6">
                                    <div className="bg-emerald-600 text-white p-6 rounded-3xl shadow-xl"><h2 className="text-3xl font-bold flex items-center gap-2"><ShoppingCart /> Lista Spesa</h2><p className="text-emerald-100 text-sm mt-1">{shoppingList.filter(g => !g.allBought).length} prodotti da acquistare</p></div>
                                    <div className="space-y-4">
                                        {shoppingList.map((group, idx) => (
                                            <div key={idx} className={`bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl p-4 shadow-sm ${group.allBought ? 'opacity-60' : 'border-emerald-100 dark:border-emerald-900/30 ring-1 ring-emerald-50 dark:ring-emerald-900/10'}`}>
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="w-full overflow-hidden">
                                                        <h3 className="font-bold text-lg truncate text-slate-800 dark:text-white">{group.count}x {group.link ? 'Prodotto' : 'Oggetto'}</h3>
                                                        {group.link && <a href={group.link} target="_blank" className="flex items-center gap-1 text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-2 py-1.5 rounded-lg font-bold w-fit mt-1 truncate"><ExternalLink size={12} /> {group.link}</a>}
                                                    </div>
                                                </div>
                                                <div className="space-y-2">
                                                    {group.items.map(item => (
                                                        <div key={item.id} className="flex flex-col bg-slate-50 dark:bg-slate-700/50 p-2 rounded-lg text-sm border dark:border-slate-600">
                                                            <div className="flex justify-between items-center mb-1">
                                                                <span className="font-semibold text-slate-700 dark:text-slate-200">{item.person} <span className="text-xs font-normal text-slate-500 dark:text-slate-400">{item.liquidMl}ml • {item.nicotineMl}</span></span>
                                                                <button onClick={() => toggleBoughtStatus(item.orderId, item.id)} className="flex items-center gap-2 px-3 py-1 bg-white dark:bg-slate-700 border dark:border-slate-600 rounded-lg text-xs font-bold dark:text-white">{item.bought ? <CheckSquare size={14}/> : <Square size={14}/>} {item.bought ? 'PRESO' : 'DA PRENDERE'}</button>
                                                            </div>
                                                            {item.otherItems && <div className="text-xs text-orange-500 flex gap-1"><ShoppingBasket size={12}/> {item.otherItems}</div>}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {view === 'logistics' && isManager && (
                                <div className="animate-in space-y-6">
                                    <div className="bg-slate-900 dark:bg-black text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                                        <div className="relative z-10 flex justify-between items-start">
                                            <div><p className="text-slate-400 text-sm font-medium uppercase tracking-wider mb-1">Totale Crediti</p><h2 className="text-4xl font-bold text-emerald-400">€{managerStats.totalCredits.toFixed(2)}</h2></div>
                                            <button onClick={downloadExcel} className="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-emerald-900/50 hover:bg-emerald-500 transition"><FileSpreadsheet size={16} /> Excel (.xlsx)</button>
                                        </div>
                                    </div>
                                    <div className="space-y-6">
                                        {Object.entries(logisticsData).sort(([,a], [,b]) => b.totalDebt - a.totalDebt).map(([name, data]) => (
                                            <div key={name} className="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl shadow-sm overflow-hidden">
                                                <div className="bg-slate-50 dark:bg-slate-900/50 p-4 border-b dark:border-slate-700 flex justify-between items-center">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 bg-white dark:bg-slate-700 border dark:border-slate-600 rounded-full flex items-center justify-center font-bold text-slate-600 dark:text-slate-200">{name.charAt(0)}</div>
                                                        <div><h3 className="font-bold text-slate-800 dark:text-white">{name}</h3><p className="text-xs text-slate-400">{data.items.length} articoli</p></div>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className={`font-mono font-bold text-lg ${data.totalDebt > 0 ? 'text-red-500' : 'text-emerald-500'}`}>{data.totalDebt > 0 ? `-€${data.totalDebt.toFixed(2)}` : '€0.00'}</p>
                                                        <div className="flex gap-1 justify-end mt-1">
                                                            <button onClick={() => togglePaymentRequest(name)} className={`p-1.5 rounded-full transition ${paymentRequests[name] ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400' : 'bg-slate-100 dark:bg-slate-700 text-slate-400'}`}><Bell size={14} /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="divide-y dark:divide-slate-700">
                                                    {data.items.map(item => (
                                                        <div key={item.id} className="p-3 text-sm flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                                            <div className="overflow-hidden pr-2">
                                                                <p className="font-medium truncate text-slate-800 dark:text-slate-200">{item.link || item.otherItems}</p>
                                                                <p className="text-[10px] text-slate-400">{item.orderTitle} • {item.orderDate}</p>
                                                            </div>
                                                            <div className="flex items-center gap-2 shrink-0">
                                                                <input type="number" step="0.01" className="w-16 bg-white dark:bg-slate-900 border dark:border-slate-600 rounded px-1 py-0.5 text-right font-mono text-slate-800 dark:text-white" value={item.price} onChange={(e) => updateItemPrice(item.orderId, item.id, e.target.value)} />
                                                                <button onClick={() => togglePaidStatus(item.orderId, item.id)} className={`p-1 rounded-full border ${item.paid ? 'bg-emerald-500 text-white border-emerald-500' : 'text-slate-300 dark:text-slate-600'}`}><Check size={12} /></button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </main>

                        {!activeOrderId && (
                            <nav className="bg-white dark:bg-slate-900 border-t dark:border-slate-800 p-2 md:hidden fixed bottom-0 left-0 right-0 z-30 pb-safe flex justify-center gap-8">
                                <NavButton icon={User} label="Profilo" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                                {!isManager && <NavButton icon={ShoppingBag} label="Ordini" active={view === 'orders'} onClick={() => setView('orders')} />}
                                {isManager && <NavButton icon={ShoppingCart} label="Spesa" active={view === 'shopping'} onClick={() => setView('shopping')} />}
                                {isManager && <NavButton icon={FileSpreadsheet} label="Logistica" active={view === 'logistics'} onClick={() => setView('logistics')} />}
                            </nav>
                        )}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<OrderManager />);
    </script>
</body>
</html>
