<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Svapo Manager Cloud</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☁️</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            950: '#020617',
                        }
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>
    
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- React & Babel -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        body { overscroll-behavior-y: none; }
        
        /* Dark mode transitions */
        body, div, p, h1, h2, h3, button, li, input, select { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 selection:bg-indigo-100 dark:selection:bg-indigo-900/50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Check, X, ArrowLeft, Share2, DollarSign, Users, 
            ShoppingBag, Wallet, Link as LinkIcon, Wind, 
            LogOut, TrendingUp, History, User, ShoppingCart, ExternalLink, CheckSquare, Square, Lock, Beaker, ShoppingBasket, Send, List, FileSpreadsheet, Bell, BellRing, KeyRound, PiggyBank, ArrowUpRight, CloudLightning, MessageCircle, AlertCircle, RefreshCcw, MoreHorizontal, Moon, Sun, Monitor, AlertTriangle, Info, ChevronDown, Calendar, Droplet, CheckCircle2, Eye, EyeOff, CheckCircle, Package, Archive, Calculator, Banknote, ArrowRight, Loader2, Save, Settings, RotateCcw, Heart, Star, BarChart3, Box, Edit2, ClipboardList, Globe, Activity, Truck, Book
            // NUOVE ICONE PACCHETTO SVAPO
            , Cloud, Zap, Droplets, FlaskConical, Sparkles, Layers, Syringe
        } from 'lucide-react';
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs, writeBatch, arrayUnion, arrayRemove, getDoc } from 'firebase/firestore';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDwpBj5NXy4iZkOKXMEMd_CY1_1cMMRx-s",
              authDomain: "svapomenager.firebaseapp.com",
              projectId: "svapomenager",
              storageBucket: "svapomenager.firebasestorage.app",
              messagingSenderId: "512019732894",
              appId: "1:512019732894:web:d4fb58561b3fbea1ff1e8f",
              measurementId: "G-VDCNTT6WHM"
        };

        let app, db, auth;
        const isConfigured = firebaseConfig.apiKey !== "TUO_API_KEY";
        
        if (isConfigured) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        }
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'svapo-manager-default';

        // --- DEFAULT CONFIG ---
        const DEFAULT_PRICING = {
            nicotineBottlePrice: 2.50,
            nicotineBottleMg: 200,
            nicotineBottleVol: 10,
            defaultAromaPrice: 6.00,
            aromaVol: 10,
            basePricePerMl: 0.013
        };

        // --- ICON MAP FOR WAREHOUSE ---
        const WAREHOUSE_ICONS = {
            'Box': Box,
            'Droplet': Droplet,
            'Zap': Zap,
            'FlaskConical': FlaskConical,
            'Cloud': Cloud,
            'Package': Package,
            'Sparkles': Sparkles,
            'Layers': Layers
        };

        // --- HELPER COMPONENTS & HOOKS ---

        const useTheme = () => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'auto');

            useEffect(() => {
                const root = window.document.documentElement;
                const isDark = theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                if (isDark) {
                    root.classList.add('dark');
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#020617');
                } else {
                    root.classList.remove('dark');
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff');
                }
                localStorage.setItem('theme', theme);
            }, [theme]);

            return [theme, setTheme];
        };

        const NavButton = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1 w-16 transition-all duration-300 ${active ? 'text-blue-600 dark:text-blue-400 -translate-y-1' : 'text-slate-400 dark:text-slate-500'}`}>
                <Icon size={24} className={active ? "fill-blue-100 dark:fill-blue-900 drop-shadow-sm" : ""} strokeWidth={active ? 2.5 : 2} />
                {active && <span className="text-[10px] font-bold mt-1 animate-in fade-in slide-in-from-bottom-1">{label}</span>}
            </button>
        );

        const NavButtonDesktop = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors font-medium text-sm ${active ? 'bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800'}`}>
                <Icon size={18} /><span>{label}</span>
            </button>
        );

        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Conferma", isDanger = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden border dark:border-slate-700 transform scale-100 transition-all animate-in zoom-in-95 duration-200">
                        <div className="p-6">
                            <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                                {isDanger && <AlertTriangle className="text-red-500" />} {title}
                            </h3>
                            <p className="text-slate-500 dark:text-slate-400 text-sm leading-relaxed">{message}</p>
                        </div>
                        <div className="bg-slate-50 dark:bg-slate-800 p-4 flex gap-3 justify-end border-t dark:border-slate-700">
                            <button onClick={onCancel} className="px-5 py-2.5 rounded-xl text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition">Annulla</button>
                            <button 
                                onClick={onConfirm} 
                                className={`px-5 py-2.5 rounded-xl text-white font-bold transition shadow-lg ${isDanger ? 'bg-red-500 hover:bg-red-600 shadow-red-500/30' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/30'}`}
                            >
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const IconSelector = ({ selected, onSelect }) => (
            <div className="grid grid-cols-4 gap-2 mb-4">
                {Object.keys(WAREHOUSE_ICONS).map(iconName => {
                    const Icon = WAREHOUSE_ICONS[iconName];
                    return (
                        <button 
                            key={iconName}
                            type="button"
                            onClick={() => onSelect(iconName)}
                            className={`p-2 rounded-xl flex items-center justify-center transition-all focus:outline-none ${selected === iconName ? 'bg-indigo-600 text-white shadow-lg scale-105' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-600'}`}
                        >
                            <Icon size={20} />
                        </button>
                    );
                })}
            </div>
        );

        // --- TRACKING MODAL ---
        const TrackingModal = ({ isOpen, onClose, onSave, initialValue }) => {
            const [val, setVal] = useState(initialValue || '');
            useEffect(() => setVal(initialValue || ''), [initialValue, isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-sm p-6 shadow-2xl border dark:border-slate-700 animate-in zoom-in-95">
                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-slate-900 dark:text-white"><Truck size={24} className="text-blue-500"/> Tracking Spedizione</h3>
                        <p className="text-sm text-slate-500 mb-4">Inserisci il link al corriere o il codice di tracciamento per questo ordine.</p>
                        <input 
                            autoFocus
                            type="text" 
                            className="w-full bg-slate-100 dark:bg-slate-800 p-3 rounded-xl mb-4 font-bold outline-none ring-2 ring-transparent focus:ring-blue-500 transition-all text-sm" 
                            placeholder="https://... o Codice" 
                            value={val} 
                            onChange={e => setVal(e.target.value)} 
                        />
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">Annulla</button>
                            <button onClick={() => onSave(val)} className="flex-1 py-3 rounded-xl font-bold bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-500/30">Salva</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddToFavoriteModal = ({ isOpen, onClose, onConfirm, item }) => {
            const [name, setName] = useState('');
            useEffect(() => { if(isOpen) setName(''); }, [isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-sm p-6 shadow-2xl border dark:border-slate-700 animate-in zoom-in-95">
                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-pink-500"><Heart fill="currentColor" /> Salva nei Preferiti</h3>
                        <p className="text-sm text-slate-500 mb-4">Dai un nome personalizzato a questo aroma per ritrovarlo facilmente.</p>
                        <input 
                            autoFocus
                            type="text" 
                            className="w-full bg-slate-100 dark:bg-slate-800 p-3 rounded-xl mb-4 font-bold outline-none ring-2 ring-transparent focus:ring-pink-500 transition-all" 
                            placeholder="Es. Il mio tabaccoso..." 
                            value={name} 
                            onChange={e => setName(e.target.value)} 
                        />
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">Annulla</button>
                            <button 
                                onClick={() => { if(name.trim()) onConfirm(name); }} 
                                disabled={!name.trim()}
                                className="flex-1 py-3 rounded-xl font-bold bg-pink-500 text-white hover:bg-pink-600 shadow-lg shadow-pink-500/30 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Salva
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const PricingModal = ({ isOpen, onClose, currentPricing, onSave }) => {
            const [form, setForm] = useState(currentPricing);

            useEffect(() => { setForm(currentPricing); }, [currentPricing, isOpen]);

            if (!isOpen) return null;

            const handleChange = (field, value) => {
                setForm(prev => ({...prev, [field]: parseFloat(value) || 0}));
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-sm p-6 shadow-2xl border dark:border-slate-700 animate-in zoom-in-95">
                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-slate-900 dark:text-white"><Settings /> Configurazione Prezzi</h3>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase">Costo Boccetta Nicotina (€)</label>
                                <input type="number" step="0.01" className="w-full bg-slate-100 dark:bg-slate-800 p-3 rounded-xl mt-1 font-bold" value={form.nicotineBottlePrice} onChange={e => handleChange('nicotineBottlePrice', e.target.value)} />
                                <p className="text-[10px] text-slate-400 mt-1">Attuale: {currentPricing.nicotineBottleMg}mg in {currentPricing.nicotineBottleVol}ml</p>
                            </div>
                            
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase">Costo Base Neutra (€/ml)</label>
                                <input type="number" step="0.001" className="w-full bg-slate-100 dark:bg-slate-800 p-3 rounded-xl mt-1 font-bold" value={form.basePricePerMl} onChange={e => handleChange('basePricePerMl', e.target.value)} />
                                <p className="text-[10px] text-slate-400 mt-1">Es: 0.013 = 13€ al Litro</p>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase">Costo Aroma Default (€)</label>
                                <input type="number" step="0.01" className="w-full bg-slate-100 dark:bg-slate-800 p-3 rounded-xl mt-1 font-bold" value={form.defaultAromaPrice} onChange={e => handleChange('defaultAromaPrice', e.target.value)} />
                            </div>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">Annulla</button>
                            <button onClick={() => onSave(form)} className="flex-1 py-3 rounded-xl font-bold bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-500/30">Salva</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- SUB-VIEWS / PAGES ---

        // --- UNIFIED USER LISTS COMPONENT (WISHLIST + FAVORITES) ---
        const UserLists = ({ onBack, currentUser, activeOrderId, onAddToOrder }) => {
            const [tab, setTab] = useState('wishlist'); // 'wishlist' | 'favorites'
            const [wishlistItems, setWishlistItems] = useState([]);
            const [favItems, setFavItems] = useState([]);
            
            // Wishlist Input State
            const [newItemName, setNewItemName] = useState('');
            const [newItemNote, setNewItemNote] = useState('');

            // Load Wishlist
            useEffect(() => {
                const unsub = onSnapshot(doc(db, 'artifacts', APP_ID, 'public', 'data', 'wishlists', currentUser), (s) => {
                    if(s.exists()) setWishlistItems(s.data().items || []);
                });
                return () => unsub();
            }, [currentUser]);

            // Load Favorites
            useEffect(() => {
                const unsub = onSnapshot(doc(db, 'artifacts', APP_ID, 'public', 'data', 'favorites', currentUser), (s) => {
                    if(s.exists()) setFavItems(s.data().items || []);
                });
                return () => unsub();
            }, [currentUser]);

            // Wishlist Actions
            const addWishlistItem = async (e) => {
                e.preventDefault();
                if(!newItemName.trim()) return;
                const newItem = {
                    id: Date.now(),
                    name: newItemName,
                    note: newItemNote,
                    date: new Date().toLocaleDateString('it-IT')
                };
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'wishlists', currentUser), { items: arrayUnion(newItem) }, { merge: true });
                setNewItemName(''); setNewItemNote('');
            };
            const removeWishlistItem = async (item) => {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'wishlists', currentUser), { items: arrayRemove(item) }, { merge: true });
            };

            // Favorites Actions
            const removeFavItem = async (item) => {
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'favorites', currentUser), { items: arrayRemove(item) });
            };

            // Unified Move To Order
            const moveToOrder = (item, type) => {
                if(!activeOrderId) return;
                if (type === 'wishlist') {
                     onAddToOrder({
                        link: item.name,
                        otherItems: item.note,
                        liquidMl: '',
                        nicotineMl: '',
                        vapeType: '',
                        price: 0
                    });
                } else {
                    // Favorites item usually has correct structure, but re-map to be safe or just pass
                    onAddToOrder(item);
                }
            };

            return (
                <div className="pb-20 animate-in p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><ArrowLeft/></button>
                        <h2 className="text-xl font-bold">Le Mie Liste</h2>
                    </div>

                    {/* TABS */}
                    <div className="flex p-1 bg-slate-200 dark:bg-slate-800 rounded-xl mb-6">
                        <button 
                            onClick={()=>setTab('wishlist')} 
                            className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${tab==='wishlist' ? 'bg-white dark:bg-slate-700 shadow text-indigo-600 dark:text-indigo-400' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}
                        >
                            Wishlist
                        </button>
                        <button 
                            onClick={()=>setTab('favorites')} 
                            className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${tab==='favorites' ? 'bg-white dark:bg-slate-700 shadow text-pink-600 dark:text-pink-400' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}
                        >
                            Preferiti
                        </button>
                    </div>

                    {/* CONTENT: WISHLIST */}
                    {tab === 'wishlist' && (
                        <div className="animate-in fade-in space-y-4">
                             <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border dark:border-slate-700">
                                <form onSubmit={addWishlistItem} className="flex flex-col gap-2">
                                    <input 
                                        className="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-xl font-medium outline-none dark:text-white" 
                                        placeholder="Link o Nome prodotto..." 
                                        value={newItemName} 
                                        onChange={e => setNewItemName(e.target.value)} 
                                    />
                                    <div className="flex gap-2">
                                        <input 
                                            className="flex-1 bg-slate-100 dark:bg-slate-700 p-3 rounded-xl font-medium outline-none text-sm dark:text-white" 
                                            placeholder="Note (opzionale)" 
                                            value={newItemNote} 
                                            onChange={e => setNewItemNote(e.target.value)} 
                                        />
                                        <button type="submit" className="bg-indigo-600 text-white p-3 rounded-xl font-bold"><Plus/></button>
                                    </div>
                                </form>
                            </div>

                            <div className="space-y-3">
                                {wishlistItems.map(item => (
                                    <div key={item.id} className="bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 shadow-sm">
                                        <div className="flex justify-between items-start">
                                            <div className="min-w-0 flex-1">
                                                {item.name.startsWith('http') ? (
                                                    <a href={item.name} target="_blank" className="font-bold text-blue-600 dark:text-blue-400 truncate block hover:underline">{item.name}</a>
                                                ) : (
                                                    <p className="font-bold text-slate-800 dark:text-white">{item.name}</p>
                                                )}
                                                {item.note && <p className="text-xs text-slate-500 mt-1">{item.note}</p>}
                                                <p className="text-[10px] text-slate-400 mt-2">Aggiunto il {item.date}</p>
                                            </div>
                                            <button onClick={() => removeWishlistItem(item)} className="text-slate-300 hover:text-red-500 p-2"><Trash2 size={18}/></button>
                                        </div>
                                        {activeOrderId && (
                                            <button 
                                                onClick={() => moveToOrder(item, 'wishlist')}
                                                className="w-full mt-3 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 hover:bg-indigo-100 transition-colors"
                                            >
                                                <ShoppingCart size={14}/> Sposta nel carrello attivo
                                            </button>
                                        )}
                                    </div>
                                ))}
                                {wishlistItems.length === 0 && <p className="text-center text-slate-400 py-10">La tua wishlist è vuota.</p>}
                            </div>
                        </div>
                    )}

                    {/* CONTENT: FAVORITES */}
                    {tab === 'favorites' && (
                        <div className="animate-in fade-in space-y-3">
                            {favItems.map(i => (
                                <div key={i.id} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border dark:border-slate-700">
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <h3 className="font-bold text-lg text-slate-800 dark:text-white">{i.name}</h3>
                                            <a href={i.link} target="_blank" className="text-xs text-blue-500 hover:underline truncate block max-w-[200px]">{i.link}</a>
                                            <p className="text-xs text-slate-400 mt-1">{i.liquidMl}ml • {i.nicotineMl}nic • {i.vapeType}</p>
                                        </div>
                                        <button onClick={()=>removeFavItem(i)} className="text-slate-400 hover:text-red-500 p-1"><Trash2 size={18}/></button>
                                    </div>
                                    <button 
                                        onClick={() => moveToOrder(i, 'favorites')}
                                        className="w-full mt-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 hover:bg-indigo-100 dark:hover:bg-indigo-900/50"
                                    >
                                        <Plus size={14}/> Aggiungi all'ordine attivo
                                    </button>
                                </div>
                            ))}
                            {favItems.length === 0 && (
                                <div className="text-center py-10 text-slate-400">
                                    <Heart size={48} className="mx-auto mb-3 opacity-20"/>
                                    <p>Nessun aroma preferito.</p>
                                    <p className="text-xs mt-1">Aggiungili cliccando il cuore sui tuoi acquisti recenti.</p>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            )
        }

        const NoticeManager = ({ onBack, notices, showConfirm }) => {
            const [text, setText] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [editText, setEditText] = useState('');

            const saveNotices = async (newNotices) => {
                try {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { 
                        notices: newNotices 
                    }, {merge: true});
                } catch(e) {
                    console.error(e);
                }
            };

            const handleAdd = async (e) => {
                e.preventDefault();
                if(!text.trim()) return;
                const newNotice = {
                    id: Date.now(),
                    text: text.trim(),
                    date: new Date().toLocaleDateString('it-IT'),
                    active: true
                };
                await saveNotices([newNotice, ...notices]);
                setText('');
            };

            const handleDelete = (id) => {
                showConfirm(
                    "Elimina Avviso",
                    "Sei sicuro di voler eliminare questo avviso?",
                    async () => {
                        const filtered = notices.filter(n => n.id !== id);
                        await saveNotices(filtered);
                    },
                    true,
                    "Elimina"
                );
            };

            const startEdit = (n) => {
                setEditingId(n.id);
                setEditText(n.text);
            };

            const saveEdit = async () => {
                const updated = notices.map(n => n.id === editingId ? { ...n, text: editText } : n);
                await saveNotices(updated);
                setEditingId(null);
                setEditText('');
            };

            const toggleActive = async (n) => {
                const updated = notices.map(item => item.id === n.id ? { ...item, active: !item.active } : item);
                await saveNotices(updated);
            };

            return (
                <div className="pb-20 animate-in p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><ArrowLeft/></button>
                        <h2 className="text-xl font-bold">Gestione Bacheca</h2>
                    </div>

                    {/* Add New */}
                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border dark:border-slate-700 mb-6">
                        <h3 className="font-bold text-sm mb-3 uppercase text-slate-500">Nuovo Avviso</h3>
                        <form onSubmit={handleAdd} className="flex gap-2">
                            <input 
                                className="flex-1 bg-slate-100 dark:bg-slate-700 p-3 rounded-xl font-medium outline-none dark:text-white" 
                                placeholder="Scrivi qui..." 
                                value={text} 
                                onChange={e => setText(e.target.value)} 
                            />
                            <button type="submit" className="bg-indigo-600 text-white p-3 rounded-xl font-bold"><Plus/></button>
                        </form>
                    </div>

                    {/* List */}
                    <div className="space-y-4">
                        {notices.map(n => (
                            <div key={n.id} className={`p-4 rounded-2xl border transition-all ${n.active ? 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700' : 'bg-slate-50 dark:bg-slate-900 border-slate-100 dark:border-slate-800 opacity-75'}`}>
                                <div className="flex justify-between items-start mb-2">
                                    <span className="text-[10px] font-bold text-slate-400 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">{n.date}</span>
                                    <div className="flex gap-1">
                                        <button onClick={() => toggleActive(n)} className={`p-2 rounded-lg transition-colors ${n.active ? 'text-green-500 bg-green-50 dark:bg-green-900/20' : 'text-slate-400 bg-slate-100 dark:bg-slate-800'}`}>
                                            {n.active ? <Eye size={16}/> : <EyeOff size={16}/>}
                                        </button>
                                        <button onClick={() => startEdit(n)} className="p-2 rounded-lg text-blue-500 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/40"><Edit2 size={16}/></button>
                                        <button onClick={() => handleDelete(n.id)} className="p-2 rounded-lg text-red-500 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40"><Trash2 size={16}/></button>
                                    </div>
                                </div>
                                
                                {editingId === n.id ? (
                                    <div className="flex gap-2 mt-2">
                                        <input className="flex-1 border-b-2 border-indigo-500 bg-transparent outline-none pb-1 dark:text-white" value={editText} onChange={e=>setEditText(e.target.value)} autoFocus />
                                        <button onClick={saveEdit} className="text-xs bg-indigo-600 text-white px-3 rounded-lg font-bold">Salva</button>
                                    </div>
                                ) : (
                                    <p className={`font-medium text-lg leading-snug ${n.active ? 'text-slate-800 dark:text-slate-200' : 'text-slate-400 line-through'}`}>{n.text}</p>
                                )}
                            </div>
                        ))}
                        {notices.length === 0 && <p className="text-center text-slate-400 py-10">Nessun avviso in bacheca.</p>}
                    </div>
                </div>
            );
        };

        const CoilTracker = ({ onBack, currentUser, orders }) => {
            const [lastChangeDate, setLastChangeDate] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            // Carica la data dal database (Percorso Pubblico per evitare permessi user/{uid})
            useEffect(() => {
                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'coil_settings', currentUser);
                const unsub = onSnapshot(docRef, (s) => {
                    if (s.exists() && s.data().lastCoilChange) {
                        setLastChangeDate(s.data().lastCoilChange);
                    }
                    setIsLoading(false);
                });
                return () => unsub();
            }, [currentUser]);

            const handleResetCoil = async () => {
                const now = new Date().toISOString();
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'coil_settings', currentUser), { 
                    lastCoilChange: now 
                }, { merge: true });
                setLastChangeDate(now);
            };

            const stats = useMemo(() => {
                if (!lastChangeDate) return { days: 0, ml: 0 };

                const start = new Date(lastChangeDate);
                const now = new Date();
                const diffTime = Math.abs(now - start);
                const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                let ml = 0;
                
                // Calcola ML dagli ordini ACQUISTATI (bought=true) dopo la data di cambio
                orders.forEach(order => {
                    const [d, m, y] = order.date.split('/');
                    const orderDate = new Date(y, m - 1, d);
                    
                    if (orderDate >= new Date(start.setHours(0,0,0,0))) {
                        (order.items || []).forEach(item => {
                            if (item.person === currentUser && item.bought && item.liquidMl) {
                                ml += parseFloat(item.liquidMl);
                            }
                        });
                    }
                });

                return { days, ml };
            }, [lastChangeDate, orders, currentUser]);

            return (
                <div className="pb-20 animate-in p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><ArrowLeft/></button>
                        <h2 className="text-xl font-bold">Stato Resistenza</h2>
                    </div>

                    <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-lg border dark:border-slate-700 text-center mb-6 relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10">
                            <Zap size={100} />
                        </div>
                        
                        <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Attiva da</p>
                        <h1 className="text-6xl font-black text-indigo-600 dark:text-indigo-400 mb-2">
                            {stats.days} <span className="text-lg font-bold text-slate-400">giorni</span>
                        </h1>
                        
                        {lastChangeDate && (
                            <p className="text-xs text-slate-400">
                                Cambiata il {new Date(lastChangeDate).toLocaleDateString('it-IT', { day: 'numeric', month: 'long', hour: '2-digit', minute:'2-digit' })}
                            </p>
                        )}
                    </div>

                    <div className="bg-blue-50 dark:bg-blue-900/20 p-5 rounded-2xl border border-blue-100 dark:border-blue-900/50 mb-8 flex items-center gap-4">
                        <div className="bg-blue-100 dark:bg-blue-800 p-3 rounded-xl text-blue-600 dark:text-blue-300">
                            <Droplets size={24} />
                        </div>
                        <div>
                            <p className="text-xs text-blue-500 dark:text-blue-400 font-bold uppercase">Consumo Stimato</p>
                            <p className="text-2xl font-bold text-slate-800 dark:text-white">{stats.ml} ml</p>
                            <p className="text-[10px] text-slate-400 leading-tight mt-1">Basato sugli acquisti segnati come "PRESO" dopo il cambio coil.</p>
                        </div>
                    </div>

                    <button 
                        onClick={() => {
                            if(confirm("Confermi di aver cambiato la resistenza adesso? Il conteggio verrà azzerato.")) {
                                handleResetCoil();
                            }
                        }}
                        className="w-full py-4 rounded-2xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold shadow-xl flex items-center justify-center gap-2 hover:scale-[1.02] active:scale-95 transition-all"
                    >
                        <RefreshCcw size={20} />
                        HO CAMBIATO LA COIL OGGI
                    </button>
                </div>
            );
        };

        const UserActivityHub = ({ orders, currentUser, onBack }) => {
            const [lastChangeDate, setLastChangeDate] = useState(null);
            const [coilHistory, setCoilHistory] = useState([]);
            const [liquidLogs, setLiquidLogs] = useState([]); 
            const [isLoading, setIsLoading] = useState(true);

            // --- STATI FORM COIL ---
            const [isCoilFormOpen, setIsCoilFormOpen] = useState(false);
            const [coilFormDate, setCoilFormDate] = useState('');
            const [coilFormCost, setCoilFormCost] = useState('');

            // --- STATI FORM LIQUIDI ---
            const [isLiquidFormOpen, setIsLiquidFormOpen] = useState(false);
            const [liquidFormDate, setLiquidFormDate] = useState('');
            const [liquidFormMl, setLiquidFormMl] = useState('');
            // --------------------------

            // Carica dati
            useEffect(() => {
                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'coil_settings', currentUser);
                const unsub = onSnapshot(docRef, (s) => {
                    if (s.exists()) {
                        const data = s.data();
                        setLastChangeDate(data.lastCoilChange);
                        setCoilHistory(data.history || []);
                        setLiquidLogs(data.liquidLogs || []); // Carica storico liquidi indipendente
                    }
                    setIsLoading(false);
                });
                return () => unsub();
            }, [currentUser]);

            // STATISTICHE ACQUISTI (SPESA E ML BASATI SUGLI ORDINI)
            const purchaseStats = useMemo(() => {
                let totalSpent = 0;
                let totalMlPurchased = 0;
                orders.forEach(o => {
                    // Consideriamo solo ordini 'bought' (presi) o 'paid' (pagati)
                    (o.items || []).filter(i => i.person === currentUser && (i.bought || i.paid)).forEach(i => {
                        totalSpent += (parseFloat(i.price) || 0);
                        if (i.liquidMl) {
                            totalMlPurchased += (parseFloat(i.liquidMl) || 0);
                        }
                    });
                });
                return { totalSpent, totalMlPurchased };
            }, [orders, currentUser]);

            // STATISTICHE SVAPO REALE (BASATE SOLO SULLO STORICO INSERITO DALL'UTENTE)
            const actualVapedStats = useMemo(() => {
                const totalMl = liquidLogs.reduce((acc, curr) => acc + (parseFloat(curr.ml) || 0), 0);
                return { totalMl };
            }, [liquidLogs]);

            // STATISTICHE COIL ATTUALE (SOLO GIORNI)
            const currentCoilDays = useMemo(() => {
                if (!lastChangeDate) return 0;
                const start = new Date(lastChangeDate);
                const now = new Date();
                const diffTime = Math.abs(now - start);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            }, [lastChangeDate]);

            // --- APERTURA FORM ---
            const openResetForm = () => {
                const today = new Date().toISOString().split('T')[0];
                setCoilFormDate(today);
                setCoilFormCost('');
                setIsCoilFormOpen(true);
            };

            const openCoilForm = () => {
                const today = new Date().toISOString().split('T')[0];
                setCoilFormDate(today);
                setCoilFormCost('');
                setIsCoilFormOpen(true);
                setIsLiquidFormOpen(false); // Chiude l'altro form se aperto
            };

            // --- SALVATAGGIO DATI ---
            const handleCoilSubmit = async (e) => {
                e.preventDefault();
                
                const newDateIso = new Date(coilFormDate).toISOString();
                
                // Calcolo giorni effettivi basato sulla data inserita dall'utente
                let daysLasted = 0;
                if (lastChangeDate) {
                    const start = new Date(lastChangeDate);
                    const end = new Date(coilFormDate);
                    const diff = Math.abs(end - start);
                    daysLasted = Math.ceil(diff / (1000 * 60 * 60 * 24));
                }

                // Crea voce di storico
                const historyEntry = {
                    dateReplaced: newDateIso,
                    startDate: lastChangeDate || newDateIso,
                    daysLasted: daysLasted > 0 ? daysLasted : currentCoilDays,
                    cost: parseFloat(coilFormCost) || 0
                };

                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'coil_settings', currentUser), { 
                    lastCoilChange: newDateIso,
                    history: arrayUnion(historyEntry)
                }, { merge: true });

                setIsCoilFormOpen(false);
            };

            // --- GESTIONE AGGIUNTA LIQUIDO ---
            const openLiquidForm = () => {
                const today = new Date().toISOString().split('T')[0];
                setLiquidFormDate(today);
                setLiquidFormMl('');
                setIsLiquidFormOpen(true);
                setIsCoilFormOpen(false); // Chiude l'altro form
            };

            const handleLiquidSubmit = async (e) => {
                e.preventDefault();
                if (!liquidFormMl) return;

                const newLog = {
                    id: Date.now(),
                    date: new Date(liquidFormDate).toISOString(),
                    ml: parseFloat(liquidFormMl)
                };

                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'coil_settings', currentUser), { 
                    liquidLogs: arrayUnion(newLog)
                }, { merge: true });

                setIsLiquidFormOpen(false);
            };

            return (
                <div className="pb-20 animate-in p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><ArrowLeft/></button>
                        <h2 className="text-xl font-bold">Diario Svapo</h2>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        
                        {/* SEZIONE 1: HARDWARE / COIL */}
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-3xl shadow-lg border dark:border-slate-700 relative overflow-hidden flex flex-col h-full">
                             <div className="absolute top-0 right-0 p-4 opacity-5 dark:opacity-10 text-indigo-500">
                                <Zap size={100} />
                            </div>
                            <h3 className="font-bold text-slate-700 dark:text-slate-300 mb-4 flex items-center gap-2">
                                <Zap size={18} className="text-yellow-500"/> Gestione Hardware
                            </h3>

                            <div className="text-center mb-6">
                                <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Resistenza Attuale</p>
                                <h1 className="text-5xl font-black text-slate-800 dark:text-white mb-1">
                                    {currentCoilDays} <span className="text-lg font-bold text-slate-400">gg</span>
                                </h1>
                                {lastChangeDate ? (
                                    <p className="text-xs text-slate-400">Installata il {new Date(lastChangeDate).toLocaleDateString()}</p>
                                ) : (
                                    <p className="text-xs text-slate-400">Nessuna resistenza attiva</p>
                                )}
                            </div>

                            <div className="mt-auto">
                                {!isCoilFormOpen ? (
                                    <button 
                                        onClick={openCoilForm}
                                        className="w-full py-3 rounded-2xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold shadow-md flex items-center justify-center gap-2 hover:scale-[1.02] active:scale-95 transition-all text-sm"
                                    >
                                        <RefreshCcw size={16} /> CAMBIA RESISTENZA
                                    </button>
                                ) : (
                                    <form onSubmit={handleCoilSubmit} className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border border-slate-200 dark:border-slate-600 text-left animate-in fade-in">
                                        <h4 className="font-bold text-sm mb-3">Nuova Resistenza</h4>
                                        <div className="space-y-3 mb-4">
                                            <div>
                                                <label className="text-[10px] uppercase font-bold text-slate-400">Data Cambio</label>
                                                <input type="date" required className="w-full bg-white dark:bg-slate-800 p-2 rounded-lg border dark:border-slate-600 text-sm font-bold" value={coilFormDate} onChange={e => setCoilFormDate(e.target.value)} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] uppercase font-bold text-slate-400">Costo (€)</label>
                                                <input type="number" step="0.01" placeholder="0.00" className="w-full bg-white dark:bg-slate-800 p-2 rounded-lg border dark:border-slate-600 text-sm font-bold" value={coilFormCost} onChange={e => setCoilFormCost(e.target.value)} />
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button type="button" onClick={() => setIsCoilFormOpen(false)} className="flex-1 py-2 rounded-xl text-slate-500 font-bold bg-slate-200 dark:bg-slate-800 text-xs">Annulla</button>
                                            <button type="submit" className="flex-1 py-2 rounded-xl text-white font-bold bg-indigo-600 text-xs">Conferma</button>
                                        </div>
                                    </form>
                                )}
                            </div>
                        </div>

                        {/* SEZIONE 2: CONSUMO LIQUIDI MANUALE */}
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-3xl shadow-lg border dark:border-slate-700 relative overflow-hidden flex flex-col h-full">
                            <div className="absolute top-0 right-0 p-4 opacity-5 dark:opacity-10 text-blue-500">
                                <Droplets size={100} />
                            </div>
                            <h3 className="font-bold text-slate-700 dark:text-slate-300 mb-4 flex items-center gap-2">
                                <Droplets size={18} className="text-blue-500"/> Consumo Reale
                            </h3>

                            <div className="text-center mb-6">
                                <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Totale Svapato</p>
                                <h1 className="text-5xl font-black text-slate-800 dark:text-white mb-1">
                                    {actualVapedStats.totalMl.toFixed(0)} <span className="text-lg font-bold text-slate-400">ml</span>
                                </h1>
                                <p className="text-xs text-slate-400">Inseriti manualmente nel diario</p>
                            </div>
                            
                            <div className="mt-auto">
                                {!isLiquidFormOpen ? (
                                    <button 
                                        onClick={openLiquidForm}
                                        className="w-full py-3 rounded-2xl bg-blue-600 text-white font-bold shadow-md flex items-center justify-center gap-2 hover:bg-blue-700 active:scale-95 transition-all text-sm"
                                    >
                                        <Plus size={16} /> AGGIUNGI CONSUMO
                                    </button>
                                ) : (
                                    <form onSubmit={handleLiquidSubmit} className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border border-slate-200 dark:border-slate-600 text-left animate-in fade-in">
                                        <h4 className="font-bold text-sm mb-3">Registra Consumo</h4>
                                        <div className="space-y-3 mb-4">
                                            <div>
                                                <label className="text-[10px] uppercase font-bold text-slate-400">Data</label>
                                                <input type="date" required className="w-full bg-white dark:bg-slate-800 p-2 rounded-lg border dark:border-slate-600 text-sm font-bold" value={liquidFormDate} onChange={e => setLiquidFormDate(e.target.value)} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] uppercase font-bold text-slate-400">Quantità (ml)</label>
                                                <input type="number" step="1" placeholder="Es. 10" className="w-full bg-white dark:bg-slate-800 p-2 rounded-lg border dark:border-slate-600 text-sm font-bold" value={liquidFormMl} onChange={e => setLiquidFormMl(e.target.value)} required />
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button type="button" onClick={() => setIsLiquidFormOpen(false)} className="flex-1 py-2 rounded-xl text-slate-500 font-bold bg-slate-200 dark:bg-slate-800 text-xs">Annulla</button>
                                            <button type="submit" className="flex-1 py-2 rounded-xl text-white font-bold bg-blue-600 text-xs">Salva</button>
                                        </div>
                                    </form>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* SEZIONE 3: RIEPILOGO ACQUISTI (DAGLI ORDINI) */}
                    <div className="bg-white dark:bg-slate-800 p-5 rounded-3xl shadow-lg border dark:border-slate-700 mb-6 relative overflow-hidden">
                        <h3 className="font-bold text-slate-700 dark:text-slate-300 mb-4 flex items-center gap-2">
                            <Wallet size={18} className="text-emerald-500"/> Riepilogo Acquisti
                        </h3>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div className="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-2xl border border-emerald-100 dark:border-emerald-900/50">
                                <p className="text-emerald-500 text-[10px] font-bold uppercase mb-1">Totale Speso</p>
                                <p className="text-2xl font-bold text-slate-800 dark:text-white">€{purchaseStats.totalSpent.toFixed(2)}</p>
                            </div>
                            <div className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-2xl border border-indigo-100 dark:border-indigo-900/50">
                                <p className="text-indigo-500 text-[10px] font-bold uppercase mb-1">ML Acquistati</p>
                                <p className="text-2xl font-bold text-slate-800 dark:text-white">{purchaseStats.totalMlPurchased.toFixed(0)} <span className="text-sm text-slate-400">ml</span></p>
                            </div>
                            <div className="bg-slate-50 dark:bg-slate-700/30 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 col-span-2 md:col-span-1">
                                <p className="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase mb-1">Costo Medio / 10ml</p>
                                <p className="text-2xl font-bold text-slate-800 dark:text-white">
                                    {purchaseStats.totalMlPurchased > 0 
                                        ? `€${((purchaseStats.totalSpent / purchaseStats.totalMlPurchased) * 10).toFixed(2)}` 
                                        : 'N/A'}
                                </p>
                            </div>
                        </div>
                        <div className="mt-3 p-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-100 dark:border-slate-700 text-[10px] text-slate-500">
                             <Info size={12} className="inline mr-1 mb-0.5" /> Dati calcolati in base agli ordini segnati come "Preso" o "Pagato".
                        </div>
                    </div>

                    {/* LISTA ULTIMI INSERIMENTI */}
                    <div className="mt-8">
                        <h3 className="font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                            <History size={18} className="text-slate-400"/> Attività Recente
                        </h3>
                        <div className="space-y-2">
                            {/* Merge and sort history */}
                            {[
                                ...coilHistory.map(c => ({ ...c, type: 'coil', date: c.dateReplaced })),
                                ...liquidLogs.map(l => ({ ...l, type: 'liquid', date: l.date }))
                            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10).map((entry, idx) => (
                                <div key={idx} className="bg-white dark:bg-slate-800 border dark:border-slate-700 p-3 rounded-xl shadow-sm flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className={`p-2 rounded-lg ${entry.type === 'coil' ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30' : 'bg-blue-100 text-blue-600 dark:bg-blue-900/30'}`}>
                                            {entry.type === 'coil' ? <Zap size={16}/> : <Droplets size={16}/>}
                                        </div>
                                        <div>
                                            <p className="font-bold text-sm text-slate-800 dark:text-white">
                                                {entry.type === 'coil' ? 'Cambio Resistenza' : 'Consumo Liquido'}
                                            </p>
                                            <p className="text-xs text-slate-400">{new Date(entry.date).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        {entry.type === 'coil' ? (
                                            <span className="font-bold text-slate-600 dark:text-slate-300">€{entry.cost.toFixed(2)}</span>
                                        ) : (
                                            <span className="font-bold text-blue-500">{entry.ml} ml</span>
                                        )}
                                    </div>
                                </div>
                            ))}
                            {coilHistory.length === 0 && liquidLogs.length === 0 && (
                                <p className="text-center text-slate-400 text-sm py-4">Nessuna attività registrata.</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const MixingCalculator = ({ onBack }) => {
            const [vapeType, setVapeType] = useState('MTL');
            const [totalMl, setTotalMl] = useState(60);
            const [targetNic, setTargetNic] = useState(4);
            const [aromaPct, setAromaPct] = useState(10);
            
            const [nicStrength, setNicStrength] = useState(20); 
            const [showAdvanced, setShowAdvanced] = useState(false);

            useEffect(() => {
                if (vapeType === 'MTL') {
                    setTotalMl(60);
                    setTargetNic(4);
                    setAromaPct(10);
                } else {
                    setTotalMl(100);
                    setTargetNic(1.5);
                    setAromaPct(12);
                }
            }, [vapeType]);

            const result = useMemo(() => {
                const aromaMl = (totalMl * aromaPct) / 100;
                const nicMl = (totalMl * targetNic) / nicStrength;
                const baseMl = totalMl - aromaMl - nicMl;
                const nicBottles = nicMl / 10; 

                return { aromaMl, nicMl, baseMl, nicBottles, isValid: baseMl >= 0 };
            }, [totalMl, targetNic, aromaPct, nicStrength]);

            return (
                <div className="pb-20 animate-in p-4 max-w-lg mx-auto">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400">
                            <ArrowLeft />
                        </button>
                        <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Calcolatore Mix</h2>
                    </div>

                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <button 
                            onClick={() => setVapeType('MTL')}
                            className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all ${vapeType === 'MTL' 
                                ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' 
                                : 'border-slate-200 dark:border-slate-700 text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800'}`}
                        >
                            <Wind size={28} />
                            <span className="font-bold">Guanciale (MTL)</span>
                            <span className="text-[10px] opacity-70">Tiro chiuso, Base 50/50</span>
                        </button>

                        <button 
                            onClick={() => setVapeType('DL')}
                            className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all ${vapeType === 'DL' 
                                ? 'border-cyan-500 bg-cyan-50 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300' 
                                : 'border-slate-200 dark:border-slate-700 text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800'}`}
                        >
                            <Cloud size={28} />
                            <span className="font-bold">Polmonare (DL)</span>
                            <span className="text-[10px] opacity-70">Tiro aperto, Base 70/30</span>
                        </button>
                    </div>

                    <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border dark:border-slate-700 space-y-6">
                        <div>
                            <div className="flex justify-between mb-2">
                                <label className="text-xs font-bold text-slate-400 uppercase">Quantità da ottenere</label>
                                <span className="font-bold text-slate-800 dark:text-white">{totalMl} ml</span>
                            </div>
                            <input 
                                type="range" min="10" max="250" step="10" 
                                value={totalMl} onChange={(e) => setTotalMl(parseInt(e.target.value))}
                                className="w-full accent-indigo-600 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700"
                            />
                            <div className="flex gap-2 mt-2 overflow-x-auto pb-2 no-scrollbar">
                                {[10, 30, 60, 100, 120, 200].map(val => (
                                    <button key={val} onClick={() => setTotalMl(val)} className={`px-3 py-1 rounded-lg text-xs font-bold whitespace-nowrap ${totalMl === val ? 'bg-indigo-600 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-500'}`}>
                                        {val}ml
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <div className="flex justify-between mb-2">
                                <label className="text-xs font-bold text-slate-400 uppercase">Nicotina desiderata</label>
                                <span className="font-bold text-slate-800 dark:text-white">{targetNic} mg/ml</span>
                            </div>
                            <input 
                                type="range" min="0" max="18" step="0.5" 
                                value={targetNic} onChange={(e) => setTargetNic(parseFloat(e.target.value))}
                                className="w-full accent-purple-600 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700"
                            />
                        </div>

                        <div>
                            <div className="flex justify-between mb-2">
                                <label className="text-xs font-bold text-slate-400 uppercase">Aroma</label>
                                <span className="font-bold text-slate-800 dark:text-white">{aromaPct}%</span>
                            </div>
                            <input 
                                type="range" min="0" max="25" step="1" 
                                value={aromaPct} onChange={(e) => setAromaPct(parseInt(e.target.value))}
                                className="w-full accent-orange-500 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700"
                            />
                        </div>

                        <div className="pt-2 border-t dark:border-slate-700">
                            <button onClick={() => setShowAdvanced(!showAdvanced)} className="text-xs text-slate-400 flex items-center gap-1 font-bold">
                                <Settings size={12}/> {showAdvanced ? 'Nascondi opzioni basetta' : 'Opzioni basetta nicotina'}
                            </button>
                            {showAdvanced && (
                                <div className="mt-3 animate-in fade-in slide-in-from-top-1">
                                    <label className="text-xs font-bold text-slate-400 uppercase">Forza Basetta (solitamente 20mg)</label>
                                    <input 
                                        type="number" 
                                        value={nicStrength} 
                                        onChange={(e) => setNicStrength(e.target.value)} 
                                        className="w-full mt-1 bg-slate-100 dark:bg-slate-700 p-2 rounded-lg font-bold"
                                    />
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="mt-6">
                        <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                            <FlaskConical className="text-indigo-500" /> La tua Ricetta
                        </h3>

                        {!result.isValid ? (
                            <div className="p-4 bg-red-100 text-red-600 rounded-2xl text-center font-bold">
                                Impossibile: Troppa nicotina o aroma per il volume totale!
                            </div>
                        ) : (
                            <div className="bg-white dark:bg-slate-800 p-1 rounded-3xl shadow-lg border dark:border-slate-700 overflow-hidden">
                                <div className="grid grid-cols-3 divide-x dark:divide-slate-700">
                                    <div className="p-4 text-center">
                                        <p className="text-xs text-slate-400 uppercase font-bold mb-1">Base Neutra</p>
                                        <p className="text-xl font-black text-blue-600 dark:text-blue-400">{result.baseMl.toFixed(1)}</p>
                                        <p className="text-[10px] text-slate-400">ml</p>
                                        <div className="mt-2 text-[10px] bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded py-1 px-2 inline-block">
                                            {vapeType === 'MTL' ? '50/50' : '70/30'}
                                        </div>
                                    </div>

                                    <div className="p-4 text-center bg-purple-50/50 dark:bg-purple-900/10">
                                        <p className="text-xs text-slate-400 uppercase font-bold mb-1">Nicotina</p>
                                        <p className="text-xl font-black text-purple-600 dark:text-purple-400">{result.nicMl.toFixed(1)}</p>
                                        <p className="text-[10px] text-slate-400">ml</p>
                                        {result.nicMl > 0 && (
                                            <div className="mt-2 text-[10px] text-purple-500 font-bold">
                                                ~ {result.nicBottles.toFixed(1)} boccette
                                            </div>
                                        )}
                                    </div>

                                    <div className="p-4 text-center bg-orange-50/50 dark:bg-orange-900/10">
                                        <p className="text-xs text-slate-400 uppercase font-bold mb-1">Aroma</p>
                                        <p className="text-xl font-black text-orange-600 dark:text-orange-400">{result.aromaMl.toFixed(1)}</p>
                                        <p className="text-[10px] text-slate-400">ml</p>
                                    </div>
                                </div>
                                <div className="h-4 w-full flex">
                                    <div className="h-full bg-blue-500 transition-all duration-500" style={{ width: `${(result.baseMl / totalMl) * 100}%` }}></div>
                                    <div className="h-full bg-purple-500 transition-all duration-500" style={{ width: `${(result.nicMl / totalMl) * 100}%` }}></div>
                                    <div className="h-full bg-orange-500 transition-all duration-500" style={{ width: `${(result.aromaMl / totalMl) * 100}%` }}></div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const WarehouseManager = ({ onBack }) => {
            const [sections, setSections] = useState([]);
            const [items, setItems] = useState([]);
            
            const [isAddingSection, setIsAddingSection] = useState(false);
            const [newSectionName, setNewSectionName] = useState('');
            const [newSectionIcon, setNewSectionIcon] = useState('Box');

            const [addingItemToSection, setAddingItemToSection] = useState(null);
            const [newItemName, setNewItemName] = useState('');
            const [newItemQty, setNewItemQty] = useState(1);
            const [newItemVol, setNewItemVol] = useState('');

            const [withdrawingItem, setWithdrawingItem] = useState(null);
            const [withdrawAmount, setWithdrawAmount] = useState('');

            useEffect(() => {
                const unsub = onSnapshot(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'warehouse'), (s) => {
                    if (s.exists()) {
                        const data = s.data();
                        setSections(data.sections || []);
                        setItems(data.items || []);
                    }
                });
                return () => unsub();
            }, []);

            const handleAddSection = async (e) => {
                e.preventDefault();
                if(!newSectionName.trim()) return;
                const newSection = { id: Date.now().toString(), name: newSectionName, icon: newSectionIcon };
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'warehouse'), { sections: arrayUnion(newSection) }, { merge: true });
                setNewSectionName(''); 
                setIsAddingSection(false);
                setNewSectionIcon('Box');
            };

            const handleDeleteSection = async (sectionId) => {
                const sectionToDelete = sections.find(s => s.id === sectionId);
                const newItems = items.filter(i => i.sectionId !== sectionId);
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'warehouse'), { 
                    sections: arrayRemove(sectionToDelete),
                    items: newItems
                }, { merge: true });
            };

            const handleAddItem = async (e) => {
                e.preventDefault();
                if(!newItemName.trim()) return;
                const newItem = { 
                    id: Date.now(), 
                    name: newItemName, 
                    qty: parseInt(newItemQty), 
                    volume: parseFloat(newItemVol) || 0,
                    sectionId: addingItemToSection 
                };
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'warehouse'), { items: arrayUnion(newItem) }, { merge: true });
                setNewItemName(''); 
                setNewItemQty(1);
                setNewItemVol('');
                setAddingItemToSection(null);
            };

            const handleDeleteItem = async (item) => {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'warehouse'), { items: arrayRemove(item) }, { merge: true });
            };

            const handleWithdraw = async () => {
                if (!withdrawingItem || !withdrawAmount) return;
                const amount = parseFloat(withdrawAmount);
                if (isNaN(amount) || amount <= 0) return;
                let newVolume = withdrawingItem.volume - amount;
                if (newVolume < 0) newVolume = 0; 
                const updatedItems = items.map(i => {
                    if (i.id === withdrawingItem.id) {
                        return { ...i, volume: newVolume };
                    }
                    return i;
                });
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'warehouse'), { items: updatedItems }, { merge: true });
                setWithdrawingItem(null);
                setWithdrawAmount('');
            };

            const orphanedItems = items.filter(i => !sections.some(s => s.id === i.sectionId));

            return (
                <div className="pb-20 animate-in p-4 relative">
                    {withdrawingItem && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white dark:bg-slate-900 p-6 rounded-3xl w-full max-w-xs shadow-2xl border dark:border-slate-700">
                                <h3 className="font-bold text-lg mb-2">Preleva da {withdrawingItem.name}</h3>
                                <p className="text-sm text-slate-500 mb-4">Attuale: {withdrawingItem.volume || 0} ml</p>
                                <div className="flex items-center gap-2 mb-4">
                                    <input 
                                        autoFocus
                                        type="number" 
                                        placeholder="ml da scalare" 
                                        className="flex-1 bg-slate-100 dark:bg-slate-800 p-3 rounded-xl font-bold"
                                        value={withdrawAmount}
                                        onChange={e => setWithdrawAmount(e.target.value)}
                                    />
                                    <span className="text-slate-400 font-bold">ml</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setWithdrawingItem(null)} className="flex-1 py-3 rounded-xl text-slate-500 font-bold bg-slate-100 dark:bg-slate-800">Annulla</button>
                                    <button onClick={handleWithdraw} className="flex-1 py-3 rounded-xl text-white font-bold bg-indigo-600">Scala</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-2">
                            <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><ArrowLeft/></button>
                            <h2 className="text-xl font-bold">Deposito Scorte</h2>
                        </div>
                        <button 
                            onClick={() => {
                                setNewSectionName('');
                                setNewSectionIcon('Box');
                                setIsAddingSection(true);
                            }} 
                            className="bg-slate-900 dark:bg-white dark:text-slate-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2"
                        >
                            <Plus size={16}/> Nuova Sezione
                        </button>
                    </div>

                    {isAddingSection && (
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg border dark:border-slate-700 mb-6 animate-in fade-in zoom-in-95">
                            <h3 className="font-bold mb-3 text-sm uppercase text-slate-500">Crea Nuova Categoria</h3>
                            <form onSubmit={handleAddSection}>
                                <input 
                                    autoFocus
                                    type="text" 
                                    placeholder="Nome Sezione (es. Basi, Nicotina...)" 
                                    className="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-xl mb-4 font-bold" 
                                    value={newSectionName} 
                                    onChange={e=>setNewSectionName(e.target.value)} 
                                />
                                <p className="text-xs font-bold text-slate-400 uppercase mb-2">Scegli Icona</p>
                                <IconSelector selected={newSectionIcon} onSelect={setNewSectionIcon} />
                                
                                <div className="flex gap-2">
                                    <button type="button" onClick={() => setIsAddingSection(false)} className="flex-1 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700">Annulla</button>
                                    <button type="submit" className="flex-1 py-3 rounded-xl font-bold bg-indigo-600 text-white shadow-lg">Crea</button>
                                </div>
                            </form>
                        </div>
                    )}

                    <div className="space-y-6">
                        {sections.map(section => {
                            const Icon = WAREHOUSE_ICONS[section.icon] || Box;
                            const sectionItems = items.filter(i => i.sectionId === section.id);

                            return (
                                <div key={section.id} className="bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 shadow-sm overflow-hidden">
                                    <div className="p-4 bg-slate-50 dark:bg-slate-800/50 border-b dark:border-slate-700 flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-xl bg-white dark:bg-slate-700 flex items-center justify-center text-indigo-500 shadow-sm">
                                                <Icon size={20} />
                                            </div>
                                            <h3 className="font-bold text-lg">{section.name}</h3>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button 
                                                onClick={() => setAddingItemToSection(section.id)}
                                                className="p-2 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 transition-colors"
                                                title="Aggiungi Oggetto"
                                            >
                                                <Plus size={18} />
                                            </button>
                                            <button 
                                                onClick={() => handleDeleteSection(section.id)}
                                                className="p-2 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                                            >
                                                <Trash2 size={18} />
                                            </button>
                                        </div>
                                    </div>

                                    {addingItemToSection === section.id && (
                                        <div className="p-4 bg-indigo-50/50 dark:bg-indigo-900/10 border-b dark:border-slate-700 animate-in fade-in">
                                            <form onSubmit={handleAddItem} className="flex gap-2 items-center">
                                                <div className="flex-1 space-y-1">
                                                    <input type="text" placeholder="Nome oggetto..." className="w-full bg-white dark:bg-slate-700 p-2 rounded-lg text-sm border dark:border-slate-600" value={newItemName} onChange={e=>setNewItemName(e.target.value)} />
                                                </div>
                                                <div className="w-16 space-y-1">
                                                    <input type="number" placeholder="Qtà" className="w-full bg-white dark:bg-slate-700 p-2 rounded-lg text-sm border dark:border-slate-600 text-center" value={newItemQty} onChange={e=>setNewItemQty(e.target.value)} />
                                                </div>
                                                <div className="w-20 space-y-1">
                                                    <input type="number" placeholder="ml Tot" className="w-full bg-white dark:bg-slate-700 p-2 rounded-lg text-sm border dark:border-slate-600 text-center" value={newItemVol} onChange={e=>setNewItemVol(e.target.value)} />
                                                </div>
                                                <button type="submit" className="bg-indigo-600 text-white p-2 rounded-lg h-9 w-9 flex items-center justify-center"><Check size={18}/></button>
                                                <button type="button" onClick={() => setAddingItemToSection(null)} className="text-slate-400 p-2"><X size={18}/></button>
                                            </form>
                                        </div>
                                    )}

                                    <div className="p-2">
                                        {sectionItems.length === 0 ? (
                                            <p className="text-center text-slate-400 text-xs py-4 italic">Nessun oggetto in questa sezione.</p>
                                        ) : (
                                            <div className="space-y-1">
                                                {sectionItems.map(item => (
                                                    <div key={item.id} className="flex justify-between items-center p-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-xl transition-colors group">
                                                        <div className="flex flex-col">
                                                            <span className="font-medium text-slate-700 dark:text-slate-200">{item.name}</span>
                                                            <span className="text-[10px] text-slate-400">
                                                                {item.volume ? `${item.volume} ml rimanenti` : 'Volume non spec.'}
                                                            </span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            {/* Tasto Scala ML */}
                                                            <button 
                                                                onClick={() => setWithdrawingItem(item)}
                                                                className="p-1.5 rounded-lg bg-orange-50 dark:bg-orange-900/20 text-orange-500 hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-colors"
                                                                title="Preleva ML"
                                                            >
                                                                <Syringe size={14} />
                                                            </button>
                                                            
                                                            <span className="text-xs font-bold bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-slate-500">x{item.qty}</span>
                                                            
                                                            <button onClick={() => handleDeleteItem(item)} className="text-slate-300 group-hover:text-red-400 transition-colors"><Trash2 size={16}/></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}

                        {orphanedItems.length > 0 && (
                            <div className="bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 shadow-sm overflow-hidden opacity-80">
                                <div className="p-4 bg-slate-100 dark:bg-slate-800 border-b dark:border-slate-700 flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-slate-500">
                                        <Box size={20} />
                                    </div>
                                    <h3 className="font-bold text-lg text-slate-500">Generale / Non Categorizzati</h3>
                                </div>
                                <div className="p-2 space-y-1">
                                    {orphanedItems.map(item => (
                                        <div key={item.id} className="flex justify-between items-center p-3 rounded-xl border border-dashed border-slate-200 dark:border-slate-700">
                                            <span className="font-medium text-slate-600 dark:text-slate-400">{item.name}</span>
                                            <div className="flex items-center gap-3">
                                                <span className="text-xs font-bold bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-slate-500">x{item.qty}</span>
                                                <button onClick={() => handleDeleteItem(item)} className="text-slate-300 hover:text-red-400"><Trash2 size={16}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {sections.length === 0 && orphanedItems.length === 0 && (
                            <div className="text-center py-10">
                                <div className="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300">
                                    <Layers size={40} />
                                </div>
                                <p className="text-slate-400 font-bold">Il deposito è vuoto.</p>
                                <p className="text-slate-500 text-xs mt-1">Crea una sezione per iniziare.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const UserStatistics = ({ orders, currentUser, onBack }) => {
            const [monthlyBudget, setMonthlyBudget] = useState(0);
            const [isEditingBudget, setIsEditingBudget] = useState(false);

            // Carica Budget utente
            useEffect(() => {
                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'user_settings', currentUser);
                const unsub = onSnapshot(docRef, (s) => {
                    if (s.exists() && s.data().monthlyBudget) {
                        setMonthlyBudget(s.data().monthlyBudget);
                    }
                });
                return () => unsub();
            }, [currentUser]);

            const saveBudget = async () => {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'user_settings', currentUser), { 
                    monthlyBudget: parseFloat(monthlyBudget) || 0 
                }, { merge: true });
                setIsEditingBudget(false);
            };

            const stats = useMemo(() => {
                let totalSpent = 0;
                let itemsCount = 0;
                const typeCounts = {};
                const monthlySpending = {}; // Raggruppamento per mese
                
                orders.forEach(o => {
                    // Ottieni chiave Mese/Anno (es. 10/2023)
                    const [d, m, y] = o.date.split('/');
                    const monthKey = `${m}/${y}`;
                    
                    if (!monthlySpending[monthKey]) monthlySpending[monthKey] = 0;

                    (o.items || []).filter(i => i.person === currentUser).forEach(i => {
                        const price = parseFloat(i.price) || 0;
                        totalSpent += price;
                        monthlySpending[monthKey] += price; // Somma al mese
                        itemsCount++;
                        const type = i.vapeType || 'Altro';
                        typeCounts[type] = (typeCounts[type] || 0) + 1;
                    });
                });

                // Ordina i mesi dal più recente
                const sortedMonths = Object.entries(monthlySpending).sort((a, b) => {
                    const [ma, ya] = a[0].split('/');
                    const [mb, yb] = b[0].split('/');
                    return yb - ya || mb - ma;
                });

                return { totalSpent, itemsCount, typeCounts, sortedMonths };
            }, [orders, currentUser]);

            return (
                <div className="pb-20 animate-in p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><ArrowLeft/></button>
                        <h2 className="text-xl font-bold">Le tue Statistiche</h2>
                    </div>

                    {/* SEZIONE BUDGET */}
                    <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border dark:border-slate-700 shadow-sm mb-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold flex items-center gap-2 text-slate-700 dark:text-slate-200">
                                <PiggyBank className="text-emerald-500" size={20} /> Budget Mensile
                            </h3>
                            <button 
                                onClick={() => isEditingBudget ? saveBudget() : setIsEditingBudget(true)}
                                className="text-xs bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-lg font-bold text-slate-500 hover:text-emerald-500"
                            >
                                {isEditingBudget ? 'Salva' : 'Modifica'}
                            </button>
                        </div>

                        {isEditingBudget ? (
                            <div className="flex gap-2 items-center mb-4 animate-in fade-in">
                                <input 
                                    type="number" 
                                    autoFocus
                                    className="w-full bg-slate-50 dark:bg-slate-900 p-2 rounded-lg font-bold border dark:border-slate-600 outline-none"
                                    value={monthlyBudget}
                                    onChange={e => setMonthlyBudget(e.target.value)}
                                    placeholder="0"
                                />
                                <span className="font-bold text-slate-400">€</span>
                            </div>
                        ) : (
                             monthlyBudget === 0 ? (
                                <p className="text-sm text-slate-400 italic mb-4">Nessun budget impostato.</p>
                             ) : null
                        )}

                        <div className="space-y-4">
                            {stats.sortedMonths.map(([monthKey, spent]) => {
                                const [m, y] = monthKey.split('/');
                                const dateObj = new Date(y, m - 1);
                                const monthName = dateObj.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                                
                                const percentage = monthlyBudget > 0 ? Math.min((spent / monthlyBudget) * 100, 100) : 0;
                                let barColor = 'bg-emerald-500';
                                if (monthlyBudget > 0) {
                                    if (spent > monthlyBudget) barColor = 'bg-red-500';
                                    else if (spent > monthlyBudget * 0.8) barColor = 'bg-yellow-500';
                                }

                                return (
                                    <div key={monthKey}>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="capitalize font-medium text-slate-700 dark:text-slate-300">{monthName}</span>
                                            <span className={`font-bold ${spent > monthlyBudget && monthlyBudget > 0 ? 'text-red-500' : 'text-slate-600 dark:text-slate-400'}`}>
                                                €{spent.toFixed(2)} 
                                                {monthlyBudget > 0 && <span className="text-slate-400 font-normal"> / €{monthlyBudget}</span>}
                                            </span>
                                        </div>
                                        <div className="h-2.5 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                            <div className={`h-full ${barColor} transition-all duration-1000`} style={{width: monthlyBudget > 0 ? `${percentage}%` : '0%'}}></div>
                                        </div>
                                    </div>
                                );
                            })}
                            {stats.sortedMonths.length === 0 && <p className="text-center text-xs text-slate-400">Nessuna spesa registrata.</p>}
                        </div>
                    </div>
                    {/* FINE SEZIONE BUDGET */}

                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-blue-500 text-white p-5 rounded-2xl shadow-lg">
                            <p className="text-blue-100 text-sm mb-1">Spesa Totale</p>
                            <p className="text-3xl font-bold">€{stats.totalSpent.toFixed(2)}</p>
                        </div>
                        <div className="bg-indigo-500 text-white p-5 rounded-2xl shadow-lg">
                            <p className="text-indigo-100 text-sm mb-1">Articoli Presi</p>
                            <p className="text-3xl font-bold">{stats.itemsCount}</p>
                        </div>
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl border dark:border-slate-700">
                        <h3 className="font-bold mb-4">Preferenze di Svapo</h3>
                        <div className="space-y-3">
                            {Object.entries(stats.typeCounts).map(([type, count]) => (
                                <div key={type}>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span>{type}</span>
                                        <span className="font-bold">{count}</span>
                                    </div>
                                    <div className="h-2 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                        <div className="h-full bg-blue-500" style={{width: `${(count / stats.itemsCount) * 100}%`}}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ShoppingItem = ({ item, toggleBoughtStatus, updateItemPrice }) => {
            const [showOther, setShowOther] = useState(false);

            return (
                <div className="flex flex-col bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl text-sm border dark:border-slate-600 mb-2 shadow-sm">
                    <div className="flex justify-between items-center mb-3">
                         <span className="font-bold text-lg text-slate-800 dark:text-slate-100">{item.person}</span>
                         <button 
                            onClick={() => toggleBoughtStatus(item.orderId, item.id)} 
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${item.bought 
                                ? 'bg-emerald-500 text-white border-emerald-500 shadow-emerald-500/30 shadow-md' 
                                : 'bg-white dark:bg-slate-700 dark:text-white border-slate-300 dark:border-slate-500 hover:bg-slate-100 dark:hover:bg-slate-600'}`}
                        >
                            {item.bought ? <CheckSquare size={16}/> : <Square size={16}/>} {item.bought ? 'PRESO' : 'DA PRENDERE'}
                        </button>
                    </div>

                    {item.link && (
                        <div className="mb-3">
                            <a href={item.link} target="_blank" className="flex items-center gap-2 text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-2 rounded-lg font-bold w-full truncate border border-blue-100 dark:border-blue-900/50 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                <ExternalLink size={14} className="flex-shrink-0" /> 
                                <span className="truncate">{item.link}</span>
                            </a>
                        </div>
                    )}

                    <div className="flex flex-wrap gap-2 mb-2">
                        {item.liquidMl && (
                            <div className="bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 px-3 py-1.5 rounded-lg font-bold border border-blue-200 dark:border-blue-800 flex items-center gap-1">
                                <Droplets size={14} /> {item.liquidMl}ml
                            </div>
                        )}
                        {item.nicotineMl && (
                            <div className="bg-purple-100 dark:bg-purple-900/40 text-purple-800 dark:text-purple-200 px-3 py-1.5 rounded-lg font-bold border border-purple-200 dark:border-purple-800 flex items-center gap-1">
                                <Zap size={14} /> {item.nicotineMl}
                            </div>
                        )}
                        {item.vapeType && (
                            <div className="bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-200 px-3 py-1.5 rounded-lg font-bold border border-slate-300 dark:border-slate-500">
                                {item.vapeType}
                            </div>
                        )}
                    </div>
                    
                    {item.otherItems && (
                        <div className="mt-1">
                            <button 
                                onClick={() => setShowOther(!showOther)} 
                                className="text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 px-3 py-1.5 rounded-lg font-bold flex items-center gap-2 border border-orange-200 dark:border-orange-800 hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors w-full md:w-auto justify-center md:justify-start"
                            >
                                <Sparkles size={14}/> {showOther ? 'Nascondi Altro' : 'Vedi Altro'} {showOther ? <ChevronDown size={14} className="rotate-180"/> : <ChevronDown size={14}/>}
                            </button>
                            {showOther && (
                                <div className="mt-2 p-3 bg-orange-50 dark:bg-orange-900/10 border border-orange-100 dark:border-orange-900/30 rounded-lg text-sm text-orange-900 dark:text-orange-100 animate-in fade-in slide-in-from-top-2">
                                    <p className="font-bold mb-1 text-xs uppercase opacity-70">Note aggiuntive:</p>
                                    {item.otherItems}
                                </div>
                            )}
                        </div>
                    )}

                    <div className="mt-3 pt-3 border-t dark:border-slate-600 flex justify-end items-center gap-2">
                        <label className="text-xs font-bold text-slate-400 uppercase">Prezzo (€)</label>
                        <input 
                            type="number" 
                            step="0.01" 
                            inputMode="decimal"
                            className="w-24 bg-white dark:bg-slate-900 border dark:border-slate-500 rounded-lg px-2 py-1.5 text-right font-mono font-bold text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" 
                            value={item.price} 
                            onChange={(e) => updateItemPrice(item.orderId, item.id, e.target.value)} 
                        />
                    </div>
                </div>
            );
        };

        const MonthlyReport = ({ orders, currentUser, onBack }) => {
            const data = useMemo(() => {
                const groups = {};
                orders.forEach(order => {
                    const [day, month, year] = order.date.split('/');
                    const key = `${month}/${year}`;
                    if(!groups[key]) groups[key] = { total: 0, items: [] };
                    
                    (order.items || []).forEach(item => {
                        if(item.person === currentUser) {
                            groups[key].total += (parseFloat(item.price) || 0);
                            groups[key].items.push({...item, date: order.date, title: order.title});
                        }
                    });
                });
                return Object.entries(groups).sort((a,b) => {
                    const [ma, ya] = a[0].split('/');
                    const [mb, yb] = b[0].split('/');
                    return yb - ya || mb - ma;
                });
            }, [orders, currentUser]);

            return (
                <div className="pb-20 animate-in p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><ArrowLeft/></button>
                        <h2 className="text-xl font-bold">Resoconto Mensile</h2>
                    </div>
                    <div className="space-y-4">
                        {data.length === 0 && <p className="text-center text-slate-400 mt-10">Nessuna spesa registrata.</p>}
                        {data.map(([date, info]) => (
                            <div key={date} className="bg-white dark:bg-slate-800 p-5 rounded-2xl border dark:border-slate-700 shadow-sm">
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-bold text-lg capitalize">{new Date(date.split('/').reverse().join('-')).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}</h3>
                                    <span className="bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-3 py-1 rounded-lg font-bold">€{info.total.toFixed(2)}</span>
                                </div>
                                <div className="text-sm text-slate-500 dark:text-slate-400">{info.items.length} acquisti</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const OrderArchive = ({ orders, currentUser, isManager, onBack, onDelete, onReset, onClickOrder, onSaveTracking }) => {
            return (
                <div className="pb-20 animate-in p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><ArrowLeft/></button>
                        <h2 className="text-xl font-bold">Storico Ordini</h2>
                    </div>
                    
                    {orders.length === 0 && <p className="text-center text-slate-400 mt-10">Nessun ordine nello storico.</p>}

                    <div className="space-y-6">
                        {orders.map(([monthYear, monthOrders]) => (
                            <div key={monthYear}>
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-3 pl-1 sticky top-0 bg-white/95 dark:bg-slate-900/95 py-2 z-10">
                                    {new Date(monthYear.split('/').reverse().join('-')).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}
                                </h3>
                                <div className="space-y-3">
                                    {monthOrders.map(order => (
                                        <OrderCard 
                                            key={order.id} 
                                            order={order} 
                                            currentUser={currentUser}
                                            onClick={onClickOrder}
                                            onDelete={isManager || order.creator === currentUser ? onDelete : undefined}
                                            onReset={isManager ? onReset : undefined}
                                            isManager={isManager}
                                            onSaveTracking={onSaveTracking} // Passaggio funzione tracking
                                        />
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const OrderCard = ({ order, currentUser, onClick, onDelete, onReset, isManager, onSaveTracking }) => {
            const myCount = (order.items || []).filter(i => i.person === currentUser).length;
            const isCreator = order.creator === currentUser;

            return (
                <div 
                    onClick={() => onClick(order.id)}
                    className="bg-white dark:bg-slate-900 border dark:border-slate-700 p-4 rounded-2xl shadow-sm mb-3 flex flex-col gap-3 cursor-pointer active:scale-[0.99] transition-transform hover:shadow-md group relative"
                >
                     <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 rounded-2xl flex items-center justify-center flex-shrink-0 group-hover:bg-indigo-100 dark:group-hover:bg-indigo-900/40 transition-colors">
                            <ShoppingBag size={22} />
                        </div>
                        <div className="min-w-0 flex-1">
                            <h3 className="font-bold text-slate-900 dark:text-white leading-tight truncate group-hover:text-blue-600 transition-colors">{order.title}</h3>
                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">I tuoi articoli: <span className="font-bold">{myCount}</span></p>
                        </div>
                        
                        <div className="flex items-center gap-2 flex-shrink-0">
                            {/* --- TASTO TRACKING --- */}
                            {isManager ? (
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onSaveTracking(order); }}
                                    className={`w-10 h-10 flex items-center justify-center rounded-xl transition-colors border ${order.tracking ? 'bg-blue-100 dark:bg-blue-900/40 text-blue-600 border-blue-200 dark:border-blue-800' : 'bg-slate-50 dark:bg-slate-800 text-slate-400 border-slate-100 dark:border-slate-700 hover:text-blue-500'}`}
                                    title="Modifica Tracking"
                                >
                                    <Truck size={18} />
                                </button>
                            ) : (
                                order.tracking && (
                                    <a 
                                        href={order.tracking.startsWith('http') ? order.tracking : '#'}
                                        onClick={(e) => { 
                                            e.stopPropagation(); 
                                            if(!order.tracking.startsWith('http')) alert("Codice Spedizione: " + order.tracking); 
                                        }}
                                        target="_blank"
                                        className="w-10 h-10 flex items-center justify-center bg-blue-100 dark:bg-blue-900/40 text-blue-600 rounded-xl hover:bg-blue-200 dark:hover:bg-blue-900/60 transition-colors border border-blue-200 dark:border-blue-800 animate-in zoom-in"
                                        title="Traccia Pacco"
                                    >
                                        <Truck size={18} />
                                    </a>
                                )
                            )}
                            {/* ---------------------- */}

                            {isManager && onReset && (
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onReset(order.id); }}
                                    className="w-10 h-10 flex items-center justify-center bg-orange-50 dark:bg-orange-900/20 text-orange-500 rounded-xl hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-colors border border-orange-100 dark:border-orange-900/30"
                                    title="Reset / Rifai Ordine"
                                >
                                    <RefreshCcw size={18} />
                                </button>
                            )}

                            {(isManager || isCreator) && onDelete && (
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onDelete(order.id); }}
                                    className="w-10 h-10 flex items-center justify-center bg-red-50 dark:bg-red-900/20 text-red-500 rounded-xl hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors border border-red-100 dark:border-red-900/30"
                                    title="Elimina Ordine"
                                >
                                    <Trash2 size={18} />
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Mostra codice se presente e utente non manager per chiarezza */}
                    {!isManager && order.tracking && !order.tracking.startsWith('http') && (
                        <div className="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg text-xs text-blue-600 dark:text-blue-300 font-mono text-center">
                            Codice: {order.tracking}
                        </div>
                    )}
                </div>
            );
        }

        const OrderDetail = ({ order, users, currentUser, isManager, onBack, onAdd, onRemove, onDelete, onUpdateStatus, currentPricing, allOrders }) => {
            const [person, setPerson] = useState(currentUser || (users && users.length > 0 ? users[0] : ''));
            const [link, setLink] = useState('');
            const [liquidMl, setLiquidMl] = useState('');
            const [nicotineMl, setNicotineMl] = useState('');
            const [vapeType, setVapeType] = useState('Guanciale');
            const [otherItems, setOtherItems] = useState('');
            const [extraCost, setExtraCost] = useState(''); 
            const [customAromaPrice, setCustomAromaPrice] = useState(currentPricing.defaultAromaPrice);
            
            // --- NUOVO STATO PER DIVISIONE SPEDIZIONE ---
            const [shippingCost, setShippingCost] = useState('');
            const [showShippingSplitter, setShowShippingSplitter] = useState(false);
            // -------------------------------------------

            const estimatedPrice = useMemo(() => {
                const ml = parseFloat(liquidMl) || 0;
                const nic = parseFloat(nicotineMl) || 0;
                const extra = parseFloat(extraCost) || 0;
                const aromaP = parseFloat(customAromaPrice) || currentPricing.defaultAromaPrice;

                if (ml === 0) return 0; 

                const nicBottles = (ml * nic) / currentPricing.nicotineBottleMg;
                const costNic = nicBottles * currentPricing.nicotineBottlePrice;
                const costAroma = aromaP;
                const volNic = nicBottles * currentPricing.nicotineBottleVol;
                const volBase = ml - currentPricing.aromaVol - volNic;
                const costBase = volBase > 0 ? volBase * currentPricing.basePricePerMl : 0;

                return costNic + costAroma + costBase + extra;
            }, [liquidMl, nicotineMl, extraCost, customAromaPrice, currentPricing]);

            if (!order) return (
                 <div className="pb-20 animate-in p-4">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400"><ArrowLeft /></button>
                        
                        {(isManager || (order && order.creator === currentUser)) && (
                            <button 
                                onClick={() => onDelete(order.id)} 
                                className="p-2 bg-red-50 text-red-500 rounded-full hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/40"
                                title="Elimina intero ordine"
                            >
                                <Trash2 size={20} />
                            </button>
                        )}
                    </div>
                    <div className="p-10 text-center text-slate-400">
                        <p>Ordine non trovato o in caricamento...</p>
                    </div>
                </div>
            );
            
            const visibleItems = isManager ? (order.items || []) : (order.items || []).filter(i => i.person === currentUser);
            const isCreator = order.creator === currentUser;

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!link.trim() && !otherItems.trim()) return alert("Inserisci un link o altro acquisto.");
                
                onAdd(order.id, { 
                    person, 
                    link, 
                    aroma: '', 
                    liquidMl, 
                    nicotineMl, 
                    vapeType, 
                    otherItems, 
                    price: Math.ceil(estimatedPrice), 
                    userConfirmedPayment: false 
                });
                
                setLink(''); setLiquidMl(''); setNicotineMl(''); setOtherItems(''); setExtraCost(''); setCustomAromaPrice(currentPricing.defaultAromaPrice);
            };

            const handleSendOrder = () => {
                alert("Ordine inviato correttamente!"); 
                onBack();
            };

            // --- NUOVA LOGICA DIVISIONE SPESE ---
            const handleSplitShipping = () => {
                const cost = parseFloat(shippingCost);
                if (!cost || isNaN(cost) || cost <= 0) return alert("Inserisci un costo valido");

                // Trova gli utenti unici che hanno partecipato a questo ordine
                const uniqueParticipants = [...new Set((order.items || []).map(i => i.person))];
                
                if (uniqueParticipants.length === 0) return alert("Nessun partecipante in questo ordine.");

                const costPerPerson = cost / uniqueParticipants.length;

                uniqueParticipants.forEach(p => {
                    onAdd(order.id, {
                        person: p,
                        link: '',
                        otherItems: 'Quota Spedizione', // Voce speciale
                        liquidMl: '',
                        nicotineMl: '',
                        vapeType: '',
                        price: costPerPerson, // Prezzo calcolato (sarà formattato automaticamente)
                        userConfirmedPayment: false,
                        paid: false,
                        bought: true // La spedizione si considera "presa" subito
                    });
                });

                setShippingCost('');
                setShowShippingSplitter(false);
            };
            // -----------------------------------

            const itemsByPerson = isManager 
                ? (order.items || []).reduce((acc, item) => { if(!acc[item.person]) acc[item.person] = []; acc[item.person].push(item); return acc; }, {}) 
                : { [currentUser]: visibleItems };

            const calculateRecipe = (totalMlStr, nicTargetStr, type) => {
                const totalMl = parseFloat(totalMlStr) || 0;
                const targetNic = parseFloat(nicTargetStr) || 0;
                if(totalMl === 0) return null;

                const nicStrength = 20; // Default basetta
                // MTL 10% aroma, DL 12%
                const aromaPct = type === 'Guanciale' ? 10 : 12; 
                
                const aromaMl = (totalMl * aromaPct) / 100;
                const nicMl = (totalMl * targetNic) / nicStrength;
                const baseMl = totalMl - aromaMl - nicMl;
                
                return { baseMl, nicMl, aromaMl, aromaPct };
            }

            return (
                <div className="pb-20 animate-in">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400"><ArrowLeft /></button>
                        
                        {(isManager || isCreator) && (
                            <button 
                                onClick={() => onDelete(order.id)} 
                                className="p-2 bg-red-50 text-red-500 rounded-full hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/40"
                                title="Elimina intero ordine"
                            >
                                <Trash2 size={20} />
                            </button>
                        )}
                    </div>
                    <div className="bg-slate-800 dark:bg-black text-white p-5 rounded-2xl shadow-lg mb-6"><h2 className="text-xl font-bold">{order.title}</h2><p className="text-slate-400 text-sm mt-1">{order.date}</p></div>
                    
                    {/* --- TOOL DIVISIONE SPESE (VISIBILE SOLO AL GESTORE) --- */}
                    {isManager && (order.items || []).length > 0 && (
                        <div className="mb-6">
                            {!showShippingSplitter ? (
                                <button 
                                    onClick={() => setShowShippingSplitter(true)}
                                    className="w-full py-3 border-2 border-dashed border-indigo-200 dark:border-indigo-900/50 text-indigo-500 rounded-xl font-bold text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors flex items-center justify-center gap-2"
                                >
                                    <Truck size={18} /> Dividi Spese Spedizione
                                </button>
                            ) : (
                                <div className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-2xl border border-indigo-100 dark:border-indigo-900/50 animate-in fade-in">
                                    <h3 className="font-bold text-indigo-900 dark:text-indigo-200 mb-2 text-sm flex items-center gap-2"><Truck size={16}/> Divisione Spese</h3>
                                    <p className="text-xs text-indigo-700 dark:text-indigo-300 mb-3">
                                        Il costo verrà diviso tra i <strong>{[...new Set((order.items || []).map(i => i.person))].length}</strong> partecipanti attuali.
                                    </p>
                                    <div className="flex gap-2">
                                        <input 
                                            autoFocus
                                            type="number" 
                                            placeholder="Costo Totale (€)" 
                                            className="flex-1 px-3 py-2 rounded-lg border border-indigo-200 dark:border-indigo-800 dark:bg-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500"
                                            value={shippingCost}
                                            onChange={e => setShippingCost(e.target.value)}
                                        />
                                        <button 
                                            onClick={handleSplitShipping}
                                            className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md"
                                        >
                                            Applica
                                        </button>
                                        <button 
                                            onClick={() => setShowShippingSplitter(false)}
                                            className="bg-white dark:bg-slate-700 text-slate-500 px-3 py-2 rounded-lg font-bold text-sm border dark:border-slate-600"
                                        >
                                            X
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {/* ------------------------------------------------------- */}

                    {!isManager && (
                        <div className="bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-2xl mb-8">
                             <div className="flex justify-between items-center mb-3">
                                 <h3 className="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase flex items-center gap-2"><Plus size={16}/> Aggiungi Articolo</h3>
                                 <div className="flex gap-2">
                                     {estimatedPrice > 0 && (
                                       <span className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 px-3 py-1 rounded-lg text-xs font-bold animate-in fade-in">
                                             ~€{estimatedPrice.toFixed(2)}
                                       </span>
                                     )}
                                 </div>
                             </div>
                            <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                                <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Chi</label>
                                    <select className="w-full px-3 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl" value={person} onChange={e => setPerson(e.target.value)} disabled={!isManager}>{users.map(u => <option key={u} value={u}>{u}</option>)}</select>
                                </div>
                                <div className="space-y-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Link</label>
                                    <input type="url" placeholder="Incolla Link..." className="w-full px-4 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl text-sm" value={link} onChange={e => setLink(e.target.value)} />
                                </div>
                                <div className="flex gap-2">
                                    <div className="space-y-2 flex-1"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Specifiche</label>
                                        <div className="flex gap-2"><div className="relative flex-1"><input type="number" inputMode="numeric" placeholder="ml Liq" className="w-full px-3 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl" value={liquidMl} onChange={e => setLiquidMl(e.target.value)} /></div><div className="relative flex-1"><input type="number" inputMode="decimal" placeholder="Nicotina" className="w-full px-3 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl" value={nicotineMl} onChange={e => setNicotineMl(e.target.value)} /></div></div>
                                    </div>
                                    <div className="space-y-2 w-1/3"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Costo Aroma (€)</label>
                                        <input type="number" step="0.01" inputMode="decimal" placeholder={currentPricing.defaultAromaPrice.toFixed(2)} className="w-full px-3 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl" value={customAromaPrice} onChange={e => setCustomAromaPrice(e.target.value)} />
                                    </div>
                                </div>
                                <div className="flex bg-white dark:bg-slate-700 rounded-xl border dark:border-slate-600 p-1">{['Guanciale', 'Polmonare'].map(t => <button key={t} type="button" onClick={() => setVapeType(t)} className={`flex-1 rounded-lg text-xs font-medium py-2 ${vapeType === t ? 'bg-slate-800 text-white' : 'text-slate-500 dark:text-slate-400'}`}>{t}</button>)}</div>
                                <div className="space-y-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Altro & Extra</label>
                                    <div className="flex gap-2">
                                        <textarea rows="1" placeholder="Es. Cotone..." className="flex-1 px-4 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl text-sm" value={otherItems} onChange={e => setOtherItems(e.target.value)} />
                                        <input type="number" inputMode="decimal" placeholder="Costo Aggiunte (€)" className="w-1/3 px-3 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl text-sm" value={extraCost} onChange={e => setExtraCost(e.target.value)} />
                                    </div>
                                </div>
                                <button type="submit" className="bg-blue-600 text-white px-6 py-3 rounded-xl shadow-lg font-bold gap-2 mt-2 flex justify-center items-center"><Plus size={20} /> AGGIUNGI</button>
                            </form>
                        </div>
                    )}

                    <div className="space-y-6">
                        {!isManager && (visibleItems.length > 0) && (
                            <h3 className="text-lg font-bold text-slate-800 dark:text-white px-1">I tuoi articoli inseriti:</h3>
                        )}

                        {Object.entries(itemsByPerson).map(([pName, pItems]) => (
                            <div key={pName} className="border-b dark:border-slate-800 pb-4 last:border-0">
                                {isManager && (
                                    <div className="flex justify-between items-center mb-3 px-1 sticky top-0 bg-white/95 dark:bg-slate-900/95 py-2 z-10">
                                        <h3 className="font-bold text-lg text-slate-800 dark:text-slate-200">{pName}</h3>
                                        <span className="text-xs bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">{pItems.length} articoli</span>
                                    </div>
                                )}
                                <div className="space-y-2">
                                    {pItems.slice().reverse().map((item) => {
                                        const recipe = isManager && item.liquidMl ? calculateRecipe(item.liquidMl, item.nicotineMl, item.vapeType) : null;

                                        return (
                                            <div key={item.id} className="p-3 md:p-4 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm transition hover:shadow-md">
                                                {isManager ? (
                                                    <div className="space-y-3">
                                                        <div className="flex justify-between items-start">
                                                            <div className="min-w-0">
                                                                {item.link ? 
                                                                    <a href={item.link} target="_blank" className="font-bold text-blue-600 dark:text-blue-400 truncate block hover:underline text-sm">{item.link}</a> : 
                                                                    <p className="font-bold text-slate-800 dark:text-white truncate text-sm">Oggetto manuale</p>
                                                                }
                                                                {item.otherItems && <p className="text-xs text-orange-500 font-medium flex items-center gap-1 mt-1"><Sparkles size={10} /> {item.otherItems}</p>}
                                                            </div>
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); onRemove(order.id, item.id); }} 
                                                                className="text-slate-300 hover:text-red-500 p-1"
                                                            >
                                                                <X size={16} />
                                                            </button>
                                                        </div>

                                                        {recipe && (
                                                            <div className="bg-slate-50 dark:bg-slate-700/30 rounded-lg p-3 border border-slate-100 dark:border-slate-700">
                                                                <div className="flex justify-between items-center mb-2 border-b dark:border-slate-700/50 pb-1">
                                                                    <span className="text-xs font-bold uppercase text-slate-400">Target: {item.liquidMl}ml @ {item.nicotineMl}mg ({item.vapeType})</span>
                                                                </div>
                                                                <div className="grid grid-cols-2 gap-2 text-sm">
                                                                    <div className="flex flex-col">
                                                                        <span className="text-[10px] text-purple-500 font-bold uppercase">Nicotina (20mg)</span>
                                                                        <span className="font-bold dark:text-white">{recipe.nicMl.toFixed(1)} ml</span>
                                                                        <span className="text-[10px] text-slate-400">~ {(recipe.nicMl / 10).toFixed(1)} boccette</span>
                                                                    </div>
                                                                    <div className="flex flex-col">
                                                                        <span className="text-[10px] text-blue-500 font-bold uppercase">Base + Aroma</span>
                                                                        <span className="font-bold dark:text-white">{(recipe.baseMl + recipe.aromaMl).toFixed(1)} ml</span>
                                                                        <span className="text-[10px] text-slate-400">Di cui aroma ~{recipe.aromaMl.toFixed(1)}ml</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}
                                                        {!recipe && !item.otherItems && <p className="text-xs text-slate-400 italic">Nessuna specifica di liquido.</p>}
                                                    </div>
                                                ) : (
                                                    <div className="flex justify-between items-center">
                                                        <div className="min-w-0 flex-1 pr-3">
                                                            {item.link ? <a href={item.link} target="_blank" className="font-bold text-blue-600 dark:text-blue-400 truncate block flex items-center gap-1"><LinkIcon size={12} /> Link Prodotto</a> : <p className="font-bold text-slate-800 dark:text-white">Oggetto manuale</p>}
                                                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">{item.liquidMl}ml • {item.nicotineMl}nic • {item.vapeType}</p>
                                                            {item.otherItems && <p className="text-xs text-orange-500 font-medium mt-1"><Sparkles size={10} inline /> {item.otherItems}</p>}
                                                        </div>
                                                        
                                                        <div className="flex flex-col items-end gap-2">
                                                            {!item.paid ? (
                                                                item.userConfirmedPayment ? (
                                                                    <span className="text-[10px] font-bold text-orange-500 bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded-lg">In attesa conferma</span>
                                                                ) : (
                                                                    <button 
                                                                        onClick={() => onUpdateStatus(order.id, item.id, 'userConfirmedPayment', true)}
                                                                        className="flex items-center gap-1 bg-emerald-500 text-white text-[10px] font-bold px-2 py-1.5 rounded-lg shadow hover:bg-emerald-600"
                                                                    >
                                                                        <CheckCircle2 size={12}/> Ho Pagato
                                                                    </button>
                                                                )
                                                            ) : (
                                                                <span className="text-[10px] font-bold text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-1 rounded-lg">Pagato</span>
                                                            )}

                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); onRemove(order.id, item.id); }} 
                                                                className="text-slate-300 hover:text-red-500 p-1"
                                                            >
                                                                <X size={16} />
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                    )})}
                                </div>
                            </div>
                        ))}
                    </div>

                    {!isManager && (
                        <div className="mt-8 pt-6 border-t dark:border-slate-800">
                            <button 
                                onClick={handleSendOrder}
                                className="w-full bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-emerald-200 dark:shadow-emerald-900/20 flex items-center justify-center gap-2 hover:bg-emerald-600 active:scale-95 transition-transform"
                            >
                                <Send size={20} />
                                CONFERMA E INVIA ORDINE
                            </button>
                            <p className="text-center text-xs text-slate-400 mt-2">L'ordine verrà salvato e potrai vederlo nella lista principale.</p>
                        </div>
                    )}
                </div>
            );
        };

        const OrderManager = () => {
            const [users, setUsers] = useState(['Gestore']);
            const [orders, setOrders] = useState([]);
            const [paymentRequests, setPaymentRequests] = useState({});
            const [pricing, setPricing] = useState(DEFAULT_PRICING); 
            const [notices, setNotices] = useState([]); 
            const [quickLinks, setQuickLinks] = useState([{ name: 'Svapoebasta', url: 'https://www.svapoebasta.com/' }]); 

            // --- NUOVI STATI PER GESTIONE TRACKING ---
            const [isTrackingModalOpen, setIsTrackingModalOpen] = useState(false);
            const [trackingOrderId, setTrackingOrderId] = useState(null);
            const [trackingInitialValue, setTrackingInitialValue] = useState('');
            // -----------------------------------------

            const [isAddingLink, setIsAddingLink] = useState(false);
            const [newLinkName, setNewLinkName] = useState('');
            const [newLinkUrl, setNewLinkUrl] = useState('');

            const [currentUser, setCurrentUser] = useState(null);
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [connectionError, setConnectionError] = useState(null); 
            const [showWelcome, setShowWelcome] = useState(false);
            
            const [isLoggingInAsManager, setIsLoggingInAsManager] = useState(false);
            const [managerPassword, setManagerPassword] = useState('');
            const [loginError, setLoginError] = useState('');
            
            const [view, setView] = useState('dashboard');
            const [activeOrderId, setActiveOrderId] = useState(null);
            const [newUserName, setNewUserName] = useState('');
            const [isAddingUser, setIsAddingUser] = useState(false);
            const [isProfileMenuOpen, setIsProfileMenuOpen] = useState(false);
            const [isPricingModalOpen, setIsPricingModalOpen] = useState(false);
            
            const [favModalOpen, setFavModalOpen] = useState(false);
            const [itemToFav, setItemToFav] = useState(null);

            const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', message: '', onConfirm: null, isDanger: false, confirmText: 'Conferma' });

            const [theme, setTheme] = useTheme();

            const profileMenuRef = useRef(null);
            
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (profileMenuRef.current && !profileMenuRef.current.contains(event.target)) {
                        setIsProfileMenuOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const showConfirm = (title, message, onConfirm, isDanger = false, confirmText = "Conferma") => {
                setModalConfig({ isOpen: true, title, message, onConfirm: () => { onConfirm(); setModalConfig(prev => ({...prev, isOpen: false})); }, onCancel: () => setModalConfig(prev => ({...prev, isOpen: false})), isDanger, confirmText });
            };

            const showInfo = (title, message) => {
                setModalConfig({ isOpen: true, title, message, onConfirm: () => setModalConfig(prev => ({...prev, isOpen: false})), onCancel: () => setModalConfig(prev => ({...prev, isOpen: false})), isDanger: false, confirmText: 'OK' });
            };

            useEffect(() => {
                if (!isConfigured) return;

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.warn("Custom token auth failed, trying anonymous:", err);
                        try {
                            await signInAnonymously(auth);
                        } catch (anonErr) {
                            console.error("Anonymous auth failed:", anonErr);
                            setConnectionError(anonErr.message);
                        }
                    }
                };
                
                const timer = setTimeout(() => {
                    if (!auth.currentUser) {
                        setConnectionError("Timeout: La connessione sta impiegando troppo tempo.");
                    }
                }, 10000);

                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        clearTimeout(timer);
                        setFirebaseUser(user);
                    }
                });
                return () => {
                    unsubscribe();
                    clearTimeout(timer);
                };
            }, []);

            useEffect(() => {
                const savedUser = localStorage.getItem('svapo_last_user');
                if (savedUser) {
                    setCurrentUser(savedUser); 
                    setShowWelcome(true);       
                    setTimeout(() => {
                        setView('dashboard');
                        setShowWelcome(false); 
                    }, 2000); 
                }
            }, []);

            useEffect(() => {
                if (!firebaseUser) return;
                
                try {
                    const qOrders = collection(db, 'artifacts', APP_ID, 'public', 'data', 'orders');
                    const unsubOrders = onSnapshot(qOrders, (snapshot) => {
                        const loadedOrders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        loadedOrders.sort((a, b) => b.id - a.id);
                        setOrders(loadedOrders);
                    }, (err) => {
                        console.error("Orders Listener Error:", err);
                        if (err.code === 'permission-denied') {
                             setConnectionError("Errore permessi: Riprova a ricaricare la pagina.");
                        } else {
                             setConnectionError("Errore lettura ordini: " + err.message);
                        }
                    });

                    const docSettings = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global');
                    const unsubSettings = onSnapshot(docSettings, (snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.data();
                            if (data.users) setUsers(data.users);
                            if (data.paymentRequests) setPaymentRequests(data.paymentRequests);
                            if (data.pricing) setPricing(data.pricing);
                            if (data.quickLinks) setQuickLinks(data.quickLinks); // LOAD LINKS
                            
                            // LOAD NOTICES
                            if (data.notices) {
                                setNotices(data.notices);
                            } else if (data.noticeMessage) {
                                setNotices([{ id: 1, text: data.noticeMessage, date: 'Precedente', active: true }]);
                            } else {
                                setNotices([]);
                            }
                        } else {
                            // Initial setup with Svapoebasta
                            setDoc(docSettings, { 
                                users: ['Gestore'], 
                                paymentRequests: {}, 
                                pricing: DEFAULT_PRICING, 
                                notices: [],
                                quickLinks: [{ name: 'Svapoebasta', url: 'https://www.svapoebasta.com/' }]
                            }, { merge: true });
                        }
                    }, (err) => {
                        console.error("Settings Listener Error:", err);
                    });
                    
                    return () => { unsubOrders(); unsubSettings(); };
                } catch (e) {
                    console.error("Setup Listeners Failed:", e);
                }
            }, [firebaseUser]);

            const isManager = currentUser === 'Gestore';

            const getDaysAgo = (dateStr) => {
                const [day, month, year] = dateStr.split('/').map(Number);
                const orderDate = new Date(year, month - 1, day);
                const today = new Date();
                const diffTime = Math.abs(today - orderDate);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            };

            const { activeOrders, archivedOrdersList } = useMemo(() => {
                const threshold = 7; // Fixed 7 days for everyone
                const filterVisible = (o) => {
                    if (isManager) return true;
                    return (o.creator === 'Gestore' || !o.creator || o.creator === currentUser);
                };

                const visibleOrders = orders.filter(filterVisible);

                return {
                    activeOrders: visibleOrders.filter(o => getDaysAgo(o.date) <= threshold),
                    archivedOrdersList: visibleOrders.filter(o => getDaysAgo(o.date) > threshold)
                };
            }, [orders, isManager, currentUser]);

             const groupOrdersByMonth = (ordersToGroup) => {
                const grouped = {};
                ordersToGroup.forEach(order => {
                    const [day, month, year] = order.date.split('/');
                    const key = `${month}/${year}`;
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(order);
                });
                return Object.entries(grouped).sort((a, b) => {
                    const [ma, ya] = a[0].split('/');
                    const [mb, yb] = b[0].split('/');
                    if (ya !== yb) return yb - ya;
                    return mb - ma;
                });
            };

            const groupOrdersByDate = (ordersToGroup) => {
                const grouped = {};
                ordersToGroup.forEach(order => {
                    if (!grouped[order.date]) grouped[order.date] = [];
                    grouped[order.date].push(order);
                });
                return Object.entries(grouped).sort((a, b) => {
                    const [da, ma, ya] = a[0].split('/').map(Number);
                    const [db, mb, yb] = b[0].split('/').map(Number);
                    const dateA = new Date(ya, ma - 1, da);
                    const dateB = new Date(yb, mb - 1, db);
                    return dateB - dateA;
                });
            }

            const groupedActiveOrders = useMemo(() => groupOrdersByMonth(activeOrders), [activeOrders]);
            const groupedArchivedOrders = useMemo(() => groupOrdersByMonth(archivedOrdersList), [archivedOrdersList]);
            
            const groupedActiveOrdersByDate = useMemo(() => groupOrdersByDate(activeOrders), [activeOrders]);
            
            const userStats = useMemo(() => {
                if (!currentUser || isManager) return null;
                const myItems = orders.flatMap(o => (o.items || []).map(i => ({...i, date: o.date, orderTitle: o.title, orderId: o.id})))
                                        .filter(i => i.person === currentUser);
                const totalItems = myItems.length;
                const pendingItems = myItems.filter(i => !i.paid).length;
                
                let totalDebt = 0;
                let pendingConfirmationDebt = 0;

                myItems.forEach(item => {
                    if (!item.paid) {
                        const price = parseFloat(item.price) || 0;
                        if (item.userConfirmedPayment) {
                            pendingConfirmationDebt += price;
                        } else {
                            totalDebt += price;
                        }
                    }
                });
                
                const itemsToPay = myItems.filter(i => !i.paid && !i.userConfirmedPayment).length;

                return { totalItems, pendingItems, myItems, totalDebt, pendingConfirmationDebt, itemsToPay };
            }, [orders, currentUser, isManager]);

            const managerStats = useMemo(() => {
                if (!isManager) return null;
                let totalCredits = 0;
                let totalCollected = 0;
                const pendingByUser = {};
                const lastOrderItemsByUser = {};

                orders.forEach(order => {
                    (order.items || []).forEach(item => {
                        const price = parseFloat(item.price) || 0;
                        if (item.paid) totalCollected += price;
                        else totalCredits += price;

                        if (item.userConfirmedPayment && !item.paid) {
                            if (!pendingByUser[item.person]) pendingByUser[item.person] = { total: 0, items: [] };
                            pendingByUser[item.person].total += price;
                            pendingByUser[item.person].items.push({ ...item, orderId: order.id });
                        }

                        if (item.bought) {
                            if (!lastOrderItemsByUser[item.person]) lastOrderItemsByUser[item.person] = [];
                            lastOrderItemsByUser[item.person].push({ ...item, orderTitle: order.title });
                        }
                    });
                });
                return { totalCredits, totalCollected, pendingByUser, lastOrderItemsByUser };
            }, [orders, isManager]);

            const shoppingList = useMemo(() => {
                const allItems = orders.flatMap(order => 
                    (order.items || []).map(item => ({ ...item, orderId: order.id, orderTitle: order.title }))
                );
                const grouped = {};
                allItems.forEach(item => {
                    const key = item.link ? item.link.trim() : `nolink-${item.id}`;
                    if (!grouped[key]) grouped[key] = { link: item.link, count: 0, items: [], allBought: true };
                    grouped[key].count += 1;
                    grouped[key].items.push(item);
                    if (!item.bought) grouped[key].allBought = false;
                });
                return Object.values(grouped).sort((a, b) => {
                    if (a.allBought === b.allBought) return 0;
                    return a.allBought ? 1 : -1; 
                });
            }, [orders]);

            const initiateLogin = (user) => {
                if (user === 'Gestore') {
                    setIsLoggingInAsManager(true); setManagerPassword(''); setLoginError('');
                } else {
                    localStorage.setItem('svapo_last_user', user);
                    setCurrentUser(user);
                    setShowWelcome(true); 
                    setTimeout(() => {
                        setView('dashboard');
                        setShowWelcome(false); 
                    }, 2000); 
                }
            };

            const submitManagerLogin = (e) => {
                e.preventDefault();
                if (managerPassword === '1234') {
                    localStorage.setItem('svapo_last_user', 'Gestore');
                    setCurrentUser('Gestore'); 
                    setIsLoggingInAsManager(false);
                    setShowWelcome(true);

                    setTimeout(() => {
                        setView('dashboard');
                        setShowWelcome(false);
                    }, 2000);
                } else {
                    setLoginError('Password errata'); setManagerPassword('');
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('svapo_last_user');
                setCurrentUser(null);
            };

            const addUser = async (e) => {
                e.preventDefault();
                const name = newUserName.trim();
                if(name && !users.includes(name)) {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { users: arrayUnion(name) }, {merge: true});
                    setNewUserName(''); setIsAddingUser(false);
                }
            };

            const deleteUser = (userToDelete) => {
                if (userToDelete === 'Gestore') return showInfo("Impossibile", "Non puoi eliminare il Gestore.");
                
                showConfirm(
                    "Elimina Utente", 
                    `Sei sicuro di voler eliminare definitivamente l'utente "${userToDelete}"?`, 
                    async () => {
                        const newUsersList = users.filter(u => u !== userToDelete);
                        try {
                            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { 
                                users: newUsersList 
                            }, {merge: true});
                        } catch (error) {
                            showInfo("Errore", error.message);
                        }
                    },
                    true, 
                    "Elimina"
                );
            };

            const savePricing = async (newPricing) => {
                try {
                     await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { 
                        pricing: newPricing
                    }, {merge: true});
                    setPricing(newPricing);
                    setIsPricingModalOpen(false);
                    showInfo("Salvato", "Prezzi aggiornati per tutti gli utenti.");
                } catch (e) {
                    showInfo("Errore", "Impossibile salvare i prezzi: " + e.message);
                }
            };

            const createOrder = async () => {
                const dateStr = new Date().toLocaleDateString('it-IT');
                const newId = Date.now().toString();
                setActiveOrderId(newId);
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', newId), {
                    id: newId, 
                    title: `Ordine del ${dateStr}`, 
                    date: dateStr, 
                    items: [], 
                    status: 'active',
                    creator: currentUser 
                });
            };

            const updateOrderItems = async (orderId, newItems) => {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', orderId.toString()), { items: newItems }, {merge: true});
            };

            const addItemToOrder = async (orderId, item) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, [...(order.items || []), { ...item, id: Date.now(), paid: false, bought: false, userConfirmedPayment: false }]);
            };

            const removeItemFromOrder = async (orderId, itemId) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.filter(i => i.id !== itemId));
            };

            const updateItemPrice = async (orderId, itemId, newPrice) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.map(item => item.id === itemId ? { ...item, price: parseFloat(newPrice) || 0 } : item));
            };

            const updateItemStatus = async (orderId, itemId, field, value) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.map(item => item.id === itemId ? { ...item, [field]: value } : item));
            }

            const toggleBoughtStatus = async (orderId, itemId) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.map(item => item.id === itemId ? { ...item, bought: !item.bought } : item));
            };

            const deleteOrder = (orderId) => {
                showConfirm(
                    "Elimina Ordine", 
                    "Vuoi eliminare definitivamente questo ordine? L'azione è irreversibile.", 
                    async () => {
                        await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', orderId.toString()));
                        setActiveOrderId(null);
                    },
                    true,
                    "Elimina"
                );
            };

            // --- GESTIONE TRACKING ---
            const openTrackingModal = (order) => {
                setTrackingOrderId(order.id);
                setTrackingInitialValue(order.tracking || '');
                setIsTrackingModalOpen(true);
            };

            const saveTracking = async (value) => {
                if (!trackingOrderId) return;
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', trackingOrderId), { 
                    tracking: value 
                }, { merge: true });
                setIsTrackingModalOpen(false);
                setTrackingOrderId(null);
                showInfo("Salvato", "Informazioni di tracciamento aggiornate.");
            };
            // -------------------------

            const resetOrder = (orderId) => {
                showConfirm(
                    "Reset Ordine",
                    "Vuoi svuotare tutti gli articoli di questo ordine per ricominciare da zero?",
                    async () => {
                        await updateOrderItems(orderId, []);
                    },
                    false,
                    "Svuota Ordine"
                );
            };

            const factoryReset = () => {
                if (!isManager) return;
                showConfirm(
                    "RESET TOTALE APPLICAZIONE",
                    "ATTENZIONE: Stai per cancellare TUTTI i dati, tutti gli ordini e tutti gli utenti. Questa azione è distruttiva e irreversibile.",
                    async () => {
                        try {
                            const ordersSnapshot = await getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'orders'));
                            const batch = writeBatch(db);
                            ordersSnapshot.forEach((doc) => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();

                            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { users: ['Gestore'], paymentRequests: {}, pricing: DEFAULT_PRICING });
                            
                            showInfo("Reset Completato", "L'applicazione è tornata allo stato iniziale.");
                            setTimeout(() => window.location.reload(), 2000);
                        } catch (e) {
                            showInfo("Errore", "Errore durante il reset: " + e.message);
                        }
                    },
                    true,
                    "DISTRUGGI TUTTO"
                );
            };

            const confirmAllPayments = async () => {
                const updates = [];
                orders.forEach(order => {
                    const userItemsToUpdate = (order.items || []).filter(i => i.person === currentUser && !i.paid && !i.userConfirmedPayment);
                    
                    if (userItemsToUpdate.length > 0) {
                        const newItems = order.items.map(i => {
                            if (i.person === currentUser && !i.paid && !i.userConfirmedPayment) {
                                return { ...i, userConfirmedPayment: true };
                            }
                            return i;
                        });
                        updates.push(setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', order.id), { items: newItems }, {merge: true}));
                    }
                });
                
                try {
                    await Promise.all(updates);
                } catch (e) {
                    console.error("Error confirming payments:", e);
                    showInfo("Errore", "Impossibile confermare i pagamenti. Riprova.");
                }
            };

            const confirmUserPayments = async (user, pendingItems) => {
                const updates = {}; 

                pendingItems.forEach(item => {
                    if (!updates[item.orderId]) {
                        const order = orders.find(o => o.id === item.orderId);
                        if (order) updates[item.orderId] = [...order.items];
                    }
                });

                pendingItems.forEach(item => {
                    if (updates[item.orderId]) {
                        updates[item.orderId] = updates[item.orderId].map(i => 
                            i.id === item.id ? { ...i, paid: true } : i
                        );
                    }
                });

                try {
                    await Promise.all(Object.entries(updates).map(([orderId, newItems]) => 
                        setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', orderId), { items: newItems }, {merge: true})
                    ));
                    showInfo("Confermato", `Pagamenti di ${user} confermati.`);
                } catch (e) {
                    console.error(e);
                    showInfo("Errore", "Errore durante la conferma.");
                }
            };

            const handleAddToFavorites = async (name) => {
                setFavModalOpen(false);
                if (!name || !itemToFav) return;
                
                const item = itemToFav;
                const favItem = {
                    id: Date.now(),
                    name: name,
                    link: item.link || '',
                    liquidMl: item.liquidMl || '',
                    nicotineMl: item.nicotineMl || '',
                    vapeType: item.vapeType || '',
                    otherItems: item.otherItems || ''
                };

                try {
                    const ref = doc(db, 'artifacts', APP_ID, 'public', 'data', 'favorites', currentUser);
                    await setDoc(ref, { items: arrayUnion(favItem) }, { merge: true });
                    showInfo("Salvato", "Aggiunto agli Aromi Preferiti!");
                    setItemToFav(null);
                } catch (error) {
                    console.error("Error saving favorite:", error);
                    showInfo("Errore", "Impossibile salvare il preferito: " + error.message);
                }
            };

            const openFavModal = (item) => {
                setItemToFav(item);
                setFavModalOpen(true);
            }

            const handleReorderSingle = async (item) => {
                if (activeOrders.length === 0) {
                    return showInfo("Nessun Ordine Attivo", "Non ci sono ordini aperti in questo momento per aggiungere l'articolo.");
                }
                
                const targetOrder = activeOrders[0]; 
                
                const newItem = {
                    ...item,
                    id: Date.now(),
                    person: currentUser,
                    paid: false,
                    bought: false,
                    userConfirmedPayment: false
                };
                delete newItem.orderId;
                delete newItem.orderTitle;
                delete newItem.date;

                await addItemToOrder(targetOrder.id, newItem);
                showInfo("Fatto", `Articolo aggiunto all'ordine: ${targetOrder.title}`);
            };

            const handleDeleteHistoryItem = (item) => {
                showConfirm(
                    "Elimina dallo Storico",
                    "Sei sicuro? Se elimini questo articolo, verrà rimosso anche dal totale dei debiti/pagamenti nel sistema del gestore.",
                    async () => {
                        await removeItemFromOrder(item.orderId, item.id);
                    },
                    true, 
                    "Elimina"
                );
            };

            // --- NUOVE FUNZIONI GESTIONE LINK (SENZA PROMPT) ---
            const toggleAddLink = () => {
                if (!isManager) return;
                setIsAddingLink(!isAddingLink);
                setNewLinkName('');
                setNewLinkUrl('');
            };

            const saveNewLink = async (e) => {
                e.preventDefault();
                if (!newLinkName.trim() || !newLinkUrl.trim()) return;

                let url = newLinkUrl.trim();
                // Aggiungi protocollo se manca
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }

                const newLink = { name: newLinkName.trim(), url: url };
                const updatedLinks = [...quickLinks, newLink];
                
                try {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { 
                        quickLinks: updatedLinks 
                    }, {merge: true});
                    setIsAddingLink(false);
                    setNewLinkName('');
                    setNewLinkUrl('');
                } catch(e) {
                    showInfo("Errore", "Impossibile aggiungere il link.");
                }
            };

            const removeQuickLink = async (linkToRemove) => {
                if (!isManager) return;
                // Usa showConfirm invece di confirm() nativo
                showConfirm(
                    "Rimuovi Sito",
                    `Vuoi rimuovere ${linkToRemove.name} dai siti consigliati?`,
                    async () => {
                        const updatedLinks = quickLinks.filter(l => l.url !== linkToRemove.url);
                        try {
                            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { 
                                quickLinks: updatedLinks 
                            }, {merge: true});
                        } catch(e) {
                            showInfo("Errore", "Impossibile rimuovere il link.");
                        }
                    },
                    true,
                    "Rimuovi"
                );
            }
            // ---------------------------------------------------

            // --- UI RENDER ---
            if (!isConfigured) return <div className="p-10 text-center">Configurazione mancante</div>;
            if (connectionError) return <div className="p-10 text-center text-red-500">Errore: {connectionError}</div>;
            if (!firebaseUser) return <div className="min-h-screen flex items-center justify-center text-slate-400 bg-slate-50 dark:bg-slate-950 animate-pulse">Connessione Cloud...</div>;

            if (showWelcome && currentUser) return (
                <div className="min-h-screen bg-indigo-600 flex flex-col items-center justify-center text-white animate-in fade-in duration-500">
                    <Cloud size={64} className="mb-4 animate-bounce-slow" />
                    <h1 className="text-3xl font-bold mb-2">Bentornato, {currentUser}!</h1>
                    <div className="flex items-center gap-2 text-indigo-200">
                        <Loader2 className="animate-spin" size={20} />
                        <span>Caricamento Dashboard...</span>
                    </div>
                </div>
            );

            if (!currentUser) return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative">
                    <ConfirmDialog {...modalConfig} />
                    <div className="bg-white dark:bg-slate-800 w-full max-w-md rounded-3xl p-8 shadow-2xl animate-in">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 dark:bg-blue-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 dark:text-blue-400"><Cloud size={32} /></div>
                            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Svapo Manager</h1>
                            <p className="text-slate-500 dark:text-slate-400 text-sm">Cloud Edition</p>
                        </div>
                        {isLoggingInAsManager ? (
                            <div className="animate-in">
                                <button onClick={() => setIsLoggingInAsManager(false)} className="flex items-center gap-1 text-slate-400 mb-4 text-sm font-bold"><ArrowLeft size={16} /> Indietro</button>
                                <form onSubmit={submitManagerLogin} className="space-y-4">
                                    <input autoFocus type="password" placeholder="Password (1234)" className="w-full p-4 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-xl text-center text-xl tracking-widest outline-none focus:ring-2 focus:ring-blue-500" value={managerPassword} onChange={e => setManagerPassword(e.target.value)} />
                                    {loginError && <p className="text-red-500 text-sm text-center font-bold">{loginError}</p>}
                                    <button type="submit" className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">Accedi</button>
                                </form>
                            </div>
                        ) : (
                            <>
                                <div className="grid grid-cols-2 gap-3 mb-6">
                                    {users.map(u => (
                                        <div key={u} className="relative group">
                                            <button onClick={() => initiateLogin(u)} className="w-full relative p-4 rounded-xl border-2 border-slate-100 dark:border-slate-700 hover:border-blue-500 dark:hover:border-blue-500 transition-all font-medium text-slate-700 dark:text-slate-200 flex flex-col items-center gap-2">
                                                <div className="w-10 h-10 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center font-bold">{u.charAt(0)}</div>
                                                {u}
                                                {u === 'Gestore' && <Lock size={12} className="absolute top-2 right-2 text-slate-400" />}
                                            </button>
                                            
                                            {u !== 'Gestore' && (
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); deleteUser(u); }}
                                                    className="absolute -top-2 -right-2 w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-full shadow-lg border-2 border-white dark:border-slate-800 z-50 hover:bg-red-600 transition-transform active:scale-90"
                                                    aria-label="Elimina utente"
                                                >
                                                    <X size={16} />
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                    <button onClick={() => setIsAddingUser(true)} className="p-4 rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 text-slate-400 flex flex-col items-center gap-2 justify-center"><Plus size={24} /> <span className="text-sm">Nuovo</span></button>
                                </div>
                                {isAddingUser && (
                                    <form onSubmit={addUser} className="flex gap-2 animate-in"><input autoFocus type="text" placeholder="Nome..." className="flex-1 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-xl px-4 py-3 outline-none" value={newUserName} onChange={e => setNewUserName(e.target.value)} /><button type="submit" className="bg-blue-600 text-white p-3 rounded-xl font-bold">Ok</button></form>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );

            // --- HELPER RENDER FOR QUICK LINKS ---
            const renderQuickLinks = () => (
                <div className="mb-4">
                    <div className="flex justify-between items-center mb-2">
                        <h3 className="font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                            <Globe size={18} className="text-blue-500"/> Siti Consigliati
                        </h3>
                        {isManager && (
                            <button onClick={toggleAddLink} className={`text-xs p-1.5 rounded-lg transition-colors ${isAddingLink ? 'bg-red-100 text-red-500' : 'bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-blue-500'}`}>
                                {isAddingLink ? <X size={14}/> : <Plus size={14}/>}
                            </button>
                        )}
                    </div>

                    {/* FORM INSERIMENTO LINK */}
                    {isAddingLink && (
                        <form onSubmit={saveNewLink} className="mb-3 bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700 animate-in fade-in">
                            <div className="flex flex-col gap-2">
                                <input 
                                    autoFocus
                                    type="text" 
                                    placeholder="Nome (es. SvapoDream)" 
                                    className="w-full px-3 py-2 rounded-lg text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white outline-none"
                                    value={newLinkName}
                                    onChange={e => setNewLinkName(e.target.value)}
                                />
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        placeholder="URL (es. svapodream.it)" 
                                        className="flex-1 px-3 py-2 rounded-lg text-sm border dark:border-slate-600 dark:bg-slate-700 dark:text-white outline-none"
                                        value={newLinkUrl}
                                        onChange={e => setNewLinkUrl(e.target.value)}
                                    />
                                    <button type="submit" className="bg-blue-600 text-white px-4 rounded-lg font-bold text-sm">OK</button>
                                </div>
                            </div>
                        </form>
                    )}

                    <div className="grid grid-cols-2 gap-3">
                        {quickLinks.map((link, i) => (
                            <div key={i} className="relative group">
                                <a href={link.url} target="_blank" className="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl shadow-sm hover:shadow-md hover:border-blue-200 transition-all">
                                    <div className="w-8 h-8 rounded-lg bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-500">
                                        <ShoppingCart size={16}/>
                                    </div>
                                    <span className="font-bold text-sm text-slate-700 dark:text-slate-200 truncate">{link.name}</span>
                                </a>
                                {isManager && (
                                    <button 
                                        onClick={(e) => { e.preventDefault(); removeQuickLink(link); }}
                                        className="absolute -top-2 -right-2 bg-red-100 dark:bg-red-900/50 text-red-500 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"
                                    >
                                        <X size={12}/>
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 font-sans pb-24 md:pb-0 relative">
                    <ConfirmDialog {...modalConfig} />
                    <PricingModal isOpen={isPricingModalOpen} onClose={() => setIsPricingModalOpen(false)} currentPricing={pricing} onSave={savePricing} />
                    <AddToFavoriteModal isOpen={favModalOpen} onClose={() => setFavModalOpen(false)} onConfirm={handleAddToFavorites} item={itemToFav} />
                    
                    {/* MODALE TRACKING */}
                    <TrackingModal 
                        isOpen={isTrackingModalOpen} 
                        onClose={() => setIsTrackingModalOpen(false)} 
                        onSave={saveTracking} 
                        initialValue={trackingInitialValue} 
                    />

                    <div className="max-w-4xl mx-auto min-h-screen bg-white dark:bg-slate-900 shadow-xl flex flex-col border-x border-slate-100 dark:border-slate-800 relative">
                        
                        {/* HEADER */}
                        <header className="p-4 md:p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between sticky top-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur z-20">
                            
                            {/* USER DROPDOWN */}
                            <div className="relative" ref={profileMenuRef}>
                                <button onClick={() => setIsProfileMenuOpen(!isProfileMenuOpen)} className="flex items-center gap-3 focus:outline-none group">
                                    <div className="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg group-hover:bg-indigo-700 transition">{currentUser.charAt(0)}</div>
                                    <div><p className="text-xs text-slate-400 uppercase font-bold">Benvenuto</p><h1 className="text-lg font-bold text-slate-900 dark:text-white leading-none flex items-center gap-1">{currentUser} <ChevronDown size={14} className={`transition-transform ${isProfileMenuOpen ? 'rotate-180' : ''}`} /></h1></div>
                                </button>

                                {isProfileMenuOpen && (
                                    <div className="absolute top-14 left-0 w-64 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border dark:border-slate-700 p-2 z-50 animate-in fade-in zoom-in-95 origin-top-left">
                                        {/* THEME TOGGLE */}
                                        <div className="p-2 border-b dark:border-slate-700 mb-2">
                                            <p className="text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Modalità</p>
                                            <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                                {['light', 'auto', 'dark'].map(t => (
                                                    <button key={t} onClick={() => { setTheme(t); setIsProfileMenuOpen(false); }} className={`flex-1 p-2 rounded-md flex justify-center ${theme === t ? 'bg-white dark:bg-slate-600 shadow-sm text-blue-600 dark:text-blue-400' : 'text-slate-400'}`}>
                                                        {t === 'light' && <Sun size={16} />}
                                                        {t === 'auto' && <Monitor size={16} />}
                                                        {t === 'dark' && <Moon size={16} />}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* MENU ITEMS */}
                                        {!isManager && (
                                            <>
                                                {/* 1. Diario Svapo */}
                                                <button onClick={() => { setView('activity-hub'); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">
                                                    <div className="p-2 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 rounded-lg"><Activity size={18}/></div> Diario Svapo
                                                </button>
                                                
                                                {/* 2. Le Mie Liste (con Wishlist & Preferiti unificati) */}
                                                <button onClick={() => { setView('user-lists'); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">
                                                    <div className="p-2 bg-rose-100 dark:bg-rose-900/30 text-rose-600 rounded-lg"><ClipboardList size={18}/></div> Le Mie Liste
                                                </button>

                                                {/* 3. Resoconto Spese */}
                                                <button onClick={() => { setView('monthly-report'); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">
                                                    <div className="p-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-500 rounded-lg"><Calendar size={18}/></div> Resoconto Spese
                                                </button>
                                                
                                                {/* 4. Archivio Ordini */}
                                                <button onClick={() => { setView('user-archive'); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">
                                                    <div className="p-2 bg-blue-50 dark:bg-blue-900/30 text-blue-500 rounded-lg"><Archive size={18}/></div> Archivio Ordini
                                                </button>
                                                
                                                {/* 5. Statistiche */}
                                                <button onClick={() => { setView('stats'); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">
                                                    <div className="p-2 bg-purple-100 dark:bg-purple-900/30 text-purple-600 rounded-lg"><BarChart3 size={18}/></div> Statistiche
                                                </button>
                                                
                                                <div className="h-px bg-slate-100 dark:bg-slate-700 my-1"></div>
                                            </>
                                        )}

                                        {isManager && (
                                            <>
                                                {/* 1. Gestione Bacheca */}
                                                <button onClick={() => { setView('notice-manager'); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">
                                                    <div className="p-2 bg-amber-100 dark:bg-amber-900/30 text-amber-600 rounded-lg"><MessageCircle size={18}/></div> Gestione Bacheca
                                                </button>
                                                
                                                {/* 2. Magazzino */}
                                                <button onClick={() => { setView('warehouse'); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">
                                                    <div className="p-2 bg-orange-100 dark:bg-orange-900/30 text-orange-600 rounded-lg"><Box size={18}/></div> Magazzino
                                                </button>

                                                {/* 3. Calcolatore Mix */}
                                                <button onClick={() => { setView('calculator'); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">
                                                    <div className="p-2 bg-cyan-100 dark:bg-cyan-900/30 text-cyan-600 rounded-lg"><FlaskConical size={18}/></div> Calcolatore Mix
                                                </button>

                                                {/* 4. Configura Prezzi */}
                                                <button onClick={() => { setIsPricingModalOpen(true); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-emerald-50 dark:hover:bg-emerald-900/10 text-emerald-600 text-sm font-medium">
                                                    <div className="p-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-lg"><DollarSign size={18}/></div> Configura Prezzi
                                                </button>

                                                <div className="h-px bg-slate-100 dark:bg-slate-700 my-1"></div>

                                                {/* 5. Storico Ordini */}
                                                <button onClick={() => { setView('manager-archive'); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">
                                                    <div className="p-2 bg-blue-50 dark:bg-blue-900/30 text-blue-500 rounded-lg"><Archive size={18}/></div> Storico Ordini
                                                </button>
                                                
                                                <div className="h-px bg-slate-100 dark:bg-slate-700 my-1"></div>
                                                
                                                {/* 6. Reset App */}
                                                <button onClick={() => { factoryReset(); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/10 text-red-500 text-sm font-medium">
                                                    <div className="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-lg"><AlertTriangle size={18}/></div> Reset App
                                                </button>
                                                <div className="h-px bg-slate-100 dark:bg-slate-700 my-1"></div>
                                            </>
                                        )}
                                        
                                        <button onClick={() => { handleLogout(); setIsProfileMenuOpen(false); }} className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 text-sm font-medium">
                                            <div className="p-2 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-lg"><LogOut size={18} /></div> Esci
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* DESKTOP NAV */}
                            <div className="flex items-center gap-2">
                                {!activeOrderId && (
                                    <div className="hidden md:flex items-center gap-1 bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                                        <NavButtonDesktop icon={User} label="Profilo" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                                        
                                        {isManager && <NavButtonDesktop icon={Banknote} label="Pagamenti" active={view === 'payments'} onClick={() => setView('payments')} />}
                                        
                                        {!isManager && <NavButtonDesktop icon={ShoppingBag} label="Ordini" active={view === 'orders'} onClick={() => setView('orders')} />}
                                        {isManager && <NavButtonDesktop icon={ShoppingCart} label="Spesa" active={view === 'shopping'} onClick={() => setView('shopping')} />}
                                    </div>
                                )}
                            </div>
                        </header>

                        {/* MAIN CONTENT */}
                        <main className="flex-1 overflow-y-auto p-4">
                            {/* RENDER ORDER DETAIL OVERLAY IF ACTIVE */}
                            {activeOrderId ? (
                                <OrderDetail 
                                    order={orders.find(o => o.id == activeOrderId)} 
                                    users={users} 
                                    currentUser={currentUser} 
                                    isManager={isManager} 
                                    onBack={() => setActiveOrderId(null)} 
                                    onAdd={addItemToOrder} 
                                    onRemove={removeItemFromOrder} 
                                    onDelete={deleteOrder} 
                                    onUpdateStatus={updateItemStatus} 
                                    currentPricing={pricing} // Passaggio prezzi dinamici
                                    allOrders={orders} 
                                />
                            ) : (
                                // --- MAIN VIEW CONTENT ---
                                <>
                                    {view === 'dashboard' && (
                                        <div className="space-y-6 animate-in">
                                            
                                            {/* SITI CONSIGLIATI: SOLO PER GESTORE QUI (IN ALTO) */}
                                            {isManager && renderQuickLinks()}

                                            {/* --- SEZIONE BACHECA AVVISI --- */}
                                            {notices.length > 0 && (
                                                <div className="space-y-2">
                                                    {notices.filter(n => n.active).map(n => (
                                                        <div key={n.id} className="bg-amber-50 dark:bg-amber-900/20 border border-amber-100 dark:border-amber-800 p-4 rounded-2xl flex items-start gap-4 shadow-sm animate-in fade-in slide-in-from-top-2 relative overflow-hidden">
                                                            <div className="absolute top-0 right-0 w-16 h-16 bg-amber-200 dark:bg-amber-700 rounded-bl-full -mr-8 -mt-8 opacity-20"></div>
                                                            <div className="bg-amber-100 dark:bg-amber-800 p-3 rounded-full text-amber-600 dark:text-amber-100 flex-shrink-0 shadow-sm">
                                                                <BellRing size={20} className="animate-bounce-slow" />
                                                            </div>
                                                            <div>
                                                                <div className="flex justify-between items-center w-full mb-1">
                                                                    <h3 className="font-bold text-amber-800 dark:text-amber-100 text-xs uppercase tracking-wider">Avviso dal Gestore</h3>
                                                                    <span className="text-[10px] text-amber-600/60 dark:text-amber-200/50">{n.date}</span>
                                                                </div>
                                                                <p className="text-slate-800 dark:text-slate-200 font-medium italic text-lg leading-snug">"{n.text}"</p>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            {/* ---------------------------------------------------------------------------------- */}

                                            {isManager ? (
                                                <div className="space-y-6">
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-5 rounded-2xl text-white shadow-lg">
                                                            <div className="flex justify-between mb-4"><ArrowUpRight className="opacity-80" /><span className="text-xs bg-white/20 px-2 py-1 rounded-lg">Crediti</span></div>
                                                            <p className="text-sm opacity-80">Devono darti</p><p className="text-3xl font-bold">€{managerStats.totalCredits.toFixed(2)}</p>
                                                        </div>
                                                        <div className="bg-white dark:bg-slate-800 border dark:border-slate-700 p-5 rounded-2xl">
                                                            <div className="flex justify-between mb-4 text-slate-400"><PiggyBank /><span className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-lg text-slate-500 dark:text-slate-300 font-bold">Totale</span></div>
                                                            <p className="text-sm text-slate-400">Incassati</p><p className="text-3xl font-bold text-slate-800 dark:text-white">€{managerStats.totalCollected.toFixed(2)}</p>
                                                        </div>
                                                    </div>

                                                    {/* PROMEMORIA ORDINI ATTIVI - RAGGRUPPATI PER GIORNO */}
                                                    <div className="mb-6">
                                                        <h3 className="font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                                                            <ShoppingBag size={20} className="text-indigo-500"/> Ordini Attivi
                                                        </h3>
                                                        {activeOrders.length === 0 ? (
                                                            <p className="text-sm text-slate-400 italic">Nessun ordine attivo al momento.</p>
                                                        ) : (
                                                            <div className="space-y-4">
                                                                {groupedActiveOrdersByDate.map(([date, dayOrders]) => (
                                                                    <div key={date}>
                                                                        <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 pl-1 sticky top-0 bg-slate-50/95 dark:bg-slate-950/95 py-1 z-10">
                                                                            {new Date(date.split('/').reverse().join('-')).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}
                                                                        </h4>
                                                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                                            {dayOrders.map(order => (
                                                                                <button 
                                                                                    key={order.id}
                                                                                    onClick={() => setActiveOrderId(order.id)}
                                                                                    className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 text-left hover:border-indigo-500 transition-colors group relative"
                                                                                >
                                                                                    <div className="flex justify-between items-center mb-1">
                                                                                        <span className="font-bold text-slate-800 dark:text-white group-hover:text-indigo-500 transition-colors">{order.title}</span>
                                                                                        <span className="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 text-[10px] font-bold px-2 py-1 rounded-full">
                                                                                            {(order.items || []).length} art.
                                                                                        </span>
                                                                                    </div>
                                                                                    <div className="flex -space-x-2 overflow-hidden py-1">
                                                                                        {/* Show avatars of users involved */}
                                                                                        {[...new Set((order.items || []).map(i => i.person))].slice(0, 4).map((p, i) => (
                                                                                            <div key={i} className="inline-block h-6 w-6 rounded-full ring-2 ring-white dark:ring-slate-800 bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-[8px] font-bold text-slate-600 dark:text-slate-300" title={p}>
                                                                                                {p.charAt(0)}
                                                                                            </div>
                                                                                        ))}
                                                                                        {[...new Set((order.items || []).map(i => i.person))].length > 4 && (
                                                                                            <div className="inline-block h-6 w-6 rounded-full ring-2 ring-white dark:ring-slate-800 bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-[8px] font-bold text-slate-400">
                                                                                                +
                                                                                            </div>
                                                                                        )}
                                                                                    </div>
                                                                                </button>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* NUOVO: SEZIONE ULTIMO ORDINE / IN DISTRIBUZIONE */}
                                                    {Object.entries(managerStats.lastOrderItemsByUser).length > 0 && (
                                                        <div className="bg-indigo-50 dark:bg-indigo-900/10 border border-indigo-100 dark:border-indigo-900/30 p-5 rounded-2xl mt-6">
                                                            <h3 className="font-bold text-indigo-800 dark:text-indigo-300 flex items-center gap-2 mb-4">
                                                                <Package size={20} /> Ultimo Ordine
                                                            </h3>
                                                            <div className="space-y-4">
                                                                {Object.entries(managerStats.lastOrderItemsByUser).map(([user, items]) => (
                                                                    <div key={user} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-indigo-50 dark:border-indigo-900/20">
                                                                        <h4 className="font-bold text-slate-800 dark:text-white mb-2 border-b dark:border-slate-700 pb-1">{user}</h4>
                                                                        <ul className="space-y-2">
                                                                            {items.map((item, idx) => (
                                                                                <li key={idx} className="text-sm text-slate-600 dark:text-slate-300 flex flex-col gap-1 p-2 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                                                                                    <div className="flex items-center gap-2 font-bold">
                                                                                        <CheckCircle2 size={14} className="text-emerald-500" />
                                                                                        <span className="truncate flex-1">{item.link || item.otherItems}</span>
                                                                                    </div>
                                                                                    <div className="flex flex-wrap gap-1 text-[10px] text-slate-500 dark:text-slate-400 ml-6">
                                                                                        {item.liquidMl && <span className="bg-white dark:bg-slate-700 px-1.5 py-0.5 rounded border dark:border-slate-600">{item.liquidMl}ml</span>}
                                                                                        {item.nicotineMl && <span className="bg-white dark:bg-slate-700 px-1.5 py-0.5 rounded border dark:border-slate-600">{item.nicotineMl}nic</span>}
                                                                                        {item.vapeType && <span className="bg-white dark:bg-slate-700 px-1.5 py-0.5 rounded border dark:border-slate-600">{item.vapeType}</span>}
                                                                                        {item.otherItems && !item.link && <span className="text-orange-500">{item.otherItems}</span>}
                                                                                    </div>
                                                                                </li>
                                                                            ))}
                                                                        </ul>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {/* NOTIFICHE PAGAMENTI */}
                                                    {Object.entries(managerStats.pendingByUser).length > 0 && (
                                                        <div className="space-y-3">
                                                            <h3 className="font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2"><BellRing size={18} className="text-orange-500" /> Pagamenti da Confermare</h3>
                                                            {Object.entries(managerStats.pendingByUser).map(([user, data]) => (
                                                                <div key={user} className="bg-orange-50 dark:bg-orange-900/10 border border-orange-100 dark:border-orange-900/30 p-4 rounded-2xl flex justify-between items-center shadow-sm">
                                                                    <div>
                                                                        <p className="font-bold text-slate-800 dark:text-slate-200">{user}</p>
                                                                        <p className="text-xs text-orange-600 dark:text-orange-400">Ha segnato come pagati {data.items.length} articoli</p>
                                                                        <p className="font-bold text-lg text-slate-800 dark:text-white mt-1">€{data.total.toFixed(2)}</p>
                                                                    </div>
                                                                    <button 
                                                                        onClick={() => confirmUserPayments(user, data.items)}
                                                                        className="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-4 py-2 rounded-xl font-bold text-sm shadow-lg hover:opacity-90 transition-opacity"
                                                                    >
                                                                        Conferma
                                                                    </button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            ) : (
                                                <div className="space-y-6">
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div className="bg-gradient-to-br from-indigo-500 to-blue-600 p-5 rounded-2xl text-white shadow-lg">
                                                            <div className="flex justify-between mb-4"><List className="opacity-80" /><span className="text-xs bg-white/20 px-2 py-1 rounded-lg">Totale</span></div>
                                                            <p className="text-sm opacity-80">Articoli</p><p className="text-3xl font-bold">{userStats.totalItems}</p>
                                                        </div>
                                                        
                                                        {/* MODIFIED DEBT CARD WITH INTERACTIVE TICK */}
                                                        <div className={`p-5 rounded-2xl border-2 transition-colors ${
                                                            userStats.totalDebt > 0 
                                                            ? 'bg-orange-5 dark:bg-orange-900/10 border-orange-100 dark:border-orange-900/30 text-orange-700 dark:text-orange-400' 
                                                            : (userStats.pendingConfirmationDebt > 0 
                                                                ? 'bg-emerald-5 dark:bg-emerald-900/10 border-emerald-100 dark:border-emerald-900/30 text-emerald-700 dark:text-emerald-400' 
                                                                : 'bg-emerald-5 dark:bg-emerald-900/10 border-emerald-100 dark:border-emerald-900/30 text-emerald-700 dark:text-emerald-400')
                                                        }`}>
                                                            <div className="flex justify-between items-start mb-2">
                                                                {/* INTERACTIVE TICK BUTTON */}
                                                                {userStats.itemsToPay > 0 ? (
                                                                    <button 
                                                                        onClick={confirmAllPayments}
                                                                        className="flex items-center justify-center p-2 -mt-2 -ml-2 rounded-xl hover:bg-orange-100 dark:hover:bg-orange-900/40 text-orange-600 dark:text-orange-300 transition-colors"
                                                                        title="Clicca per confermare di aver pagato tutto"
                                                                    >
                                                                        <Square size={24} strokeWidth={2.5} />
                                                                    </button>
                                                                ) : (
                                                                    <div className="flex items-center justify-center p-2 -mt-2 -ml-2 text-emerald-600 dark:text-emerald-400">
                                                                        <CheckSquare size={24} strokeWidth={2.5} />
                                                                    </div>
                                                                )}
                                                                <span className="text-xs font-bold uppercase px-2 py-1 rounded-lg bg-white/50 dark:bg-black/20 self-start">Stato</span>
                                                            </div>
                                                            
                                                            {userStats.totalDebt > 0 ? (
                                                                <>
                                                                    <p className="text-sm opacity-80">Devi dare</p>
                                                                    <p className="text-3xl font-bold">€{userStats.totalDebt.toFixed(2)}</p>
                                                                    <p className="text-xs mt-1 opacity-70">{userStats.itemsToPay} articoli da saldare</p>
                                                                </>
                                                            ) : (
                                                                userStats.pendingConfirmationDebt > 0 ? (
                                                                    <>
                                                                        <p className="text-sm opacity-80 font-bold">In attesa di conferma</p>
                                                                        <p className="text-3xl font-bold">€{userStats.pendingConfirmationDebt.toFixed(2)}</p>
                                                                        <p className="text-xs mt-1 opacity-70">Hai confermato il pagamento</p>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <p className="text-sm opacity-80">Tutto saldato</p>
                                                                        <p className="text-3xl font-bold">€0.00</p>
                                                                        <p className="text-xs mt-1 opacity-70">Nessun debito</p>
                                                                    </>
                                                                )
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2"><History size={18} className="text-indigo-500"/> I tuoi acquisti recenti</h3>
                                                        <div className="space-y-3">
                                                            {userStats.myItems.length === 0 && <p className="text-slate-400 text-sm italic">Non hai ancora comprato nulla.</p>}
                                                            {userStats.myItems.slice().reverse().slice(0, 5).map((item, idx) => ( 
                                                                <div key={idx} className="bg-white dark:bg-slate-800 border dark:border-slate-700 p-3 rounded-xl flex justify-between items-center shadow-sm">
                                                                    <div className="overflow-hidden mr-2">
                                                                        <p className="font-bold text-slate-800 dark:text-white truncate">{item.link || 'Oggetto senza link'}</p>
                                                                        <p className="text-xs text-slate-500 dark:text-slate-400">{item.date}</p>
                                                                    </div>
                                                                    
                                                                    {/* Action Buttons */}
                                                                    <div className="flex items-center gap-2">
                                                                        <button onClick={() => handleReorderSingle(item)} className="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-blue-500 transition-colors" title="Riordina">
                                                                            <RotateCcw size={16} />
                                                                        </button>
                                                                        <button onClick={() => openFavModal(item)} className="p-2 rounded-lg bg-pink-50 dark:bg-pink-900/20 text-pink-400 hover:text-pink-600 transition-colors" title="Preferiti">
                                                                            <Heart size={16} />
                                                                        </button>
                                                                        <button onClick={() => handleDeleteHistoryItem(item)} className="p-2 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-400 hover:text-red-600 transition-colors" title="Elimina">
                                                                            <Trash2 size={16} />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>

                                                    {/* SITI CONSIGLIATI: SOLO PER UTENTI QUI (IN BASSO) */}
                                                    {!isManager && renderQuickLinks()}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* NUOVE VIEW GESTORE */}
                                    {view === 'notice-manager' && isManager && <NoticeManager onBack={() => setView('dashboard')} notices={notices} showConfirm={showConfirm} />}
                                    {view === 'calculator' && isManager && <MixingCalculator onBack={() => setView('dashboard')} />}
                                    {view === 'warehouse' && isManager && <WarehouseManager onBack={() => setView('dashboard')} />}

                                    {/* NUOVE VIEW UTENTI */}
                                    {view === 'user-lists' && !isManager && <UserLists onBack={() => setView('dashboard')} currentUser={currentUser} activeOrderId={activeOrderId} onAddToOrder={handleReorderSingle} />}
                                    {view === 'stats' && !isManager && <UserStatistics orders={orders} currentUser={currentUser} onBack={() => setView('dashboard')} />}
                                    {/* NUOVA VISTA ARCHIVIO UTENTE */}
                                    {view === 'user-archive' && !isManager && <OrderArchive orders={groupedArchivedOrders} currentUser={currentUser} isManager={false} onBack={() => setView('dashboard')} onClickOrder={setActiveOrderId} />}
                                    
                                    {/* --- AGGIUNTO VIEW COIL TRACKER --- */}
                                    {view === 'activity-hub' && !isManager && <UserActivityHub orders={orders} currentUser={currentUser} onBack={() => setView('dashboard')} showConfirm={showConfirm} />}
                                    
                                    {/* VISTA RESOCONTO SPESE PER UTENTI */}
                                    {view === 'monthly-report' && !isManager && <MonthlyReport orders={orders} currentUser={currentUser} onBack={() => setView('dashboard')} />}

                                    {view === 'payments' && isManager && (
                                        <div className="pb-20 animate-in p-4">
                                            <h2 className="text-xl font-bold mb-6 flex items-center gap-2"><Banknote className="text-orange-500"/> Conferma Pagamenti</h2>
                                            
                                            {Object.entries(managerStats.pendingByUser).length === 0 ? (
                                                <div className="text-center py-20 text-slate-400">
                                                    <CheckCircle size={48} className="mx-auto mb-4 opacity-20" />
                                                    <p>Nessun pagamento in attesa di conferma.</p>
                                                </div>
                                            ) : (
                                                <div className="space-y-4">
                                                    {Object.entries(managerStats.pendingByUser).map(([user, data]) => (
                                                        <div key={user} className="bg-orange-50 dark:bg-orange-900/10 border border-orange-100 dark:border-orange-900/30 p-5 rounded-2xl shadow-sm">
                                                            <div className="flex justify-between items-start mb-4">
                                                                <div>
                                                                    <h3 className="font-bold text-lg text-slate-800 dark:text-slate-200">{user}</h3>
                                                                    <p className="text-sm text-orange-600 dark:text-orange-400 font-medium">Ha confermato {data.items.length} pagamenti</p>
                                                                </div>
                                                                <div className="text-right">
                                                                    <span className="block text-xs uppercase text-slate-400 font-bold">Totale</span>
                                                                    <span className="text-2xl font-bold text-slate-800 dark:text-white">€{data.total.toFixed(2)}</span>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="bg-white/50 dark:bg-black/20 rounded-xl p-3 mb-4 text-xs text-slate-500 dark:text-slate-400 max-h-32 overflow-y-auto">
                                                                {data.items.map((item, idx) => (
                                                                    <div key={idx} className="flex justify-between py-1 border-b border-slate-100 dark:border-slate-700/50 last:border-0">
                                                                        <span className="truncate pr-2">{item.link || item.otherItems}</span>
                                                                        <span className="font-mono">€{item.price}</span>
                                                                    </div>
                                                                ))}
                                                            </div>

                                                            <button 
                                                                onClick={() => confirmUserPayments(user, data.items)}
                                                                className="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-3 rounded-xl font-bold shadow-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                                                            >
                                                                <CheckCircle2 size={18} /> Conferma Ricezione
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {view === 'manager-archive' && <OrderArchive orders={groupedArchivedOrders} currentUser={currentUser} isManager={isManager} onBack={() => setView('dashboard')} onDelete={deleteOrder} onReset={resetOrder} onClickOrder={setActiveOrderId} onSaveTracking={openTrackingModal} />}

                                    {view === 'orders' && !isManager && (
                                        <div className="space-y-6 animate-in">
                                            {!activeOrderId ? (
                                                <>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <h2 className="text-xl font-bold text-slate-800 dark:text-white">Ordini Gruppo</h2>
                                                        <button onClick={createOrder} className="bg-slate-900 dark:bg-white dark:text-slate-900 text-white py-2 px-4 rounded-xl flex items-center gap-2 text-sm font-bold"><Plus size={18} /> NUOVO</button>
                                                    </div>
                                                    <div className="space-y-6">
                                                        {activeOrders.length === 0 && <p className="text-center text-slate-400 py-10">Nessun ordine attivo.</p>}
                                                        {groupedActiveOrders.map(([monthYear, monthOrders]) => (
                                                            <div key={monthYear}>
                                                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-3 pl-1">{new Date(monthYear.split('/').reverse().join('-')).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}</h3>
                                                                <div className="space-y-3">
                                                                    {monthOrders.map(order => (
                                                                        <OrderCard 
                                                                            key={order.id} 
                                                                            order={order} 
                                                                            currentUser={currentUser}
                                                                            onClick={(id) => setActiveOrderId(id)}
                                                                            onDelete={deleteOrder}
                                                                            onReset={resetOrder}
                                                                            isManager={isManager}
                                                                            onSaveTracking={openTrackingModal} // Passaggio funzione tracking
                                                                        />
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </>
                                            ) : (
                                                <OrderDetail 
                                                    order={orders.find(o => o.id == activeOrderId)} 
                                                    users={users} 
                                                    currentUser={currentUser} 
                                                    isManager={isManager} 
                                                    onBack={() => setActiveOrderId(null)} 
                                                    onAdd={addItemToOrder} 
                                                    onRemove={removeItemFromOrder} 
                                                    onDelete={deleteOrder} 
                                                    onUpdateStatus={updateItemStatus} 
                                                    currentPricing={pricing}
                                                    allOrders={orders}
                                                />
                                            )}
                                        </div>
                                    )}

                                    {view === 'shopping' && isManager && (
                                        <div className="animate-in space-y-6">
                                            <div className="bg-emerald-600 text-white p-6 rounded-3xl shadow-xl"><h2 className="text-3xl font-bold flex items-center gap-2"><ShoppingCart /> Lista Spesa</h2><p className="text-emerald-100 text-sm mt-1">{shoppingList.filter(g => !g.allBought).length} prodotti da acquistare</p></div>
                                            <div className="space-y-4">
                                                {shoppingList.map((group, idx) => (
                                                    <div key={idx} className={`bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl p-4 shadow-sm ${group.allBought ? 'opacity-60' : 'border-emerald-100 dark:border-emerald-900/30 ring-1 ring-emerald-50 dark:ring-emerald-900/10'}`}>
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div className="w-full overflow-hidden">
                                                                <h3 className="font-bold text-lg truncate text-slate-800 dark:text-white">{group.count}x {group.link ? 'Prodotto' : 'Oggetto'}</h3>
                                                            </div>
                                                        </div>
                                                        <div className="space-y-2">
                                                            {group.items.map(item => (
                                                                <ShoppingItem key={item.id} item={item} toggleBoughtStatus={toggleBoughtStatus} updateItemPrice={updateItemPrice} />
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </main>

                        {/* MOBILE NAV: Show if NO active order overlay is open */}
                        {!activeOrderId && (
                            <nav className="fixed bottom-6 left-6 right-6 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl border border-slate-200/60 dark:border-slate-800/60 p-3 rounded-full shadow-2xl shadow-indigo-500/10 z-50 flex justify-around items-center md:hidden pb-safe transition-all">
                                <NavButton icon={User} label="Profilo" active={view === 'dashboard' || view === 'monthly-report' || view === 'liquid-archive' || view === 'activity-hub'} onClick={() => setView('dashboard')} />
                                
                                {isManager && <NavButton icon={Banknote} label="Pagamenti" active={view === 'payments'} onClick={() => setView('payments')} />}
                                
                                {!isManager && <NavButton icon={ShoppingBag} label="Ordini" active={view === 'orders'} onClick={() => setView('orders')} />}
                                {isManager && <NavButton icon={ShoppingCart} label="Spesa" active={view === 'shopping'} onClick={() => setView('shopping')} />}
                            </nav>
                        )}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<OrderManager />);
    </script>
</body>
</html>
