<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Svapo Manager Cloud</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☁️</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Excel Export Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- React & Babel -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        body { overscroll-behavior-y: none; }
        
        /* Dark mode transitions */
        body, div, p, h1, h2, h3, button { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 selection:bg-indigo-100 dark:selection:bg-indigo-900/50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Check, X, ArrowLeft, Share2, DollarSign, Users, 
            ShoppingBag, Wallet, Link as LinkIcon, Wind, 
            LogOut, TrendingUp, History, User, ShoppingCart, ExternalLink, CheckSquare, Square, Lock, Beaker, ShoppingBasket, Send, List, FileSpreadsheet, Bell, BellRing, KeyRound, PiggyBank, ArrowUpRight, CloudLightning, MessageCircle, AlertCircle, RefreshCcw, MoreHorizontal, Moon, Sun, Monitor, AlertTriangle
        } from 'lucide-react';
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs, writeBatch, arrayUnion } from 'firebase/firestore';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDwpBj5NXy4iZkOKXMEMd_CY1_1cMMRx-s",
              authDomain: "svapomenager.firebaseapp.com",
              projectId: "svapomenager",
              storageBucket: "svapomenager.firebasestorage.app",
              messagingSenderId: "512019732894",
              appId: "1:512019732894:web:d4fb58561b3fbea1ff1e8f",
              measurementId: "G-VDCNTT6WHM"
        };

        let app, db, auth;
        const isConfigured = firebaseConfig.apiKey !== "TUO_API_KEY";
        
        if (isConfigured) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        }
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'svapo-manager-default';

        // --- HOOK PER IL TEMA (DARK MODE) ---
        const useTheme = () => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'auto');

            useEffect(() => {
                const root = window.document.documentElement;
                const isDark = theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                if (isDark) {
                    root.classList.add('dark');
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#020617');
                } else {
                    root.classList.remove('dark');
                    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff');
                }
                localStorage.setItem('theme', theme);
            }, [theme]);

            return [theme, setTheme];
        };

        // --- COMPONENTE SWIPEABLE PER LA LISTA ORDINI ---
        const SwipeableOrder = ({ order, currentUser, onClick, onDelete, onReset }) => {
            const [offsetX, setOffsetX] = useState(0);
            const [isSwiping, setIsSwiping] = useState(false);
            const startX = useRef(0);
            
            const handleTouchStart = (e) => {
                startX.current = e.touches[0].clientX;
                setIsSwiping(true);
            };

            const handleTouchMove = (e) => {
                if (!isSwiping) return;
                const touchX = e.touches[0].clientX;
                const diff = touchX - startX.current;
                // Limit swipe to left, max -200px
                if (diff < 0 && diff > -250) {
                    setOffsetX(diff);
                }
            };

            const handleTouchEnd = () => {
                setIsSwiping(false);
                // Soglia di apertura
                if (offsetX < -80) {
                    setOffsetX(-140); // Snap open
                } else {
                    setOffsetX(0); // Snap close
                }
            };

            const handleAction = (e, action, id) => {
                e.stopPropagation(); 
                e.preventDefault();
                setOffsetX(0); 
                action(id);
            };

            const myCount = (order.items || []).filter(i => i.person === currentUser).length;

            return (
                <div className="relative mb-3 h-20 rounded-2xl shadow-sm select-none">
                    {/* Background Actions (Z-0) */}
                    <div className="absolute inset-0 flex items-center justify-end px-4 gap-2 bg-slate-100 dark:bg-slate-800 rounded-2xl">
                        <button 
                            onClick={(e) => handleAction(e, onReset, order.id)}
                            className="bg-orange-100 dark:bg-orange-900/30 p-2 rounded-xl text-orange-600 dark:text-orange-400 flex flex-col items-center justify-center w-14 h-14 active:scale-95 transition z-20 cursor-pointer"
                        >
                            <RefreshCcw size={18} />
                            <span className="text-[10px] font-bold mt-1">Reset</span>
                        </button>
                        <button 
                            onClick={(e) => handleAction(e, onDelete, order.id)}
                            className="bg-red-100 dark:bg-red-900/30 p-2 rounded-xl text-red-600 dark:text-red-400 flex flex-col items-center justify-center w-14 h-14 active:scale-95 transition z-20 cursor-pointer"
                        >
                            <Trash2 size={18} />
                            <span className="text-[10px] font-bold mt-1">Elim.</span>
                        </button>
                    </div>

                    {/* Foreground Card (Z-10) */}
                    <div 
                        onClick={() => onClick(order.id)}
                        className="absolute inset-0 bg-white dark:bg-slate-900 border dark:border-slate-700 p-4 flex justify-between items-center z-10 rounded-2xl transition-transform duration-300 ease-out cursor-pointer"
                        style={{ transform: `translateX(${offsetX}px)` }}
                        onTouchStart={handleTouchStart}
                        onTouchMove={handleTouchMove}
                        onTouchEnd={handleTouchEnd}
                    >
                         <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 rounded-xl flex items-center justify-center">
                                <ShoppingBag size={20} />
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-900 dark:text-white leading-tight">{order.title}</h3>
                                <p className="text-xs text-slate-500 dark:text-slate-400">I tuoi articoli: {myCount}</p>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-2">
                             {/* Desktop Buttons (Visible if no touch) */}
                            <div className="hidden sm:flex gap-1 mr-2">
                                <button onClick={(e) => handleAction(e, onReset, order.id)} className="p-2 hover:bg-orange-50 dark:hover:bg-orange-900/30 text-slate-400 dark:text-slate-500 hover:text-orange-500 dark:hover:text-orange-400 rounded-full"><RefreshCcw size={16}/></button>
                                <button onClick={(e) => handleAction(e, onDelete, order.id)} className="p-2 hover:bg-red-50 dark:hover:bg-red-900/30 text-slate-400 dark:text-slate-500 hover:text-red-500 dark:hover:text-red-400 rounded-full"><Trash2 size={16}/></button>
                            </div>
                            <div className="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-500 dark:text-slate-400">
                                {currentUser.charAt(0)}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const OrderManager = () => {
            // --- STATE ---
            const [users, setUsers] = useState(['Gestore']);
            const [orders, setOrders] = useState([]);
            const [paymentRequests, setPaymentRequests] = useState({});
            const [currentUser, setCurrentUser] = useState(null);
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [connectionError, setConnectionError] = useState(null); 
            
            // Login State
            const [isLoggingInAsManager, setIsLoggingInAsManager] = useState(false);
            const [managerPassword, setManagerPassword] = useState('');
            const [loginError, setLoginError] = useState('');
            
            const [view, setView] = useState('dashboard'); 
            const [activeOrderId, setActiveOrderId] = useState(null);
            const [newUserName, setNewUserName] = useState('');
            const [isAddingUser, setIsAddingUser] = useState(false);

            // Theme Hook
            const [theme, setTheme] = useTheme();

            // --- FIREBASE SYNC ---
            useEffect(() => {
                if (!isConfigured) return;

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth Error:", err);
                        setConnectionError(err.message);
                    }
                };
                
                const timer = setTimeout(() => {
                    if (!auth.currentUser) {
                        setConnectionError("Timeout: La connessione sta impiegando troppo tempo.");
                    }
                }, 10000);

                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        clearTimeout(timer);
                        setFirebaseUser(user);
                    }
                });
                return () => {
                    unsubscribe();
                    clearTimeout(timer);
                };
            }, []);

            useEffect(() => {
                if (!firebaseUser) return;
                const qOrders = collection(db, 'artifacts', APP_ID, 'public', 'data', 'orders');
                const unsubOrders = onSnapshot(qOrders, (snapshot) => {
                    const loadedOrders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    loadedOrders.sort((a, b) => b.id - a.id);
                    setOrders(loadedOrders);
                }, (err) => setConnectionError("Errore lettura ordini: " + err.message));

                const docSettings = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global');
                const unsubSettings = onSnapshot(docSettings, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        if (data.users) setUsers(data.users);
                        if (data.paymentRequests) setPaymentRequests(data.paymentRequests);
                    } else {
                        setDoc(docSettings, { users: ['Gestore'], paymentRequests: {} });
                    }
                });
                return () => { unsubOrders(); unsubSettings(); };
            }, [firebaseUser]);

            // --- CALCULATIONS ---
            const isManager = currentUser === 'Gestore';

            const userStats = useMemo(() => {
                if (!currentUser || isManager) return null;
                const myItems = orders.flatMap(o => (o.items || []).map(i => ({...i, date: o.date, orderTitle: o.title})))
                                    .filter(i => i.person === currentUser);
                const totalItems = myItems.length;
                const pendingItems = myItems.filter(i => !i.paid).length;
                return { totalItems, pendingItems, myItems };
            }, [orders, currentUser, isManager]);

            const managerStats = useMemo(() => {
                if (!isManager) return null;
                let totalCredits = 0;
                let totalCollected = 0;
                orders.forEach(order => {
                    (order.items || []).forEach(item => {
                        const price = parseFloat(item.price) || 0;
                        if (item.paid) totalCollected += price;
                        else totalCredits += price;
                    });
                });
                return { totalCredits, totalCollected };
            }, [orders, isManager]);

            const shoppingList = useMemo(() => {
                const allItems = orders.flatMap(order => 
                    (order.items || []).map(item => ({ ...item, orderId: order.id, orderTitle: order.title }))
                );
                const grouped = {};
                allItems.forEach(item => {
                    const key = item.link ? item.link.trim() : `nolink-${item.id}`;
                    if (!grouped[key]) grouped[key] = { link: item.link, count: 0, items: [], allBought: true };
                    grouped[key].count += 1;
                    grouped[key].items.push(item);
                    if (!item.bought) grouped[key].allBought = false;
                });
                return Object.values(grouped).sort((a, b) => {
                    if (a.allBought === b.allBought) return 0;
                    return a.allBought ? 1 : -1; 
                });
            }, [orders]);

            const logisticsData = useMemo(() => {
                const data = {};
                users.forEach(u => {
                    if (u === 'Gestore') return;
                    data[u] = { items: [], totalDebt: 0, totalPaid: 0 };
                });
                orders.forEach(order => {
                    (order.items || []).forEach(item => {
                        if (data[item.person]) {
                            data[item.person].items.push({ ...item, orderDate: order.date, orderTitle: order.title, orderId: order.id });
                            const price = parseFloat(item.price) || 0;
                            if (item.paid) data[item.person].totalPaid += price;
                            else data[item.person].totalDebt += price;
                        }
                    });
                });
                return data;
            }, [orders, users]);

            // --- ACTIONS ---
            const initiateLogin = (user) => {
                if (user === 'Gestore') {
                    setIsLoggingInAsManager(true); setManagerPassword(''); setLoginError('');
                } else {
                    setCurrentUser(user); setView('dashboard');
                }
            };

            const submitManagerLogin = (e) => {
                e.preventDefault();
                if (managerPassword === '1234') {
                    setCurrentUser('Gestore'); setView('dashboard'); setIsLoggingInAsManager(false);
                } else {
                    setLoginError('Password errata'); setManagerPassword('');
                }
            };

            const addUser = async (e) => {
                e.preventDefault();
                const name = newUserName.trim();
                if(name && !users.includes(name)) {
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { users: arrayUnion(name) });
                    setNewUserName(''); setIsAddingUser(false);
                }
            };

            // FUNZIONE AGGIORNATA PER ELIMINARE UTENTI (ROBUSTA)
            const deleteUser = async (userToDelete) => {
                if (userToDelete === 'Gestore') return alert("Impossibile eliminare il Gestore.");
                
                // Conferma
                if (!confirm(`Vuoi eliminare l'utente "${userToDelete}"?`)) return;

                // Calcolo la nuova lista utenti filtrando quello da eliminare
                const newUsersList = users.filter(u => u !== userToDelete);

                try {
                    // Aggiorno il documento con la nuova lista completa
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { 
                        users: newUsersList 
                    });
                } catch (error) {
                    alert("Errore eliminazione: " + error.message);
                }
            };

            const createOrder = async () => {
                const dateStr = new Date().toLocaleDateString('it-IT');
                const newId = Date.now().toString();
                setActiveOrderId(newId);
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', newId), {
                    id: newId, title: `Ordine del ${dateStr}`, date: dateStr, items: [], status: 'active' 
                });
            };

            const updateOrderItems = async (orderId, newItems) => {
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', orderId.toString()), { items: newItems });
            };

            const addItemToOrder = async (orderId, item) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, [...(order.items || []), { ...item, id: Date.now(), paid: false, bought: false }]);
            };

            const removeItemFromOrder = async (orderId, itemId) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.filter(i => i.id !== itemId));
            };

            const updateItemPrice = async (orderId, itemId, newPrice) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.map(item => item.id === itemId ? { ...item, price: parseFloat(newPrice) || 0 } : item));
            };

            const togglePaidStatus = async (orderId, itemId) => {
                if (!isManager) return; 
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.map(item => item.id === itemId ? { ...item, paid: !item.paid } : item));
            };

            const toggleBoughtStatus = async (orderId, itemId) => {
                const order = orders.find(o => o.id == orderId);
                if (!order) return;
                await updateOrderItems(orderId, order.items.map(item => item.id === itemId ? { ...item, bought: !item.bought } : item));
            };

            const deleteOrder = async (orderId) => {
                if (confirm('Sei sicuro di voler eliminare DEFINITIVAMENTE questo ordine?')) {
                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', orderId.toString()));
                    setActiveOrderId(null);
                }
            };

            const resetOrder = async (orderId) => {
                if (confirm('Vuoi svuotare tutti gli articoli di questo ordine?')) {
                    await updateOrderItems(orderId, []);
                }
            }

            // RESET TOTALE DELL'APP (SOLO MANAGER)
            const factoryReset = async () => {
                if (!isManager) return;
                const confirmation = prompt("SCRIVI 'CANCELLA' per confermare il reset totale. Questa azione eliminerà TUTTI gli ordini e resetterà gli utenti.");
                if (confirmation === 'CANCELLA') {
                    try {
                        const ordersSnapshot = await getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'orders'));
                        const batch = writeBatch(db);
                        ordersSnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();

                        await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { users: ['Gestore'], paymentRequests: {} });
                        
                        alert("Reset completato. L'app è tornata allo stato iniziale.");
                        window.location.reload();
                    } catch (e) {
                        alert("Errore durante il reset: " + e.message);
                    }
                }
            };

            const togglePaymentRequest = async (user) => {
                const newRequests = { ...paymentRequests, [user]: !paymentRequests[user] };
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'global'), { paymentRequests: newRequests });
            };

            const downloadExcel = () => {
                const data = [];
                orders.forEach(o => {
                    (o.items || []).forEach(i => {
                        data.push({
                            "ID Ordine": o.id,
                            "Data": o.date,
                            "Titolo Ordine": o.title,
                            "Utente": i.person,
                            "Articolo": i.link ? i.link : i.otherItems,
                            "Specifiche": `${i.liquidMl || '-'}ml | ${i.nicotineMl || '-'}nic | ${i.vapeType || '-'}`,
                            "Prezzo": i.price || 0,
                            "Pagato": i.paid ? "SI" : "NO",
                            "Acquistato": i.bought ? "SI" : "NO"
                        });
                    });
                });

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Riepilogo Svapo");
                XLSX.writeFile(wb, "svapo_manager_report.xlsx");
            };

            // --- UI ---
            if (!isConfigured) return <div className="p-10 text-center">Configurazione mancante</div>;
            if (connectionError) return <div className="p-10 text-center text-red-500">Errore: {connectionError}</div>;
            if (!firebaseUser) return <div className="min-h-screen flex items-center justify-center text-slate-400 bg-slate-50 dark:bg-slate-950 animate-pulse">Connessione Cloud...</div>;

            if (!currentUser) return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-slate-800 w-full max-w-md rounded-3xl p-8 shadow-2xl animate-in">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 dark:bg-blue-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 dark:text-blue-400"><CloudLightning size={32} /></div>
                            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Svapo Manager</h1>
                            <p className="text-slate-500 dark:text-slate-400 text-sm">Cloud Edition</p>
                        </div>
                        {isLoggingInAsManager ? (
                            <div className="animate-in">
                                <button onClick={() => setIsLoggingInAsManager(false)} className="flex items-center gap-1 text-slate-400 mb-4 text-sm font-bold"><ArrowLeft size={16} /> Indietro</button>
                                <form onSubmit={submitManagerLogin} className="space-y-4">
                                    <input autoFocus type="password" placeholder="Password (1234)" className="w-full p-4 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-xl text-center text-xl tracking-widest outline-none focus:ring-2 focus:ring-blue-500" value={managerPassword} onChange={e => setManagerPassword(e.target.value)} />
                                    {loginError && <p className="text-red-500 text-sm text-center font-bold">{loginError}</p>}
                                    <button type="submit" className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">Accedi</button>
                                </form>
                            </div>
                        ) : (
                            <>
                                <div className="grid grid-cols-2 gap-3 mb-6">
                                    {users.map(u => (
                                        <div key={u} className="relative group">
                                            {/* Pulsante Principale - Accesso */}
                                            <button onClick={() => initiateLogin(u)} className="w-full relative p-4 rounded-xl border-2 border-slate-100 dark:border-slate-700 hover:border-blue-500 dark:hover:border-blue-500 transition-all font-medium text-slate-700 dark:text-slate-200 flex flex-col items-center gap-2">
                                                <div className="w-10 h-10 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center font-bold">{u.charAt(0)}</div>
                                                {u}
                                                {u === 'Gestore' && <Lock size={12} className="absolute top-2 right-2 text-slate-400" />}
                                            </button>
                                            
                                            {/* Pulsante Eliminazione - Sempre visibile e sopraelevato */}
                                            {u !== 'Gestore' && (
                                                <button 
                                                    onClick={(e) => { 
                                                        e.stopPropagation(); 
                                                        deleteUser(u); 
                                                    }}
                                                    className="absolute -top-2 -right-2 w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-full shadow-lg border-2 border-white dark:border-slate-800 z-50 hover:bg-red-600 transition-transform active:scale-90"
                                                    aria-label="Elimina utente"
                                                >
                                                    <X size={16} />
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                    <button onClick={() => setIsAddingUser(true)} className="p-4 rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 text-slate-400 flex flex-col items-center gap-2 justify-center"><Plus size={24} /> <span className="text-sm">Nuovo</span></button>
                                </div>
                                {isAddingUser && (
                                    <form onSubmit={addUser} className="flex gap-2 animate-in"><input autoFocus type="text" placeholder="Nome..." className="flex-1 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-xl px-4 py-3 outline-none" value={newUserName} onChange={e => setNewUserName(e.target.value)} /><button type="submit" className="bg-blue-600 text-white p-3 rounded-xl font-bold">Ok</button></form>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 font-sans pb-24 md:pb-0">
                    <div className="max-w-4xl mx-auto min-h-screen bg-white dark:bg-slate-900 shadow-xl flex flex-col border-x border-slate-100 dark:border-slate-800 relative">
                        <header className="p-4 md:p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between sticky top-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur z-20">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg">{currentUser.charAt(0)}</div>
                                <div><p className="text-xs text-slate-400 uppercase font-bold">Benvenuto</p><h1 className="text-lg font-bold text-slate-900 dark:text-white leading-none">{currentUser}</h1></div>
                            </div>
                            <div className="flex items-center gap-2">
                                {!activeOrderId && (
                                    <div className="hidden md:flex items-center gap-1 bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                                        <NavButtonDesktop icon={User} label="Profilo" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                                        {!isManager && <NavButtonDesktop icon={ShoppingBag} label="Ordini" active={view === 'orders'} onClick={() => setView('orders')} />}
                                        {isManager && <NavButtonDesktop icon={ShoppingCart} label="Spesa" active={view === 'shopping'} onClick={() => setView('shopping')} />}
                                        {isManager && <NavButtonDesktop icon={FileSpreadsheet} label="Logistica" active={view === 'logistics'} onClick={() => setView('logistics')} />}
                                    </div>
                                )}
                                <button onClick={() => setCurrentUser(null)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:text-red-500"><LogOut size={18} /></button>
                            </div>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4">
                            {view === 'dashboard' && (
                                <div className="space-y-6 animate-in">
                                    {/* SEZIONE TEMA */}
                                    <div className="bg-white dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-2xl flex justify-between items-center shadow-sm">
                                        <div className="flex items-center gap-3">
                                            <div className="p-2 bg-slate-100 dark:bg-slate-700 rounded-full">{theme === 'dark' ? <Moon size={20}/> : (theme === 'light' ? <Sun size={20}/> : <Monitor size={20}/>)}</div>
                                            <div><h3 className="font-bold">Tema</h3><p className="text-xs text-slate-400">Attuale: {theme === 'auto' ? 'Automatico' : (theme === 'dark' ? 'Scuro' : 'Chiaro')}</p></div>
                                        </div>
                                        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                            {['light', 'auto', 'dark'].map(t => (
                                                <button key={t} onClick={() => setTheme(t)} className={`p-2 rounded-md ${theme === t ? 'bg-white dark:bg-slate-600 shadow-sm text-blue-600 dark:text-blue-400' : 'text-slate-400'}`}>
                                                    {t === 'light' && <Sun size={16} />}
                                                    {t === 'auto' && <Monitor size={16} />}
                                                    {t === 'dark' && <Moon size={16} />}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {isManager ? (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-5 rounded-2xl text-white shadow-lg">
                                                    <div className="flex justify-between mb-4"><ArrowUpRight className="opacity-80" /><span className="text-xs bg-white/20 px-2 py-1 rounded-lg">Crediti</span></div>
                                                    <p className="text-sm opacity-80">Devono darti</p><p className="text-3xl font-bold">€{managerStats.totalCredits.toFixed(2)}</p>
                                                </div>
                                                <div className="bg-white dark:bg-slate-800 border dark:border-slate-700 p-5 rounded-2xl">
                                                    <div className="flex justify-between mb-4 text-slate-400"><PiggyBank /><span className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-lg text-slate-500 dark:text-slate-300 font-bold">Totale</span></div>
                                                    <p className="text-sm text-slate-400">Incassati</p><p className="text-3xl font-bold text-slate-800 dark:text-white">€{managerStats.totalCollected.toFixed(2)}</p>
                                                </div>
                                            </div>
                                            <div className="bg-slate-100 dark:bg-slate-800 rounded-2xl p-6 text-center">
                                                <p className="text-slate-500 dark:text-slate-400 text-sm mb-4">Gestisci gli ordini e i pagamenti dalla sezione Logistica.</p>
                                                <button onClick={() => setView('logistics')} className="bg-slate-800 dark:bg-slate-700 text-white px-6 py-3 rounded-xl font-bold text-sm hover:bg-slate-700">Vai alla Logistica</button>
                                            </div>

                                            {/* RESET APP BUTTON */}
                                            <div className="border-t dark:border-slate-800 pt-6">
                                                <button onClick={factoryReset} className="w-full flex items-center justify-center gap-2 text-red-500 bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 p-4 rounded-xl font-bold hover:bg-red-100 transition-colors">
                                                    <AlertTriangle size={20} /> RESET APPLICAZIONE
                                                </button>
                                                <p className="text-center text-[10px] text-red-300 mt-2">Cancella tutti i dati e gli ordini.</p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-gradient-to-br from-indigo-500 to-blue-600 p-5 rounded-2xl text-white shadow-lg">
                                                    <div className="flex justify-between mb-4"><List className="opacity-80" /><span className="text-xs bg-white/20 px-2 py-1 rounded-lg">Totale</span></div>
                                                    <p className="text-sm opacity-80">Articoli</p><p className="text-3xl font-bold">{userStats.totalItems}</p>
                                                </div>
                                                <div className={`p-5 rounded-2xl border-2 ${userStats.pendingItems > 0 ? 'bg-orange-50 dark:bg-orange-900/10 border-orange-100 dark:border-orange-900/30 text-orange-700 dark:text-orange-400' : 'bg-emerald-50 dark:bg-emerald-900/10 border-emerald-100 dark:border-emerald-900/30 text-emerald-700 dark:text-emerald-400'}`}>
                                                    <div className="flex justify-between mb-4"><CheckSquare /><span className="text-xs font-bold uppercase px-2 py-1 rounded-lg bg-white/50 dark:bg-black/20">Stato</span></div>
                                                    <p className="text-sm opacity-80">Da Saldare</p><p className="text-3xl font-bold">{userStats.pendingItems}</p>
                                                </div>
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2"><History size={18} className="text-indigo-500"/> I tuoi acquisti</h3>
                                                <div className="space-y-3">
                                                    {userStats.myItems.length === 0 && <p className="text-slate-400 text-sm italic">Non hai ancora comprato nulla.</p>}
                                                    {userStats.myItems.slice().reverse().map((item, idx) => ( 
                                                        <div key={idx} className="bg-white dark:bg-slate-800 border dark:border-slate-700 p-3 rounded-xl flex justify-between items-center shadow-sm">
                                                            <div className="overflow-hidden mr-2">
                                                                <p className="font-bold text-slate-800 dark:text-white truncate">{item.link || 'Oggetto senza link'}</p>
                                                                <p className="text-xs text-slate-500 dark:text-slate-400">{item.date}</p>
                                                            </div>
                                                            <div className="text-right flex-shrink-0">
                                                                <p className={`text-[10px] font-bold uppercase tracking-wider ${item.paid ? 'text-emerald-500' : 'text-orange-400'}`}>{item.paid ? 'Saldato' : 'Da Saldare'}</p>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {view === 'orders' && !isManager && (
                                <div className="space-y-4 animate-in">
                                    {!activeOrderId ? (
                                        <>
                                            <div className="flex justify-between items-center mb-2">
                                                <h2 className="text-xl font-bold text-slate-800 dark:text-white">Ordini Gruppo</h2>
                                                <button onClick={createOrder} className="bg-slate-900 dark:bg-white dark:text-slate-900 text-white py-2 px-4 rounded-xl flex items-center gap-2 text-sm font-bold"><Plus size={18} /> NUOVO</button>
                                            </div>
                                            <div className="flex items-center gap-2 text-xs text-slate-400 mb-2 px-1">
                                                <MoreHorizontal size={14} /> <span>Scorri a sinistra per opzioni</span>
                                            </div>
                                            <div className="space-y-3">
                                                {orders.length === 0 && <p className="text-center text-slate-400 py-10">Nessun ordine attivo.</p>}
                                                {orders.map(order => (
                                                    <SwipeableOrder 
                                                        key={order.id} 
                                                        order={order} 
                                                        currentUser={currentUser}
                                                        onClick={(id) => setActiveOrderId(id)}
                                                        onDelete={deleteOrder}
                                                        onReset={resetOrder}
                                                        isManager={isManager}
                                                    />
                                                ))}
                                            </div>
                                        </>
                                    ) : (
                                        <OrderDetail order={orders.find(o => o.id == activeOrderId)} users={users} currentUser={currentUser} isManager={isManager} onBack={() => setActiveOrderId(null)} onAdd={addItemToOrder} onRemove={removeItemFromOrder} onDelete={deleteOrder} />
                                    )}
                                </div>
                            )}

                            {view === 'shopping' && isManager && (
                                <div className="animate-in space-y-6">
                                    <div className="bg-emerald-600 text-white p-6 rounded-3xl shadow-xl"><h2 className="text-3xl font-bold flex items-center gap-2"><ShoppingCart /> Lista Spesa</h2><p className="text-emerald-100 text-sm mt-1">{shoppingList.filter(g => !g.allBought).length} prodotti da acquistare</p></div>
                                    <div className="space-y-4">
                                        {shoppingList.map((group, idx) => (
                                            <div key={idx} className={`bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl p-4 shadow-sm ${group.allBought ? 'opacity-60' : 'border-emerald-100 dark:border-emerald-900/30 ring-1 ring-emerald-50 dark:ring-emerald-900/10'}`}>
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="w-full overflow-hidden">
                                                        <h3 className="font-bold text-lg truncate text-slate-800 dark:text-white">{group.count}x {group.link ? 'Prodotto' : 'Oggetto'}</h3>
                                                        {group.link && <a href={group.link} target="_blank" className="flex items-center gap-1 text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-2 py-1.5 rounded-lg font-bold w-fit mt-1 truncate"><ExternalLink size={12} /> {group.link}</a>}
                                                    </div>
                                                </div>
                                                <div className="space-y-2">
                                                    {group.items.map(item => (
                                                        <div key={item.id} className="flex flex-col bg-slate-50 dark:bg-slate-700/50 p-2 rounded-lg text-sm border dark:border-slate-600">
                                                            <div className="flex justify-between items-center mb-1">
                                                                <span className="font-semibold text-slate-700 dark:text-slate-200">{item.person} <span className="text-xs font-normal text-slate-500 dark:text-slate-400">{item.liquidMl}ml • {item.nicotineMl}</span></span>
                                                                <button onClick={() => toggleBoughtStatus(item.orderId, item.id)} className="flex items-center gap-2 px-3 py-1 bg-white dark:bg-slate-700 border dark:border-slate-600 rounded-lg text-xs font-bold dark:text-white">{item.bought ? <CheckSquare size={14}/> : <Square size={14}/>} {item.bought ? 'PRESO' : 'DA PRENDERE'}</button>
                                                            </div>
                                                            {item.otherItems && <div className="text-xs text-orange-500 flex gap-1"><ShoppingBasket size={12}/> {item.otherItems}</div>}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {view === 'logistics' && isManager && (
                                <div className="animate-in space-y-6">
                                    <div className="bg-slate-900 dark:bg-black text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                                        <div className="relative z-10 flex justify-between items-start">
                                            <div><p className="text-slate-400 text-sm font-medium uppercase tracking-wider mb-1">Totale Crediti</p><h2 className="text-4xl font-bold text-emerald-400">€{managerStats.totalCredits.toFixed(2)}</h2></div>
                                            <button onClick={downloadExcel} className="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-emerald-900/50 hover:bg-emerald-500 transition"><FileSpreadsheet size={16} /> Excel (.xlsx)</button>
                                        </div>
                                    </div>
                                    <div className="space-y-6">
                                        {Object.entries(logisticsData).sort(([,a], [,b]) => b.totalDebt - a.totalDebt).map(([name, data]) => (
                                            <div key={name} className="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl shadow-sm overflow-hidden">
                                                <div className="bg-slate-50 dark:bg-slate-900/50 p-4 border-b dark:border-slate-700 flex justify-between items-center">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 bg-white dark:bg-slate-700 border dark:border-slate-600 rounded-full flex items-center justify-center font-bold text-slate-600 dark:text-slate-200">{name.charAt(0)}</div>
                                                        <div><h3 className="font-bold text-slate-800 dark:text-white">{name}</h3><p className="text-xs text-slate-400">{data.items.length} articoli</p></div>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className={`font-mono font-bold text-lg ${data.totalDebt > 0 ? 'text-red-500' : 'text-emerald-500'}`}>{data.totalDebt > 0 ? `-€${data.totalDebt.toFixed(2)}` : '€0.00'}</p>
                                                        <div className="flex gap-1 justify-end mt-1">
                                                            <button onClick={() => togglePaymentRequest(name)} className={`p-1.5 rounded-full transition ${paymentRequests[name] ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400' : 'bg-slate-100 dark:bg-slate-700 text-slate-400'}`}><Bell size={14} /></button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="divide-y dark:divide-slate-700">
                                                    {data.items.map(item => (
                                                        <div key={item.id} className="p-3 text-sm flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                                            <div className="overflow-hidden pr-2">
                                                                <p className="font-medium truncate text-slate-800 dark:text-slate-200">{item.link || item.otherItems}</p>
                                                                <p className="text-[10px] text-slate-400">{item.orderTitle} • {item.orderDate}</p>
                                                            </div>
                                                            <div className="flex items-center gap-2 shrink-0">
                                                                <input type="number" step="0.01" className="w-16 bg-white dark:bg-slate-900 border dark:border-slate-600 rounded px-1 py-0.5 text-right font-mono text-slate-800 dark:text-white" value={item.price} onChange={(e) => updateItemPrice(item.orderId, item.id, e.target.value)} />
                                                                <button onClick={() => togglePaidStatus(item.orderId, item.id)} className={`p-1 rounded-full border ${item.paid ? 'bg-emerald-500 text-white border-emerald-500' : 'text-slate-300 dark:text-slate-600'}`}><Check size={12} /></button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </main>

                        {!activeOrderId && (
                            <nav className="bg-white dark:bg-slate-900 border-t dark:border-slate-800 p-2 md:hidden fixed bottom-0 left-0 right-0 z-30 pb-safe flex justify-center gap-8">
                                <NavButton icon={User} label="Profilo" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                                {!isManager && <NavButton icon={ShoppingBag} label="Ordini" active={view === 'orders'} onClick={() => setView('orders')} />}
                                {isManager && <NavButton icon={ShoppingCart} label="Spesa" active={view === 'shopping'} onClick={() => setView('shopping')} />}
                                {isManager && <NavButton icon={FileSpreadsheet} label="Logistica" active={view === 'logistics'} onClick={() => setView('logistics')} />}
                            </nav>
                        )}
                    </div>
                </div>
            );
        };

        const NavButton = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1 w-16 transition-colors ${active ? 'text-blue-600 dark:text-blue-400' : 'text-slate-400 dark:text-slate-500'}`}>
                <Icon size={22} className={active ? "fill-blue-100 dark:fill-blue-900" : ""} /><span className="text-[10px] font-medium">{label}</span>
            </button>
        );

        const NavButtonDesktop = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors font-medium text-sm ${active ? 'bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800'}`}>
                <Icon size={18} /><span>{label}</span>
            </button>
        );

        const OrderDetail = ({ order, users, currentUser, isManager, onBack, onAdd, onRemove, onDelete }) => {
            if (!order) return (
                 <div className="pb-20 animate-in p-4">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400"><ArrowLeft /></button>
                    </div>
                    <div className="p-10 text-center text-slate-400">Caricamento in corso...</div>
                </div>
            );

            const [person, setPerson] = useState(currentUser || users[0]);
            const [link, setLink] = useState('');
            const [liquidMl, setLiquidMl] = useState('');
            const [nicotineMl, setNicotineMl] = useState('');
            const [vapeType, setVapeType] = useState('Guanciale');
            const [otherItems, setOtherItems] = useState('');
            
            const visibleItems = isManager ? (order.items || []) : (order.items || []).filter(i => i.person === currentUser);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!link.trim() && !otherItems.trim()) return alert("Inserisci un link o altro acquisto.");
                onAdd(order.id, { person, link, aroma: '', liquidMl, nicotineMl, vapeType, otherItems, price: 0 });
                setLink(''); setLiquidMl(''); setNicotineMl(''); setOtherItems('');
            };

            const itemsByPerson = isManager 
                ? (order.items || []).reduce((acc, item) => { if(!acc[item.person]) acc[item.person] = []; acc[item.person].push(item); return acc; }, {}) 
                : { [currentUser]: visibleItems };

            return (
                <div className="pb-20 animate-in">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={onBack} className="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400"><ArrowLeft /></button>
                    </div>
                    <div className="bg-slate-800 dark:bg-black text-white p-5 rounded-2xl shadow-lg mb-6"><h2 className="text-xl font-bold">{order.title}</h2><p className="text-slate-400 text-sm mt-1">{order.date}</p></div>
                    
                    <div className="bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-2xl mb-8">
                        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Chi</label>
                                <select className="w-full px-3 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl" value={person} onChange={e => setPerson(e.target.value)} disabled={!isManager}>{users.map(u => <option key={u} value={u}>{u}</option>)}</select>
                            </div>
                            <div className="space-y-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Link</label>
                                <input type="url" placeholder="Incolla Link..." className="w-full px-4 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl text-sm" value={link} onChange={e => setLink(e.target.value)} />
                            </div>
                            <div className="space-y-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Specifiche</label>
                                <div className="flex gap-2"><div className="relative flex-1"><input type="text" placeholder="ml Liq" className="w-full px-3 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl" value={liquidMl} onChange={e => setLiquidMl(e.target.value)} /></div><div className="relative flex-1"><input type="text" placeholder="Nicotina" className="w-full px-3 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl" value={nicotineMl} onChange={e => setNicotineMl(e.target.value)} /></div></div>
                                <div className="flex bg-white dark:bg-slate-700 rounded-xl border dark:border-slate-600 p-1">{['Guanciale', 'Polmonare'].map(t => <button key={t} type="button" onClick={() => setVapeType(t)} className={`flex-1 rounded-lg text-xs font-medium py-2 ${vapeType === t ? 'bg-slate-800 text-white' : 'text-slate-500 dark:text-slate-400'}`}>{t}</button>)}</div>
                            </div>
                            <div className="space-y-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Altro</label><textarea rows="2" placeholder="Es. Cotone..." className="w-full px-4 py-2.5 bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 rounded-xl text-sm" value={otherItems} onChange={e => setOtherItems(e.target.value)} /></div>
                            <button type="submit" className="bg-blue-600 text-white px-6 py-3 rounded-xl shadow-lg font-bold gap-2 mt-2 flex justify-center items-center"><Plus size={20} /> AGGIUNGI</button>
                        </form>
                    </div>

                    <div className="space-y-4">
                        {Object.entries(itemsByPerson).map(([pName, pItems]) => (
                            <div key={pName} className="border-b dark:border-slate-800 pb-4 last:border-0">
                                {isManager && (
                                    <div className="flex justify-between items-center mb-2 px-1">
                                        <h3 className="font-bold text-slate-700 dark:text-slate-300">{pName}</h3>
                                    </div>
                                )}
                                <div className="space-y-2">
                                    {pItems.slice().reverse().map((item) => (
                                        <div key={item.id} className="p-4 rounded-xl border dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-800">
                                            <div className="flex items-center gap-3 overflow-hidden">
                                                <div className="min-w-0">
                                                    {item.link ? <a href={item.link} target="_blank" className="font-bold text-blue-600 dark:text-blue-400 truncate block flex items-center gap-1"><LinkIcon size={12} /> Link Prodotto</a> : <p className="font-bold text-slate-800 dark:text-white">Oggetto manuale</p>}
                                                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-0.5">{item.liquidMl}ml • {item.nicotineMl}nic • {item.vapeType}</p>
                                                    {item.otherItems && <p className="text-xs text-orange-500 font-medium mt-1"><ShoppingBasket size={10} inline /> {item.otherItems}</p>}
                                                </div>
                                            </div>
                                            {(isManager || item.person === currentUser) && <button onClick={() => onRemove(order.id, item.id)} className="text-slate-300 hover:text-red-500"><X size={18} /></button>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<OrderManager />);
    </script>
</body>
</html>
